<?xml version="1.0" encoding="utf-8"?>
<OneStreamXF version="9.0.1.17403">
    <applicationWorkspacesRoot>
        <workspaces>
            <workspace name="40 CMD TGT" description="" notes="" accessGroup="Everyone" maintenanceGroup="Everyone" isShareableWorkspace="true" sharedWorkspaceNames="00 GBL" companyName="" versionNum="" author="" namespacePrefix="CMD_TGT" importsNamespace1="" importsNamespace2="" importsNamespace3="" importsNamespace4="" importsNamespace5="" importsNamespace6="" importsNamespace7="" importsNamespace8="" wsAssemblyService="CMD_TGT_Assembly.CMD_TGT_Svc_Factory" text1="" text2="" text3="" text4="" text5="" text6="" text7="" text8="">
                <WorkspaceDefinition>
                    <SubstitutionVariableItems />
                </WorkspaceDefinition>
                <maintenanceUnits>
                    <maintenanceUnit name="CMD TGT GBL" description="" uiPlatformType="WpfOrSilverlight" accessGroup="Everyone" maintenanceGroup="Everyone" wsAssemblyService="CMD_TGT_Assembly.CMD_TGT_Svc_Factory">
                        <fileResources />
                        <stringResources />
                        <parameters />
                        <adapters />
                        <components />
                        <dashboardGroups />
                        <workspaceAssemblies>
                            <workspaceAssembly name="CMD_TGT_Assembly" description="" compilerLanguage="VisualBasic">
                                <dependencies>
                                    <dependency dependencyType="WsAssembly" sharedWorkspaceName="GBL" dependencyName="GBL_Assembly" />
                                    <dependency dependencyType="BusinessRule" sharedWorkspaceName="" dependencyName="Global_Buffers" />
                                    <dependency dependencyType="BusinessRule" sharedWorkspaceName="" dependencyName="Global_Functions" />
                                </dependencies>
                                <files>
                                    <folder name="DB DataSets">
                                        <file name="CMD_TGT_DataSet.vb" fileType="VisualBasic" businessRuleType="DashboardDataSet" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800

'TGT_DataSet
Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardDataSet.CMD_TGT_DataSet
Public Class MainClass
	Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardDataSetArgs) As Object
			Try
				Select Case args.FunctionType
					Case Is = DashboardDataSetFunctionType.GetDataSet

#Region "Security Logic: Get User Fund Centers By Workflow"						
						If args.DataSetName.XFEqualsIgnoreCase("GetUserFundCentersByWF") Then
'BRApi.ErrorLog.LogMessage(si, "HERE")
							Return Me.GetUserFundCentersByWF(si,globals,api,args)		
						End If						
#End Region	

				End Select
				Return Nothing
			Catch ex As Exception
'brapi.errorlog.LogMessage(si,"DataSetName = " & args.DataSetName)
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
#Region "Constants"
	'Private BR_GeneralMemberLists As New OneStream.BusinessRule.Finance.General_Member_Lists.MainClass
#End Region
		
#Region "Security Logic: Get User Fund Centers By Workflow"
'New logic to pull user groups then pass group and FC into case statment for FC dropdown. Added logic to remove duplicate FC for the Review step and CMD certify step
		Public Function GetUserFundCentersByWF(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardDataSetArgs) As Object
			Try
'Dim st As DateTime = DateTime.Now				
'Brapi.ErrorLog.LogMessage(si,"In Fund Center Rule")
				Dim fcDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_Army")
				Dim dt As DataTable = Me.CreateNameValuePairTable(si, "FundCentersByWF")
				Dim wfProfile As WorkflowProfileInfo = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey)
				Dim accessGroupInfo As GroupInfoEx = BRApi.Security.Admin.GetGroupInfoEx(si,wfProfile.AccessGroupUniqueID)
				Dim accessGroupInfo_Split As List(Of String) = StringHelper.SplitString(accessGroupInfo.GroupInfo.Group.Name, "_", StageConstants.ParserDefaults.DefaultQuoteCharacter)
				Dim wfProfileAccessGroup As String = accessGroupInfo.GroupInfo.Group.Name
'				Dim WFManager As String  = wfProfileAccessGroup.Replace(right(wfProfileAccessGroup,2),"MG")
				Dim wfProfileStep As String = accessGroupInfo_Split(accessGroupInfo_Split.Count-1)
				Dim mode As String = args.NameValuePairs.XFGetValue("mode","")
				'If wfProfileStep = "WF"
				'	wfProfileAccessGroup = StringHelper.ReplaceString(wfProfileAccessGroup,"_WF",String.Empty,True)
				'End If						
				'Get WF profile cube
				Dim cmd As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
				'Get WF profile name
				Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name	
				If wfProfileName.XFContainsIgnoreCase("CMD")
					mode = "ParentOnly"
				Else
					mode = "AllChildren"
				End If
'Brapi.ErrorLog.LogMessage(si,"WFCube" & cmd)
'Brapi.ErrorLog.LogMessage(si,"WFProfileName" & wfProfileName)
'Brapi.ErrorLog.LogMessage(si,"Mode" & mode)

				Dim sFCgroups As String = ""
				'Get fund centers from the user profile. Get groups user belongs to and substring FC from them
				'Dim objSignedOnUser As UserInfo = BRApi.Security.Authorization.GetUser(si, si.AuthToken.UserName)
				'Dim sUserName As String = objSignedOnUser.User.Name
				Dim sUserName As String = si.AuthToken.UserName
				Dim techSupport As Boolean = BRApi.Security.Authorization.IsUserInGroup(si,sUserName,"g_Technical_Support",False)
				Dim helpSupport As Boolean = BRApi.Security.Authorization.IsUserInGroup(si,sUserName,"g_Helpdesk_Support",False)
				Dim funcSupport As Boolean = BRApi.Security.Authorization.IsUserInGroup(si,sUserName,"g_Functional_Support",False)
				Dim admin As Boolean = BRApi.Security.Authorization.IsUserInGroup(si,sUserName,"Administrators",False)
				Dim SQL As String
				'BRAPI.ErrorLog.LogMessage(si,$"Support Roles: {sUserName} - {techSupport} - {funcSupport}")
				If (techSupport = False And funcSupport = False And helpSupport = False And admin = False)
					SQL = $"
						WITH RecursiveCTE AS (
							SELECT SG.UniqueID as GroupID, 
								SG.Name as AccessGroup,
								GRP2.GroupKey as ChildGroupID
							FROM SecUser as u
							JOIN SecGroupChild AS GRP1 on GRP1.ChildKey = u.uniqueid
							JOIN SecGroup AS SG on sg.UniqueID = GRP1.GroupKey
							JOIN SecGroupChild AS GRP2 on GRP2.ChildKey = GRP1.GroupKey
							WHERE U.Name = '{sUserName}'
							UNION ALL
							SELECT GRP.UniqueID as GroupID, 
								GRP.Name as AccessGroup,
								GRP2.GroupKey as ChildGroupID
							FROM SecGroup as GRP
							JOIN SecGroupChild AS GRP2 on GRP2.ChildKey = GRP.uniqueid
							INNER JOIN RecursiveCTE rcte ON rcte.ChildGroupID = GRP.UniqueID)
							SELECT Distinct AccessGroup
							FROM RecursiveCTE
							Where AccessGroup Like '{wfProfileAccessGroup}%'"
				Else
					SQL = $"
						SELECT SG.Name as AccessGroup
						FROM SecGroup as SG
						WHERE SG.Name like '{wfProfileAccessGroup}%'"
				End If
'brapi.ErrorLog.LogMessage(si, sql.ToString)
				Dim dtAll As New DataTable
				'Dim dtAll As DataTable = Me.CreateNameValuePairTable(si, "GroupSecList")
				Using dbConn As DbConnInfo = BRApi.Database.CreateFrameworkDbConnInfo(si)
					 dtAll = BRApi.Database.ExecuteSql(dbConn,SQL,True)
				End Using
			 
				For Each dataRow As DataRow In dtAll.Rows					
					Dim sGroup As String = dataRow.Item("AccessGroup")
					sFCgroups+=sGroup + ","
				Next
			
				If (String.IsNullOrWhiteSpace(sFCgroups)) Then
					Return Nothing
				Else 
				sFCgroups = sFCgroups.TrimEnd(","c)
				End If		

				Dim sGroupList As String() = sFCgroups.Split(",")
				Dim objDimDisplayOptions As New DimDisplayOptions()
				'filter fundcenters in the command only

				For Each Grp In sGroupList

					Dim Grp_Split As List(Of String) = StringHelper.SplitString(Grp, "_", StageConstants.ParserDefaults.DefaultQuoteCharacter)
					Dim fc_name As String = Grp_Split(Grp_Split.Count-1)

					Dim MbrExpansion As String = String.Empty
					
					
					Dim fcList As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si, "E_ARMY", $"E#{fc_name}{MbrExpansion}", True)
'BRApi.ErrorLog.LogMessage(si, $"fc_name = {fc_name}")					
					For Each fc In fcList
'BRApi.ErrorLog.LogMessage(si, $"fc = {fc.Member.Name}")	
						Dim bHasChildren = BRApi.Finance.Entity.HasChildren(si,fcDimPk,fc.Member.MemberId,objDimDisplayOptions)
						Select Case mode
						Case "ParentOnly"
							If bHasChildren Then
								Me.WriteNameValuePairRow(si, dt, fc.NameAndDescription, fc.Member.Name)
							End If
						Case "AllChildren"
							If bHasChildren Then
								Me.WriteNameValuePairRow(si, dt, fc.NameAndDescription, fc.Member.Name & "_General")
							Else
								Me.WriteNameValuePairRow(si, dt, fc.NameAndDescription, fc.Member.Name)							
							End If
						Case Else
							If bHasChildren Then
								Me.WriteNameValuePairRow(si, dt, fc.NameAndDescription, fc.Member.Name & "_General")
							End If
						End Select
					Next			
				Next	
'For Each row As DataRow In dt.Rows
'	BRApi.ErrorLog.LogMessage(si, $"Name = {row("Name")} || Value = {row("Value")}")
'Next	
				Dim sColumnlist As New List(Of String)

				For Each sColumn In dt.Columns
					sColumnlist.Add(sColumn.ColumnName)
				Next

			Return dt.defaultView.ToTable(True, sColumnlist.ToArray())
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
#End Region


#Region "Helper Functions"
		Private Function CreateNameValuePairTable(ByVal si As SessionInfo, ByVal dataTableName As String) As DataTable
			Try
				'Create the data table to return
				Dim dt As New DataTable(dataTableName)
				
				Dim objCol = New DataColumn
	            objCol.ColumnName = "Name"
	            objCol.DataType = GetType(String)
	            objCol.DefaultValue = ""
	            objCol.AllowDBNull = False
	            dt.Columns.Add(objCol)
				
				objCol = New DataColumn
				objCol.ColumnName = "Value"
				objCol.DataType = GetType(String)
	            objCol.DefaultValue = ""
	            objCol.AllowDBNull = False
	            dt.Columns.Add(objCol)
							
				Return dt
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function

		Private Sub WriteNameValuePairRow(ByVal si As SessionInfo, ByVal dt As DataTable, ByVal name As String, ByVal value As String)
			Try
	            'Create a new row and append it to the table
				Dim row As DataRow = dt.NewRow()

				row("Name") = name
				row("Value") = value

'Brapi.ErrorLog.LogMessage(si, $"Name = {Name} | Value = {Value}")				
                dt.Rows.Add(row)
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Sub		
#End Region


	End Class
End Namespace


]]></sourceCode>
                                        </file>
                                    </folder>
                                    <folder name="DB Extenders">
                                        <file name="CMD_TGT_Helper.vb" fileType="VisualBasic" businessRuleType="DashboardExtender" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports System.Text.RegularExpressions

'TGTDST_SolutionHelper

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardExtender.CMD_TGT_Helper
	Public Class MainClass
		
        Private si As SessionInfo
        Private globals As BRGlobals
        Private api As Object
        Private args As DashboardExtenderArgs
		
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As Object
            ' Assign to global variables
            Me.si = si
            Me.globals = globals
            Me.api = api
            Me.args = args
			
			Try
				Dim dbExt_ChangedResult As New XFSelectionChangedTaskResult()
				
								
				Select Case args.FunctionName.ToLower()
					Case "savelockstatus"
						Me.SaveLockStatus(si,args)
								Case "clearkey5param"
								dbExt_ChangedResult = Me.ClearKey5param()
								Return dbExt_ChangedResult
								
								Case "clearkey5params_nofcappn"
								dbExt_ChangedResult = Me.ClearKey5params_NoFCAPPN()
								Return dbExt_ChangedResult
								
							Case "setdeafultappnparam"
								dbExt_ChangedResult = Me.SetDeafultAPPNParam()
								Return dbExt_ChangedResult
				End Select	


#Region "EmailTargetDistributionUpdates"
						If args.FunctionName.XFEqualsIgnoreCase("EmailTargetDistributionUpdates") Then
							Return Me.EmailTargetDistributionUpdates(si, args)
						End If
#End Region 'Updated 09/16

#Region "PublishCPROBEToTarget" 
				If args.FunctionName.XFEqualsIgnoreCase("PublishCPROBEToTarget") Then
					dbExt_ChangedResult = Me.PublishCPROBEToTarget(si,globals,api,args)
					Return dbExt_ChangedResult
				End If
#End Region 'Updated 09/17
					
#Region "Validate Target"
						If args.FunctionName.XFEqualsIgnoreCase("ValidateTarget") Then
							Me.ValidateTarget(Si, globals, api,args)
						End If
#End Region	'Updated 09/17

#Region "Copy Target Build Withholds"
						If args.FunctionName.XFEqualsIgnoreCase("CopyTargetBuildWithholds") Then
							Me.CopyTargetBuildWithholds(si,globals,api,args)
							Return Nothing
						End If
#End Region

#Region "Get Fund Center Lock Status"
						If args.FunctionName.XFEqualsIgnoreCase("GetFCLockStatus") Then
							Me.GetFCLockStatus(si, args)
						End If
#End Region					
				
#Region "Get Fund Center Lock Status and Throw Message"
						If args.FunctionName.XFEqualsIgnoreCase("GetFCLockStatusAndThrowMsg") Then
							Me.GetFCLockStatusAndThrowMsg(si, args)
						End If
#End Region	

#Region "Target Build: Execute NonPay Calc"
'TARGET BUILD: Execute Calc_NonPay Data Management to calculate NonPay amounts
'USAGE: Target Build > NonPay Cost Modify > Calc NonPay Cost button
'NOTE: Work in conjunction with DST_MainCalc > Calc_NonPay method
						If args.FunctionName.XFEqualsIgnoreCase("ExecuteNonPayCalc") Then						
							Return Me.ExecuteNonPayCalc(si, args)
						End If
#End Region
								
				Return Nothing
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
		
#Region "Constants"
Private BR_TGTDataSet As New Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardDataSet.CMD_TGT_DataSet.MainClass
Public GBL_Helper As New Workspace.GBL.GBL_Assembly.BusinessRule.DashboardExtender.GBL_Helper.MainClass

#End Region		

'------------------------methods----------------------------	
#Region "SaveLockStatus"
		Public Sub SaveLockStatus(ByVal si As SessionInfo, ByVal args As DashboardExtenderArgs)
		'{TGTDST_SolutionHelper}{SaveLockStatus}{}
		'{TGTDST_SolutionHelper}{SaveLockStatus}{subCommandEntity=|!prompt_cbx_TGTDST_TGTADM_0CaAa_D_FundCenter__ManageAccessSubCMD!|}
			Dim wfCube = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
			Dim wfScenario = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
			Dim wfTime = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
			Dim wfProfile As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
			Dim entity As String = ""
			
			' Set entity source based on command/subcommand workflow
			If wfProfile.XFContainsIgnoreCase("Target Distribution.Administrative") Then
				entity = args.NameValuePairs.XFGetValue("subCommandEntity")
			Else If wfProfile.XFContainsIgnoreCase("Target Distribution CMD.Administrative CMD") Then
				Dim objDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
				entity = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk , $"E#{wfCube}.Descendants.Where(HasChildren = True).Where(Text3 Contains EntityLevel=L2)", True,,)(0).Member.Name
			Else
				Throw New Exception("Invalid path -- please contact support.")
			End If
			
			If String.IsNullOrWhiteSpace(entity) Then
				Throw New Exception("Please select a funds center.")
			End If
'Brapi.ErrorLog.LogMessage(si, "Entity" & Entity)
			' Get children for loop
			Dim dimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
			Dim memberId As Integer = BRApi.Finance.Members.GetMemberId(si, Dimtype.Entity.Id, entity)
			Dim children As List(Of Member) = BRApi.Finance.Members.GetChildren(si, dimPk, memberId)
			
			' Declare loop variables
			Dim entityMemberName As String = ""
			Dim annotationScript As String = ""
			Dim annotation As String = ""
			Dim lockScript As String = ""
			Dim locked As Decimal = 1
			Dim unlocked As Decimal = 0
			
			' Loop through children (that have parents)
			For Each entityMember In children
				' Remove non-base funds centers
				If Not BRApi.Finance.Members.HasChildren(si, dimPk, entityMember.memberId) Then
'Brapi.ErrorLog.LogMessage(si, "Entity" & entityMember.Name)
					Continue For
				End If
				
				' Assign variables for setting lock status
				entityMemberName = entityMember.Name
				annotationScript = "E#" & entityMemberName & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
				annotation = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, "ARMY", annotationScript).DataCellEx.DataCellAnnotation
				lockScript = "Cb#" & wfCube & ":E#" & entityMemberName & "_General:C#USD:S#" & wfScenario & ":T#" & wfTime & "M12:V#YTD:A#TGT_Target_Distribution_Complete_Ind:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
				
				' Set lock status
				Dim objListofScriptsAmount As New List(Of MemberScriptandValue)
				Dim objScriptValAmount As New MemberScriptAndValue
				objScriptValAmount.CubeName = wfCube
				objScriptValAmount.Script = lockScript
				If annotation = "Yes"
					objScriptValAmount.Amount = locked
				Else
					objScriptValAmount.Amount = unlocked
					Dim sBalanceStatusScriptchild As String = "Cb#" & wfCube & ":E#"& entityMemberName & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim sBalanceStatusScript As String = "Cb#" & wfCube & ":E#"& entity & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
'brapi.ErrorLog.LogMessage(si, "sBalanceStatusScript= " & sBalanceStatusScript)
					Dim sBalancevalue As String = ""
					
					Dim objListofScriptsBalance As New List(Of MemberScriptandValue)
	    			Dim objScriptBalanceList As New MemberScriptAndValue
					objScriptBalanceList.CubeName = wfCube
					objScriptBalanceList.Script = sBalanceStatusScript
					objScriptBalanceList.TextValue = sBalancevalue
					objScriptBalanceList.IsNoData = True
					objListofScriptsBalance.Add(objScriptBalanceList)
					BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofScriptsBalance)
					
					Dim objScriptBalancechild As New MemberScriptAndValue
					objScriptBalancechild.CubeName = wfCube
					objScriptBalancechild.Script = sBalanceStatusScriptchild
					objScriptBalancechild.TextValue = sBalancevalue
					objScriptBalancechild.IsNoData = True
					objListofScriptsBalance.Add(objScriptBalancechild)
					BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofScriptsBalance)

				End If
				objScriptValAmount.IsNoData = False
				objListofScriptsAmount.Add(objScriptValAmount)
				
				BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofScriptsAmount)
			Next
		End Sub
#End Region

#Region "EmailTargetDistributionUpdates"
		Private Function EmailTargetDistributionUpdates(ByVal si As SessionInfo, ByVal args As DashboardExtenderArgs) As XFSelectionChangedTaskResult
			' Initialize variables
			Dim wfCube As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
			Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
			
			' Define workflow entity as either L2 funds center (CMD) or parameter value (subCMD)
			Dim entityName As String
			If wfProfileName.XFContainsIgnoreCase("CMD") Then
				Dim memberScript As String = "E#" & wfCube & ".Descendants.Where(Text3 Contains EntityLevel=L2).Where(HasChildren = True)"
				Dim entityMemberList As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si, "E_" & wfCube, memberScript, True)
				Dim entityMember As MemberInfo = entityMemberList(0)
				entityName = entityMember.Member.Name
			Else
				entityName = args.NameValuePairs.XFGetValue("entity")
			End If
			
			' Add workflow entity and its children to the list of entities
			Dim entityChildren As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si, "E_" & wfCube, "E#" & entityName & ".Children.Where(Name DoesNotContain _)", True)
			Dim entityList As New List(Of String)
			entityList.Add(entityName)
			For Each entityMember In entityChildren
				entityList.Add(entityMember.Member.Name)
			Next
		
			Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
			' Connection to the mail server
			Dim emailConnectionName As String = BRApi.Dashboards.Parameters.GetLiteralParameterValue(si, False,gValue, "Var_Email_Connector_String")
			
			' Email content (Subject & Body)
			Dim subject As String = "RMW -- Targets have been updated"
			Dim messageBody As String = "Your reporting organization (" & entityName & ") has updated its target distribution"
			   
			' Get list of users
			Dim toEmail As New List(Of String)
			
			Dim allUsers As List(Of UserSummaryInfo) = BRApi.Security.Admin.GetUsers(si)
			For Each tempUser As UserSummaryInfo In allUsers
				Dim targetFCString As String = GetText2TargetFCString(tempUser)
				If String.IsNullOrWhiteSpace(targetFCString) Then
					Continue For
				End If
				
				AddEmail(si, toEmail, tempUser, targetFCString, entityList)
			Next
			
			For Each item In toEmail
				BRAPI.ErrorLog.LogMessage(si, item)
			Next
			' Send the message
			BRApi.Utilities.SendMail(si, emailConnectionName, toEmail, subject, messageBody, Nothing)
		
			' Return message to user
			Dim selectionChangedTaskResult As New XFSelectionChangedTaskResult()
				selectionChangedTaskResult.IsOK = True
				selectionChangedTaskResult.ShowMessageBox = False
				selectionChangedTaskResult.Message = "Email Sent."
				selectionChangedTaskResult.ChangeSelectionChangedUIActionInDashboard = False
				selectionChangedTaskResult.ModifiedSelectionChangedUIActionInfo = Nothing
				selectionChangedTaskResult.ChangeSelectionChangedNavigationInDashboard = False
				selectionChangedTaskResult.ModifiedSelectionChangedNavigationInfo = Nothing
				selectionChangedTaskResult.ChangeCustomSubstVarsInDashboard = False
				selectionChangedTaskResult.ModifiedCustomSubstVars = Nothing
				selectionChangedTaskResult.ChangeCustomSubstVarsInLaunchedDashboard = False
				selectionChangedTaskResult.ModifiedCustomSubstVarsForLaunchedDashboard = Nothing
			Return selectionChangedTaskResult
		End Function
		
		Public Function GetText2TargetFCString(ByVal tempUser As UserSummaryInfo) As String
			Dim text2 As String = tempUser.Text2.Replace(" ","")
			If String.IsNullOrWhiteSpace(text2) OrElse Not text2.XFContainsIgnoreCase("TGTFundCenters") Then
				Return ""
			End If
			
			Dim subTitle As String = "TGTFundCenters=["
			Dim subStart As Integer = text2.IndexOf(subTitle) + Len(subTitle)
			Dim subEnd As Integer = text2.IndexOf("]",text2.IndexOf(subTitle)) - subStart
			Dim targetFCString As String = text2.Substring(subStart, subEnd)
			
			Return targetFCString
		End Function
		
		Public Sub AddEmail(ByVal si As SessionInfo, ByVal toEmail As List(Of String), ByVal tempUser As UserSummaryInfo, ByVal targetFCString As String, ByVal entityList As List(Of String))
			For Each child In entityList
				If targetFCString.XFContainsIgnoreCase(child) Then
					toEmail.Add(BRApi.Security.Admin.GetUser(si, tempUser.Name).User.Email)
					Exit Sub
				End If
			Next
		End Sub
#End Region

#Region "PublishCPROBEToTarget"
Public Function PublishCPROBEToTarget(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As XFSelectionChangedTaskResult
	Dim selectionChangedTaskResult As New XFSelectionChangedTaskResult()
	Dim sTargetSource As String = args.SelectionChangedTaskInfo.CustomSubstVarsWithUserSelectedValues.XFGetValue("ML_CMD_TGT_POMPBSrc","NA")	
	Dim dargs As New DashboardExtenderArgs
	dargs.FunctionName = "Check_WF_Complete_Lock"
	Dim sWFStatus As String = GBL_Helper.Main(si, globals, api, dargs)

	If sWFStatus.XFContainsIgnoreCase("Unlocked") Then		
		Dim gWorkSpaceId As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
		Dim dmDictionary As Dictionary(Of String, String) = New Dictionary(Of String, String)
		dmDictionary.Add("TargetSource", sTargetSource)
		brapi.Utilities.ExecuteDataMgmtSequence(si,gWorkSpaceId,"CMD_TGT_PublishCPROBEToTGT",dmDictionary)
		Return selectionChangedTaskResult
	Else
		selectionChangedTaskResult.IsOK = False
		selectionChangedTaskResult.ShowMessageBox = True
		selectionChangedTaskResult.Message = vbCRLF & "NOT allowed to publish targets while the current workflow is locked. Nagvigate to the Manage Access dashboard and select the Revert Workflows button before publishing targets." & vbCRLF	
		Return selectionChangedTaskResult
	End If
End Function

#End Region
	 	
#Region "Validate Target"	
Public Function ValidateTarget(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As Object
''==========================================================================================================================================
'' Updated 6/2/2025 - MH & KN
'' Changed TGT validation to account for APPN-specific validation rules per Fundcenter and Fundcode
'' Ticket 1274 Sprint 23
'' Used in: btn_TGTDST_TGTVAL_0CaAa_A_ValidateTarget 
'' With: {zMH_TGTDST_SolutionHelper}{ValidateTarget}{Entity = |!prompt_cbx_TGTDST_AAAAAA_0CaAa_FundCenter__Shared!|}
''==========================================================================================================================================

			'This code runs the validation cube view and looks at the variance column.
			'If there is a non zero valu, it throws an exception

			Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
			Dim wfCube = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName	
			Dim wfScenarioName As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
			Dim wfTimeNameMonth As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey) & "M12"
			Dim wfTimeName As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
			Dim sEntity As String =  args.NameValuePairs.XFGetValue("Entity")
			Dim sEntityParent As String = sEntity.Replace("_General","")

			Dim  dic As New Dictionary(Of String, String)
			Dim  cubeViewName As String = args.NameValuePairs.XFGetValue("CVName") ' "TGT_Review_In_Out_Variance_YH"
			Dim  entityDimName As String = "E_" & wfCube 
			Dim  entityMemFilter As String = "E#" & sEntity'"A29_General"
			Dim  scenarioDimName As String = "S_Main" 
			Dim  scenarioMemFilter As String = "" 
			Dim  timeMemFilter As String = "" 
			Dim  nvbParams As New NameValueFormatBuilder("",dic,False)
			Dim  includeCellTextCols As Boolean = False 
			Dim  useStandardFactTableFields As Boolean = True
			Dim  filter As String = "" 
			Dim  parallelQueryCount As Integer = 2 
			Dim  logStatistics As Boolean = False
			
			Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
			Dim dt As DataTable = BRApi.Import.Data.FdxExecuteCubeView(si, gValue, cubeViewName, entityDimName, entityMemFilter, scenarioDimName, scenarioMemFilter, timeMemFilter, nvbParams, includeCellTextCols, useStandardFactTableFields, filter, parallelQueryCount, logStatistics)
			
			If dt Is Nothing Then
			 	Throw New Exception( vbCrLf & "No Target and Distribution to validate.")
				Return Nothing
			Else
'BRApi.ErrorLog.LogMessage(si, "Count = " & dt.Rows.Count)
				Dim ud1 As String = ""
				Dim ud3 As String = ""
				Dim variance As Decimal
				For Each r As DataRow In dt.Rows
					Dim rowContent As String = ""
					ud1 = r("UD1").ToString
					ud3 = r("UD3").ToString
					variance = Math.Round(Convert.ToDecimal(r("VVariance")),2)
					rowContent =  "Entity : " & r("Entity").ToString &  "UD1 : " & r("UD1").ToString &  "UD3 : " & r("UD3").ToString &  "Target : " & r("VControl").ToString & ", Target : " & r("VTargetLines").ToString & ", VVariance : " & r("VVariance").ToString 
'brapi.ErrorLog.LogMessage(si, rowContent)
					If variance > 0	
						brapi.ErrorLog.LogMessage(si, "Balanced 1")
				    	Throw New Exception( vbCrLf & "Target Control is not fully distributed for " & sEntityParent & " on " & ud1 & " and " & ud3 & environment.NewLine & "The Variance is " &  variance & ".")
					Else If variance < 0
						brapi.ErrorLog.LogMessage(si, "Balanced 2")
				     	Throw New Exception(vbCrLf & "Total Distributed Target is more than the Target Control amount for " & sEntityParent & " on " & ud1 & " and " & ud3 & environment.NewLine & "The Variance is " &  variance & ".")
					End If
						
				Next
			End If
'brapi.ErrorLog.LogMessage(si, "Balanced")	
			'The validation passed. Set balanced flag
			Dim sDataBufferConfirmationFlag As String =  "Cb#" & wfCube & ":S#" & wfScenarioName & ":T#" & wfTimeNameMonth & ":C#Local:V#Annotation:E#" & sEntity & ":A#TGT_Target_Distribution_Complete_Ind:I#None:F#None:O#BeforeAdj:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim objListofScriptsSetflag As New List(Of MemberScriptandValue)
			Dim objScriptValSetflag As New MemberScriptAndValue
			objScriptValSetflag.CubeName = wfCube
			objScriptValSetflag.Script = sDataBufferConfirmationFlag
			objScriptValSetflag.TextValue = "Yes"
			objScriptValSetflag.IsNoData = False
			objListofScriptsSetflag.Add(objScriptValSetflag)
			
			
			Brapi.Finance.Data.SetDataCellsUsingMemberScript(si,objListofScriptsSetflag)
			Dim sBalanceStatusScript As String = "Cb#" & wfCube & ":E#" & sEntity & ":C#Local:S#" & wfScenarioName & ":T#" & wfTimeName & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
		'brapi.ErrorLog.LogMessage(si, "sBalanceStatusScript= " & sBalanceStatusScript)
			Me.SetAnnotationValue(si, wfCube, sBalanceStatusScript, "Y")			
			Dim Statusmsg As String = "The validation For " & sEntityParent  & " has been completed. The Funds Center Is now locked. "
			BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "ValidationStatusMsg", "ValidationStatusMsg",Statusmsg)
			'BRApi.Dashboards.Parameters.SetLiteralParameterValue(si, False, "prompt_lbl_TGTDST_TGTVAL_0CaAa_Aa__TargetValidateStatus", Statusmsg)

			Return Nothing
			
		End Function
		#End Region
		
#Region "Get User Fund Centers By WF"
	'Get data table for FC list using Data Set
	Public Function GetUserFundCentersByWF (ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As DataTable
		'Args To pass Into dataset BR
		Dim dsArgs As New DashboardDataSetArgs 
		dsargs.FunctionType = DashboardDataSetFunctionType.GetDataSet
		dsArgs.DataSetName = "GetUserFundCentersByWF"
		'Get datatable for FC list
		Dim dt As DataTable = BR_TGTDataset.GetUserFundCentersByWF(si, globals, api, dsArgs)
		Return dt
	End Function
#End Region
		
#Region "Get Fund Center Lock Status"
	'Get Lock Status for passed in FC
	Public Function GetFCLockStatus (ByVal si As SessionInfo, ByVal args As DashboardExtenderArgs) As String
		Dim sCube As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName	
		Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity", "")	
		Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
		Dim sTimeM12 As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey) & "M12"	
		'Check TGT_Target_Distribution_Complete_Ind
		Dim indTargetMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTimeM12 & ":V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
		Dim indSourceValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, indTargetMbrScript).DataCellEx.DataCellAnnotation
'BRApi.ErrorLog.LogMessage(si,$"indTargetMbrScript = {indTargetMbrScript} || indSourceValue = {indSourceValue}")		
		Return indSourceValue
			
	End Function
#End Region

#Region "Get Fund Center Lock Status and Throw Message"
	''Get Lock Status for passed in FC and throw message if locked
	Public Function GetFCLockStatusAndThrowMsg (ByVal si As SessionInfo, ByVal args As DashboardExtenderArgs)
		Dim indSourceValue As String = Me.GetFCLockStatus(si, args)
		If indSourceValue.XFEqualsIgnoreCase("Yes") Then 
			Throw New Exception("This Funds Center is locked. Cannot perform action until it is unlocked.")
		Else
			Return Nothing
		End If
			
	End Function
#End Region	

#Region "Target Build: Execute NonPay Calc"
	'TARGET BUILD: Execute Data Management Sequence for NonPay Calc and display Message Box for any negative (overbudgetted) row
	'USAGE: Target Build > NonPay Cost Modify > Calc NonPay Cost button
	'NOTE: Work in conjunction with DST_MainCalc > Calc_NonPay method
	Public Function ExecuteNonPayCalc (ByVal si As SessionInfo, ByVal args As DashboardExtenderArgs)
		Try
			Dim dataMgmtSeq As String = "Calc_NonPay"     
			Dim params As New Dictionary(Of String, String)
			Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
			'Execute Data Managment Sequence
			BRApi.Utilities.ExecuteDataMgmtSequence(si,gValue, dataMgmtSeq, params)
			'Get cached session variable from DST_MainCalc > Calc_NonPay for negative rows
			Dim iError As Integer = BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, "TargetBuild_NonPayCalc", "iError", 0)
			Dim sError As String = BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, "TargetBuild_NonPayCalc", "sError", "")
			If iError > 0 Then
				Dim lErrors As List(Of String) = sError.Split("|").ToList
				Dim sMessage As String = $"WARNING: {iError} row(s) not created due to overbudgeting in Pay/Withhold amount for the following combination(s):"
				For Each msg As String In lErrors
					sMessage = sMessage & vbCrLf & msg
				Next
				Dim selectionChangedTaskResult As New XFSelectionChangedTaskResult()
				selectionChangedTaskResult.IsOK = True
				selectionChangedTaskResult.ShowMessageBox = True
				selectionChangedTaskResult.Message = sMessage
				
				Return selectionChangedTaskResult
				
			End If
			
			Return Nothing
		
		Catch ex As Exception
			Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
		End Try
			
	End Function
#End Region

#Region "Copy Target Build Withholds"
		'DEV NOTE: All code regarding CarryOver is commented out. If the requirement doesn's come back for a while, it can be removed
		Public Function CopyTargetBuildWithholds(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs, Optional ByVal Entity As String = "") As Boolean

		    Dim sCube As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName	
			Dim objDimPK As DimPk = brapi.Finance.Dim.GetDimPk(si, "E_ARMY")
			Dim iEntityID As Integer = BRApi.Finance.Members.GetMemberId(si,objDimPK.DimTypeId,sCube)
			Dim sEntity As String = BRApi.Finance.Entity.Text(si,iEntityID, 1, False, False) & "_General"
			Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
			Dim sTime As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
			'Dim sTimeint As Integer = (sTime.XFConvertToInt +1) 
			'Dim sTimeNY As String = sTimeint & "M12"
			Dim sTimeM12 As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey) & "M12"
'brapi.ErrorLog.LogMessage(si,"Time" &	sTimeNY )
'brapi.ErrorLog.LogMessage(si,"Source Entity: " & sSourceEntity & "target Entiy: " & sTargetEntity & "Source REQ: " & sSourceREQ & "Target REQ: " & sTargetREQ)			
		'Check TGT_Target_Distribution_Complete_Ind
			Dim indTargetMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTimeM12 & ":V#YTD:A#TGT_Target_Distribution_Complete_Ind:F#Baseline:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim indSourceValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, indTargetMbrScript).DataCellEx.DataCellAnnotation
			
			If indSourceValue.XFEqualsIgnoreCase("Yes") Then 
				Throw New Exception("This Funds Center is locked. Target Build Withholds cannot be copied until it is unlocked.")
			End If
			
'		'Check TGT_Obligation_Withhold_Spread_Prct Next Year (NY)'
'			Dim obligSpreadPrctTargetMbrScriptNY As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTimeNY & ":V#Periodic:A#TGT_Obligation_Withhold_Spread_Prct:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
'			Dim obligSpreadPrctSourceValueNY As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, obligSpreadPrctTargetMbrScriptNY).DataCellEx.DataCell.CellAmount
'			'Check TGT_Commitment_Withhold_Spread_Prct Next Year (NY)			
'			Dim commitSpreadPrctTargetMbrScriptNY As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTimeNY & ":V#Periodic:A#TGT_Commitment_Withhold_Spread_Prct:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
'			Dim commitSpreadPrctSourceValueNY As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, commitSpreadPrctTargetMbrScriptNY).DataCellEx.DataCell.CellAmount
'Brapi.ErrorLog.LogMessage(si, "NYspread" & commitSpreadPrctSourceValueNY )

		'Check TGT_Obligation_Withhold_Spread_Prct
			Dim obligSpreadPrctTargetMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTime & ":V#Periodic:A#TGT_Obligation_Withhold_Spread_Prct:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim obligSpreadPrctSourceValue As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, obligSpreadPrctTargetMbrScript).DataCellEx.DataCell.CellAmount
		'Check TGT_Commitment_Withhold_Spread_Prct				
			Dim commitSpreadPrctTargetMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTime & ":V#Periodic:A#TGT_Commitment_Withhold_Spread_Prct:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim commitSpreadPrctSourceValue As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, commitSpreadPrctTargetMbrScript).DataCellEx.DataCell.CellAmount

			Dim TotalcommitSpreadPrctSourceValue As Decimal = commitSpreadPrctSourceValue ' + commitSpreadPrctSourceValueNY)
			Dim TotalobligSpreadPrctSourceValue As Decimal =  obligSpreadPrctSourceValue  '+ obligSpreadPrctSourceValueNY)
			
			If TotalobligSpreadPrctSourceValue <> 100.00  And TotalcommitSpreadPrctSourceValue <> 100.00 Then 
				Throw New Exception("The Commitment or the Obligation total spread withhold rates do not equal 100%. Please update rates.")
			End If
			
		'Consolidate Target Build Wtihholds
			Dim dataMgmtSeq As String = "Copy_TargetBuild_Withholds"     
			Dim params As New Dictionary(Of String, String) 
			Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
			BRApi.Utilities.ExecuteDataMgmtSequence(si,gValue, dataMgmtSeq, params)	
	
		'Add extra rounding to carryover year for phased commitment and phased obligation		

			'Commitment FY|WFTime| total Phased_Commitment_Withhold
				Dim myDataUnitPkCommitFY As New DataUnitPk( _
				BRApi.Finance.Cubes.GetCubeInfo(si, sCube).Cube.CubeId, _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, sEntity ), _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, ""), _
				DimConstants.Local, _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Scenario, sScenario),
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Time, sTime))
			' Buffer coordinates.
			' Default to #All for everything, then set IDs where we need it.
				Dim myDbCellPkCommitFY As New DataBufferCellPk( DimConstants.All )
				myDbCellPkCommitFY.AccountId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Account, "Phased_Commitment_Withhold")
				myDbCellPkCommitFY.FlowId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Flow, "Baseline")
				myDbCellPkCommitFY.OriginId = DimConstants.BeforeAdj
				myDbCellPkCommitFY.UD4Id = DimConstants.None
				myDbCellPkCommitFY.UD5Id = DimConstants.None
				myDbCellPkCommitFY.UD6Id = BRApi.Finance.Members.GetMemberId(si, dimTypeId.UD6, "92")
				myDbCellPkCommitFY.UD7Id = DimConstants.None
				myDbCellPkCommitFY.UD8Id = DimConstants.None	

				Dim totalComitWithholdsFY As List(Of DataCell)  = BRApi.Finance.Data.GetDataBufferDataCells(si, myDataUnitPkCommitFY, dimConstants.Periodic, myDbCellPkCommitFY, True, True)	

'			'Commitment Carryover total Phased_Commitment_Withhold
'				Dim myDataUnitPkCommitCarryover As New DataUnitPk( _
'				BRApi.Finance.Cubes.GetCubeInfo(si, sCube).Cube.CubeId, _
'				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, sEntity ), _
'				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, ""), _
'				DimConstants.Local, _
'				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Scenario, sScenario),
'				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Time, sTimeNY))
'			' Buffer coordinates.
'			' Default to #All for everything, then set IDs where we need it.
'				Dim myDbCellPkCommitCarryover As New DataBufferCellPk( DimConstants.All )
'				myDbCellPkCommitCarryover.AccountId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Account, "Total_Phased_Obligation")
'				myDbCellPkCommitCarryover.FlowId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Flow, "Baseline")
'				myDbCellPkCommitCarryover.OriginId = DimConstants.BeforeAdj
'				myDbCellPkCommitCarryover.UD4Id = DimConstants.None
'				myDbCellPkCommitCarryover.UD5Id = DimConstants.None
'				myDbCellPkCommitCarryover.UD6Id = BRApi.Finance.Members.GetMemberId(si, dimTypeId.UD6, "92")
'				myDbCellPkCommitCarryover.UD7Id = DimConstants.None
'				myDbCellPkCommitCarryover.UD8Id = DimConstants.None	

'				Dim totalComitWithholdsCarryover As List(Of DataCell)  = BRApi.Finance.Data.GetDataBufferDataCells(si, myDataUnitPkCommitCarryover, dimConstants.Periodic, myDbCellPkCommitCarryover, True, True)	
			
			'Looping through UD1,UD2,UD3 against the Phased_Commitment total for FY|WFYear|
				For Each fyCell As DataCell In totalComitWithholdsFY	
					Dim fyU1 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD1, fyCell.DataCellPk.UD1Id)
					Dim fyU2 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD2, fyCell.DataCellPk.UD2Id)
					Dim fyU3 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD3, fyCell.DataCellPk.UD3Id)
			'Looping through UD1,UD2,UD3 against the Phased_Commitment total for FY|NextWFYear|		
'					For Each carryoverCell As DataCell In totalComitWithholdsCarryover
'						Dim U1 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD1, carryoverCell.DataCellPk.UD1Id)
'						Dim U2 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD2, carryoverCell.DataCellPk.UD2Id)
'						Dim U3 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD3, carryoverCell.DataCellPk.UD3Id)
			'Comparing the respective UD dimensions of the current year and next year 
			'If they match, we add their totals togehter
'						If U1.XFEqualsIgnoreCase(fyU1) And U2.XFEqualsIgnoreCase(fyU2) And U3.XFEqualsIgnoreCase(fyU3) Then
							Dim fyPhaseWithholdTotal As Decimal = fycell.CellAmount' + carryoverCell.CellAmount
			'Grab the Target Build withhold (TBW) amount				
							Dim sTotalUndistributedMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":S#" & sScenario & ":T#" & sTimeM12 & ":A#Total_Undistributed:C#Local:V#Periodic:F#Baseline:O#BeforeAdj:I#None:" & ":U1#" & fyU1 & ":U2#" & fyU2 & ":U3#" & fyU3 & ":U4#Top:U5#Top:U6#Top:U7#Top:U8#None"	
							Dim iTotalUndistributedAmt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si ,sCube,sTotalUndistributedMbrScript).DataCellEx.DataCell.CellAmount
			'Calculate the variance between the TBW amount and the phase commitment withhold total			
							Dim iVariance As Decimal = iTotalUndistributedAmt - fyPhaseWithholdTotal			
			'Add and save the variance to the phase commitment at FY|WFTime|M12										
							Dim sCommitFYM12MbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":S#" & sScenario & ":T#" & sTimeM12 & ":C#Local:V#Periodic:A#Phased_Commitment_Withhold:F#Baseline:O#BeforeAdj:I#None:U1#" & fyU1  & ":U2#" & fyU2 & ":U3#" & fyU3 & ":U4#None:U5#None:U6#92:U7#None:U8#None"			
							Dim iCommitFYM12Amt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si ,sCube,sCommitFYM12MbrScript).DataCellEx.DataCell.CellAmount

							iCommitFYM12Amt += iVariance
							
							Dim objListofCommitFYM12Scripts As New List(Of MemberScriptandValue)
							
							Dim objScriptCommitFYM12 As New MemberScriptAndValue
							objScriptCommitFYM12.CubeName = sCube
							objScriptCommitFYM12.Script = sCommitFYM12MbrScript
							objScriptCommitFYM12.Amount = iCommitFYM12Amt
							objScriptCommitFYM12.IsNoData = False
							objListofCommitFYM12Scripts.Add(objScriptCommitFYM12)
			
							BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofCommitFYM12Scripts)
							
'brapi.ErrorLog.LogMessage(si, fycell.CellAmountAsText & "||" & carryoverCell.CellAmountAsText & "||" & fyCarroverTotal.ToString)
'						End If
'					Next
				Next
			'Follows the same process as the phase commitment above			
			'Obligation FY|WFTime| total Phased_Obligation_Withhold
				Dim myDataUnitPkObligFY As New DataUnitPk( _
				BRApi.Finance.Cubes.GetCubeInfo(si, sCube).Cube.CubeId, _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, sEntity ), _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, ""), _
				DimConstants.Local, _
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Scenario, sScenario),
				BRApi.Finance.Members.GetMemberId(si, dimTypeId.Time, sTime))
			' Buffer coordinates.
			' Default to #All for everything, then set IDs where we need it.
				Dim myDbCellPkObligFY As New DataBufferCellPk( DimConstants.All )
				myDbCellPkObligFY.AccountId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Account, "Phased_Obligation_Withhold")
				myDbCellPkObligFY.FlowId = BRApi.Finance.Members.GetMemberId(si, dimTypeId.Flow, "Baseline")
				myDbCellPkObligFY.OriginId = DimConstants.BeforeAdj
				myDbCellPkObligFY.UD4Id = DimConstants.None
				myDbCellPkObligFY.UD5Id = DimConstants.None
				myDbCellPkObligFY.UD6Id = BRApi.Finance.Members.GetMemberId(si, dimTypeId.UD6, "92")
				myDbCellPkObligFY.UD7Id = DimConstants.None
				myDbCellPkObligFY.UD8Id = DimConstants.None	

				Dim totalObligWithholdsFY As List(Of DataCell)  = BRApi.Finance.Data.GetDataBufferDataCells(si, myDataUnitPkObligFY, dimConstants.Periodic, myDbCellPkObligFY, True, True)	
				
				For Each fyCell As DataCell In totalObligWithholdsFY	
					Dim fyU1 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD1, fyCell.DataCellPk.UD1Id)
					Dim fyU2 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD2, fyCell.DataCellPk.UD2Id)
					Dim fyU3 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD3, fyCell.DataCellPk.UD3Id)
					
'					For Each carryoverCell As DataCell In totalObligWithholdsCarryover
'						Dim U1 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD1, carryoverCell.DataCellPk.UD1Id)
'						Dim U2 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD2, carryoverCell.DataCellPk.UD2Id)
'						Dim U3 As String = BRApi.Finance.Members.GetMemberName(si, dimTypeId.UD3, carryoverCell.DataCellPk.UD3Id)
						
'						If U1.XFEqualsIgnoreCase(fyU1) And U2.XFEqualsIgnoreCase(fyU2) And U3.XFEqualsIgnoreCase(fyU3) Then
							Dim fyPhaseWithholdTotal As Decimal = fycell.CellAmount '+ carryoverCell.CellAmount
							
							Dim sTotalUndistributedMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":S#" & sScenario & ":T#" & sTimeM12 & ":A#Total_Undistributed:C#Local:V#Periodic:F#Baseline:O#BeforeAdj:I#None:" & ":U1#" & fyU1 & ":U2#" & fyU2 & ":U3#" & fyU3 & ":U4#Top:U5#Top:U6#Top:U7#Top:U8#None"	
							Dim iTotalUndistributedAmt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si ,sCube,sTotalUndistributedMbrScript).DataCellEx.DataCell.CellAmount
							
							Dim iVariance As Decimal = iTotalUndistributedAmt - fyPhaseWithholdTotal			
													
							Dim sObligFYM12MbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":S#" & sScenario & ":T#" & sTimeM12 & ":C#Local:V#Periodic:A#Phased_Obligation_Withhold:F#Baseline:O#BeforeAdj:I#None:U1#" & fyU1  & ":U2#" & fyU2 & ":U3#" & fyU3 & ":U4#None:U5#None:U6#92:U7#None:U8#None"			
							Dim iObligFYM12Amt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si ,sCube,sObligFYM12MbrScript).DataCellEx.DataCell.CellAmount

							iObligFYM12Amt += iVariance
							
							Dim objListofObligFYM12Scripts As New List(Of MemberScriptandValue)
							
							Dim objScriptObligFYM12 As New MemberScriptAndValue
							objScriptObligFYM12.CubeName = sCube
							objScriptObligFYM12.Script = sObligFYM12MbrScript
							objScriptObligFYM12.Amount = iObligFYM12Amt
							objScriptObligFYM12.IsNoData = False
							objListofObligFYM12Scripts.Add(objScriptObligFYM12)
			
							BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofObligFYM12Scripts)
							
'brapi.ErrorLog.LogMessage(si, fycell.CellAmountAsText & "||" & carryoverCell.CellAmountAsText & "||" & fyCarroverTotal.ToString)
'						End If
'					Next
				Next
				
			Return Nothing
		End Function
			  
#End Region	

#Region "SetAnnotationValue"	
		' Purpose: To set the annotation value at a given intersection
		' Usage: Called from many places for an annotation set data cell
		Public Function SetAnnotationValue(ByVal si As SessionInfo, ByVal sCube As String, ByVal memberScriptUsed As String, ByVal annotationText As String)
			
			'Create the List of MemberScriptandValue and MemberScriptandValue, then performs a SetDataCell
			Dim objListofScripts As New List(Of MemberScriptandValue)
	    	Dim objScriptMergeList As New MemberScriptAndValue
			objScriptMergeList.CubeName = sCube
			objScriptMergeList.Script = memberScriptUsed
			objScriptMergeList.TextValue = annotationText
			objScriptMergeList.IsNoData = False
			objListofScripts.Add(objScriptMergeList)
			BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofScripts)
			
			Return Nothing
			
		End Function
#End Region

'===========================================================================
#Region "Target Import File Helper"	
'----------Created to Output log files for REQ Imports----------
		Public Function TargetsImportFileHelper(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs, ByVal sErrorMsg As String, ByVal sTitle As String, Optional ByVal fName As String = "") 
		
			Dim sUser As String = si.UserName
			Dim sTimeStamp As String = datetime.Now.ToString.Replace("/","").Replace(":","").Replace(" ","_")
			Dim file As New Text.StringBuilder
			
			file.Append(sErrorMsg)
			
			Dim sfileName As String = sTitle & "_" & sUser & "_" & sTimeStamp & "_" & fName
			'Pass text to bytes
			Dim fileBytes As Byte() = Encoding.UTF8.GetBytes(file.ToString)
							
			'Define folder to hold file
			Dim sUserFolderPath As String = "Documents/Users/" & sUser
			Dim sAdminFolderPath As String = "Documents/Public/Admin/Targets/Batch_Upload_Error_Log"
			
			Dim objXFFolderExUser As XFFolderEx = BRApi.FileSystem.GetFolder(si, FileSystemLocation.ApplicationDatabase, sUserFolderPath)							
			Dim objXFFileInfoUser = New XFFileInfo(FileSystemLocation.ApplicationDatabase, String.Concat(sUserFolderPath, "/", sFileName))
			Dim objXFFileUser As New XFFile(objXFFileInfoUser,String.Empty,fileBytes)
			
			Dim objXFFolderExAdmin As XFFolderEx = BRApi.FileSystem.GetFolder(si, FileSystemLocation.ApplicationDatabase, sAdminFolderPath)							
			Dim objXFFileInfoAdmin = New XFFileInfo(FileSystemLocation.ApplicationDatabase, String.Concat(sAdminFolderPath, "/", sFileName))
			Dim objXFFileAdmin As New XFFile(objXFFileInfoAdmin,String.Empty,fileBytes)

			'Load User file
			BRApi.FileSystem.InsertOrUpdateFile(si, objXFFileUser)
			BRApi.FileSystem.InsertOrUpdateFile(si, objXFFileAdmin)
			
			Return Nothing
			
		End Function
#End Region
'===========================================================================
#Region "TGTDST_TGTIMP_LoadFile"
		'---------------------------------------------------------------------------------------------------
		' Created: 2025-Feb-20 - AK
		'
		' Purpose: 
		'
		' Invocation: MAIN() args.FunctionName.XFEqualsIgnoreCase("TGTDST_TGTIMP_LoadFile")
		'
		' Usage Instructions from a component:
		'	{TGTDST_SolutionHelper}{TGTDST_TGTIMP_LoadFile}{Caller=TGTDST_Import, FilePath = |!FilePath!|}
		'
		'	Where:
		'		FilePath= is a string of the dimensions you want returned
		'
		'
		' Usage Instructions from a rule:
		'	Set reference assemblies = BR\TGTDST_SolutionHelper
		'	add code Private TGTDST_SolutionHelper As New OneStream.BusinessRule.DashboardExtender.TGTDST_SolutionHelper.MainClass
		'	add to rule: 
		'			Dim de_args as new DashboardExtenderArgs
		'			de_args.NameValuePairs.XFSetValue("FilePath", "xxxx")
		'			TGTDST_SolutionHelper.TGTDST_TGTIMP_LoadFile(si, globals, nothing, de_args)
		'
		'
		'Modifications:
		'
		'---------------------------------------------------------------------------------------------------

		Public Function	TGTDST_TGTIMP_LoadFile(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As Object
			Try

'========== debug vars ===================================
Dim tStart As DateTime =  Date.Now()	
Dim sDebugRuleName As String = "TGTDST_SolutionHelper"
Dim sDebugFuncName As String = "TGTDST_TGTIMP_LoadFile"
Dim sCaller As String = args.NameValuePairs.XFGetValue("Caller")
'=========================================================

'====================================================================================================================================
#Region "init module vars"			
				Dim timeStart As DateTime = System.DateTime.Now
			
				Dim wfCube = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
				Dim wfScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
				Dim wfTime As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
				Dim wfYear As Integer = CInt(BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey))

				'----- ACOM transformations -----
				Dim sACOM As String  = BRApi.Finance.Metadata.GetMember(si, dimTypeId.Entity, wfCube).Member.name
				If BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0).XFEqualsIgnoreCase("USAREUR") Then
					sACOM = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0) & "_AF"
				Else 
					sACOM = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0)
				End If
				
				Dim sACOM_FundCenter As String = BRApi.Finance.Entity.Text(si, BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, sACOM), 1, 0, 0)	

				
				'---get user fund centers for target distribution--			
				Dim dt As DataTable = Me.GetUserFundCentersByWF(si, globals, api, args)
				Dim oUserFundCenters As New List(Of String)
				For Each row As DataRow In dt.Rows
					oUserFundCenters.Add(row("Value").Replace("_General",""))
					Dim objMemberInfos As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si,"E_" & wfCube,"E#" & row("Value").Replace("_General","") & ".Children.Where(Name DoesNotContain _FC)",True)
					For Each item As MemberInfo In objMemberInfos
						oUserFundCenters.Add(item.Member.Name)
					Next				
				Next
				
				Dim saUserFundCenters() As String = oUserFundCenters.ToArray()
				
'				Dim objSignedOnUser As UserInfo = BRApi.Security.Authorization.GetUser(si, si.AuthToken.UserName)
'				Dim sUserName As String = objSignedOnUser.User.Name
'				Dim sUserDesc As String = objSignedOnUser.User.Description
'				Dim text2 As String = objSignedOnUser.User.Text2
'				Dim sUserFundCenters As String = ""
'				If ((Not String.IsNullOrWhiteSpace(text2)) And text2.XFContainsIgnoreCase("TGTFundCenters") ) Then 
'					text2 = text2.Replace(" ", "")
'					Dim subStart As Integer = text2.IndexOf("TGTFundCenters=[") + 16
'					Dim subEnd As Integer = text2.IndexOf("]",text2.IndexOf("TGTFundCenters=[")) - subStart
'					sUserFundCenters = text2.Substring(subStart, subEnd)
'				End If	
'				Dim saUserFundCenters() As String = sUserFundCenters.Split(",")
	

				'---- adjust list per workflow ----
				Dim lsUserFundCenters As New List(Of String)
				Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
				If wfProfileName.XFContainsIgnoreCase("CMD") Then
					'----- check if user has access to ACOM -----
					For Each sFC In saUserFundCenters
						If sFC.XFEqualsIgnoreCase(sACOM_FundCenter) Then lsUserFundCenters.Add(sFC)
					Next	
					If lsUserFundCenters.Count = 0 Then
						Throw New System.Exception("WARNING: User does not have access to " & sACOM_FundCenter)
					End If
					
					'----- check if ACOM is locked -----
					Dim sIndTargetMbrScript As String = "Cb#" & wfCube & ":E#" & sACOM_FundCenter & "_General:C#Local:S#" & wfScenario & ":T#" & wfYear & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim dIndValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, sIndTargetMbrScript).DataCellEx.DataCellAnnotation
'brapi.ErrorLog.LogMessage(si,"sACOM_FundCenter = " & sACOM_FundCenter)
					If dIndValue = "Yes" Then
						Throw New System.Exception("WARNING: " & sACOM_FundCenter & " is locked")
					End If
					
				Else
					
					'----- check if user has access to SubCmds -----
					For Each sUserFC As String In saUserFundCenters
						If Not sUserFC.XFEqualsIgnoreCase(sACOM_FundCenter) And sUserFC.XFContainsIgnoreCase(sACOM_FundCenter) Then lsUserFundCenters.Add(sUserFC)
					Next	
					If lsUserFundCenters.Count = 0 Then
						Throw New System.Exception("WARNING: User does not have access to any sub cmds")
					End If
					
				End If
				
			
				'----- get list of sub cmds user can load to -----
				Dim objDimPk As dimpk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
				Dim objMemberInfos_InputMbrs As New List(Of MemberInfo)
				For Each userfundcenter In lsUserFundCenters
					
					Dim objMemberInfos As List(Of MemberInfo) = brapi.Finance.Members.GetMembersUsingFilter(si,objDimPk, "E#" & userfundcenter & ".children.where(name doesnotcontain _General)", True)		
	
					For Each MbrInfo As MemberInfo In objMemberInfos
	
						If brapi.finance.Members.HasChildren(si,objDimPk,MbrInfo.Member.MemberId) Then

						    If brapi.finance.Members.GetMembersUsingFilter(si,objDimPk, "E#" & MbrInfo.Member.Name & "_general", True).Count = 0 Then
								Throw New System.Exception("TGTDST_TGTIMP_LoadFile(): Parent Entity member=" & MbrInfo.Member.Name & " does not hava a _General member.  Please add a _General member before continuing." )
							End If
							Dim InputMbr As MemberInfo = brapi.finance.Members.GetMembersUsingFilter(si,objDimPk, "E#" & MbrInfo.Member.Name & "_General", True)(0)
							objMemberInfos_InputMbrs.Add(InputMbr)
							
						Else
							objMemberInfos_InputMbrs.Add(MbrInfo)
						End If	
						
					Next
				Next
			

				Dim objResult As XFResult

#End Region 
'====================================================================================================================================


'====================================================================================================================================
#Region "read file"	

				'---------- Confirm source file path exists ----------
				Dim filePath As String = args.NameValuePairs.XFGetValue("FilePath")
				Dim objXFFileInfo = New XFFileInfo(FileSystemLocation.ApplicationDatabase, filePath)
				If objXFFileInfo Is Nothing
					Me.TargetsImportFileHelper(si, globals, api, args, "File " & objXFFileInfo.Name & " does NOT exist", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(String.Concat("File " & objXFFileInfo.Name & " does NOT exist")))
				End If
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then brapi.ErrorLog.LogMessage(si, sDebugRuleName & "." & sDebugFuncName & "-" & sCaller & ":   FolderPath: " & filePath & ", Name: " & objXFFileInfo.Name)


				'---------- Confirm source file is readable ----------
				Dim objXFFileEx As XFFileEx = BRApi.FileSystem.GetFile(si, objXFFileInfo.FileSystemLocation, objXFFileInfo.FullName, True, True)
				If objXFFileEx Is Nothing
					Me.TargetsImportFileHelper(si, globals, api, args, "Unable to open file " & objXFFileInfo.Name, "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(String.Concat( "Unable to open file " & objXFFileInfo.Name)))
				End If

				'---------- read file ----------
				'DVLP NOTE: If the file is too large check here for performance issue. Maybe a file streamer to read a line at a time may be better
				Dim sFileText As String = system.Text.Encoding.ASCII.GetString(objXFFileEX.XFFile.ContentFileBytes)
				
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then brapi.ErrorLog.LogMessage(si, sDebugRuleName & "." & sDebugFuncName & "-" & sCaller & ":   Size=" & sFileText.Length)				
				
#End Region 
'====================================================================================================================================


'====================================================================================================================================
#Region "remove invalid chars"	
			
				'----------Clean up CRLF from the file ----------

				Dim patt As String = "(" & vbCrLf & "|" & vbLf & ")(?!" & sACOM_FundCenter & ")"'(?=[a-zA-Z0-9,""@!#$%'()+=-_.:<>?~^]*)" '-- Include what is in the brackt
				Dim cleanedText As String = Regex.Replace(sFileText,patt,"  ")
				
				Dim patt2 As String = "[^a-zA-Z0-9,""@!#$%'()+=_.:<>?~\-\[\]\*\^\\\/" & vbcrlf & vbLf & "]"
				cleanedText = Regex.Replace(cleanedText,patt2," ")
				
				'this handles ZWSP's that get brought in as "???" and ignored by the second pass as question marks are allowed
				Dim patt3 As String = "???"
				cleanedText = cleanedText.Replace(patt3," ")	
				
				'Alternate method not being used
	'			'Looping through Ascii Table for character 
	'				'*2-4-25 requested By Paul Burke To replace special Char. Discovered during testing In Stage, By product owners
	'				For  i As Integer = 1 To 127
	'				Select Case i
	'				Case 48 <= i <= 57 '0-9
	'					'Do Nothing
	'				Case 65 <= i <= 95 'ABC
	'					'Do Nothing
	'				Case 97 <= i <= 126 'abc
	'					'Do Nothing	
	'				Case 32,34,35,36,37,39,40,41,42,43,44,45,46,47,58
	'					'Do Nothing	
	'				Case Else	
	'					line = line.Replace(chr(i)," ")
	'				End Select


				'***********Split will need to be replace with alternate solution to handle CRLF issue*******
				Dim lines As String() = cleanedText.Split(vbCRLF) 
				
				If lines.Count < 1 Then 
					Me.TargetsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " is empty", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " is empty"))
				End If
				
				'For performance we are capping the upload file to not more than 5000
				If lines.Count > 5001 Then 
					Me.TargetsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " is too large. Please upload a file not more than 5000 rows", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " is too large. Please upload a file not more than 5000 rows"))
				End If

#End Region 
'====================================================================================================================================
			
			
'====================================================================================================================================
#Region "clear table"	

				'----------clear ACOM from table ----------
				Dim SQLClearRows As String = "Delete from XFC_TGTDST_Import Where ACOM = '" & sACOM_FundCenter & "' and Scenario = '" & wfScenario & "' And FiscalYear = '" & wfTime & "' And UserName = '" & si.UserName & "'"
				
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si,"SQLClearRows = " & SQLClearRows)

				Using dbConnApp As DBConnInfo = BRAPi.Database.CreateApplicationDbConnInfo(si)
					BRAPi.Database.ExecuteActionQuery(dbConnApp, SQLClearRows.ToString, False, True)
				End Using
					
#End Region 
'====================================================================================================================================

'====================================================================================================================================
#Region "loop thru lines and validate"	
	
				Dim firstLine As Boolean = True
				'Dim currentUsedFlows As List(Of String) = New List(Of String)
				Dim lsSpendPlanRecords As List (Of SpendPlanRecord) = New List (Of SpendPlanRecord)
				Dim isFileValid As Boolean = True
				Dim iLineCount As Integer = 0
				Dim membList As List(Of memberinfo)
					
				
				'Loop through each line and process
				For Each line As String In lines
					iLineCount += 1

'------------------------------------------------------------------------------
#Region "Parse file"

					'Skip empty line
					If String.IsNullOrWhiteSpace(line) Then
						Continue For
					End If

					'If there are back to back (escaped) double quotes, they will be replaced with single quotes.
					'This is done becasue "s are used as column separator in csv files and "s inside would be represented as escaped quotes ("")
					line = line.Replace("""""", "'")

'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "Line : " & line)
					'Use reg expressions to split the csv.
					'The expression accounts for commas that are with in "" to treat them as data.
					Dim pattern As String = ",(?=(?:[^""]*""[^""]*"")*[^""]*$)"
					Dim fields As String () = Regex.Split(line, pattern)
					
					'Check number of column and skip first line
					If firstLine Then
						'There needs to be 9 columns
						Dim sValidNumCols As Integer = 7
						If fields.Length <> sValidNumCols Then
							Me.TargetsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " has invalid structure at line #" & iLineCount & ". Please check the file if its in the correct format. Expected number of columns is " & sValidNumCols & ", number columns in file header is " & fields.Length & vbCrLf & line, "FAIL", objXFFileInfo.Name)
							Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " has invalid structure at line #" & iLineCount & ". Please check the file if its in the correct format. Expected number of columns is " & sValidNumCols & ", number columns in file header is "& fields.Length & vbCrLf & line ))
						End If
						
						firstLine = False
						Continue For
					End If
				
					'----- The parsed fields are stored in the class. If new column is introduced, it needs to be added to the REQ class object as well -----
					Dim CurrRow As SpendPlanRecord = New SpendPlanRecord
					'Trim any unprintable character and surrounding quotes

					CurrRow.ACOM = fields(0).Trim().Trim("""")
					'CurrRow.Scenario is derived 
					CurrRow.FiscalYear = fields(1).Trim().Trim("""")
					CurrRow.FundCenter = fields(2).Trim().Trim("""")
					CurrRow.FundCode = fields(3).Trim().Trim("""")
					CurrRow.MDEP = fields(4).Trim().Trim("""")
					CurrRow.APE_PT = fields(5).Trim().Trim("""")
					CurrRow.CY_Amt = fields(6).Trim().Trim("""")


					If CurrRow.CY_Amt = "" Then CurrRow.CY_Amt = "0"
						
					'----- confirm WF ACOM fundcenter matches ACOM fundcenter in file -----
					If Not currRow.ACOM.XFEqualsIgnoreCase(sACOM_FundCenter) Then
						Me.TargetsImportFileHelper(si, globals, api, args, "ACOM=" & currRow.ACOM & " in the file does not match the ACOM = " & sACOM_FundCenter & " of the workflow", objXFFileInfo.Name)
						Throw New XFUserMsgException(si, New Exception("ACOM=" & currRow.ACOM & " in the file does not match the ACOM = " & sACOM_FundCenter & " of the workflow"))					
					End If	

					'----- If fundcenter is a parent, add _General -----
					objDimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & sACOM)
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "E#" & currRow.FundCenter & ".base", True)
					If membList.Count > 1 Then
						currRow.FundCenter = currRow.FundCenter & "_General"
					End If
					
					'----- assign WF scenario to REQ -----
					currRow.Scenario = wfScenario
					
					'----- confirm WF year matches year in file -----
					If currRow.FiscalYear <> wfTime Then
						Me.TargetsImportFileHelper(si, globals, api, args, "Fiscal year=" & currRow.FiscalYear & " in the file does not match the fiscal year = " & wfTime & " of the workflow", objXFFileInfo.Name)
						Throw New XFUserMsgException(si, New Exception("Fiscal year=" & currRow.FiscalYear & " in the file does not match the fiscal year = " & wfTime & " of the workflow"))					
					End If	
					
					
#Region "U3 APPN grabber"					
					'====== Get APPN_FUND And PARENT APPN_L2 ======
					Dim U1Name As String = CurrRow.FundCode					
					Dim U1DimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN_FUND")
					Dim U1MemberID As Integer = BRApi.Finance.Members.GetMemberId(si,dimType.UD1.Id, U1Name)
					Dim U1ParentName As String = BRApi.Finance.Members.GetParents(si,U1DimPk, U1MemberId, False, )(0).Name 				
				

					'====== GET BA Parent for APEPT ======
					Dim U3Name As String = CurrRow.APE_PT
					Dim U3objDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U3_APE_PT")
					Dim U3memSearch As String = "U3#APPN.BASE.Where(Name Contains " & U3Name & " And  Name Contains " & U1ParentName & " )"
					Dim U3membList As List(Of Memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, U3objDimPk ,U3memSearch ,True)

					' check if 0 for  U3membList
					If U3membList.Count = 0 Then
							Throw New XFUserMsgException(si, New Exception("Error: Invalid APE value: " & CurrRow.APE_PT & " does Not exist"))
					End If
					
					Dim U3Member As String  = U3membList.Item(0).Member.Name
					
					CurrRow.APE_PT = U3Member
						
					
'================================================================================================						
#End Region					
				
#End Region
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
#Region "Validate members"
	
					CurrRow.valid = True
					Dim sValidationError As String = ""
					
					'----- Check if ACOM is valid -----
					objDimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "E#" & CurrRow.ACOM , True)
					If (membList.Count <> 1 ) Then 
						Throw New XFUserMsgException(si, New Exception("ERROR: invalid ACOM:" & CurrRow.ACOM & " does not exist"))
					End If
					
					'----- VCheck if fiscal year is valid -----
					objDimPk = DimPk.TimeDimPk
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "T#" & CurrRow.FiscalYear, True)
					If (membList.Count <> 1 ) Then 
						Throw New XFUserMsgException(si, New Exception("ERROR: invalid Current Year:" & CurrRow.FiscalYear & " does not exist"))
					End If

					'----- VCheck if fiscal year + 1 is valid -----
					objDimPk = DimPk.TimeDimPk
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "T#" & CurrRow.FiscalYear+1, True)
					If (membList.Count <> 1 ) Then 
						Throw New XFUserMsgException(si, New Exception("ERROR: invalid Next Year:" & CurrRow.FiscalYear+1 & " does not exist"))
					End If

					'-----Check if amount is numeric-----
					If Not isnumeric(CurrRow.CY_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY Amt contains nun-numeric. Amount="& CurrRow.CY_Amt
						CurrRow.CY_Amt = 0
					End If

					
					'-----Check if amount has decimal-----
'					For Each amount In LsAmountRows
'						If amount.XFContainsIgnoreCase(".") Then
'							CurrRow.valid = False
'							If sValidationError <> "" Then sValidationError &= vbCrlf 
'							sValidationError &= "ERROR: row contains decimals.  Amount = " & Amount
'							CurrRow.CY_Amt = 0
'							CurrRow.NY_Amt = 0
'						End If
'					Next 
					If CurrRow.CY_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY Amt contains a decimal. Amount="& CurrRow.CY_Amt
						CurrRow.CY_Amt = 0
					End If
					
					
					'----- Check if Fund Center being loaded is with in the user's security list -----
					Dim sFundCenter As String = CurrRow.FundCenter
					If Not objMemberInfos_InputMbrs.Exists(Function(x) x.Member.Name = sFundCenter) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: User does not have privileges to Funds Center: " & sFundCenter.Replace("_General","")
					End If
					
					
					'----- Check if fundcode being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN_FUND")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U1#" & CurrRow.fundCode, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid FundCode: " & CurrRow.fundCode & " does not exist"
					End If
								
					'----- Check if mdep being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U2_MDEP")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U2#" & CurrRow.MDEP, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid MDEP value: " & CurrRow.MDEP & " does not exist"
					End If
					
					'----- Check if ape being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U3_APE_PT")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U3#" & CurrRow.APE_PT, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid APE value: " & CurrRow.APE_PT & " does not exist"
					End If					
						
					CurrRow.validationError = sValidationError
'If Not CurrRow.valid Then BRApi.ErrorLog.LogMessage(si, "Error line : " & currRow.StringOutput())					
						
					If Not CurrRow.valid Then isFileValid = False

					'Add REQ to the REQ list
					lsSpendPlanRecords.Add(currRow)
			
#End Region	
'------------------------------------------------------------------------------

				Next	'loop lines

#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "loop thru rows and load table"	

				Dim lsEnitiesInTable As New List(Of String)

				'loop through all parsed requirements list
				For Each CurrRow As SpendPlanRecord In lsSpendPlanRecords

					'------ capture unique list of entities in table -----	
					If Not lsEnitiesInTable.Contains(CurrRow.FundCenter) Then lsEnitiesInTable.Add(CurrRow.FundCenter)
					
'------------------------------------------------------------------------------
#Region "load table"
'brapi.ErrorLog.LogMessage(si,"before SQL statement insert")				
					'insert into table
					Dim SQLInsert As String = "
					INSERT Into [dbo].[XFC_TGTDST_Import]
								([ACOM]
								,[Scenario]
								,[FiscalYear]
								,[FundCenter]
								,[FundCode]
								,[MDEP]
								,[APE_PT]
								,[Amount]
								,[Valid]
								,[UserName]
								,[ValidationError])
				    VALUES
		   				('" & 
							CurrRow.ACOM.Replace("'", "''") & "','" &
							CurrRow.Scenario.Replace("'", "''") & "','" &
							CurrRow.FiscalYear.Replace("'", "''") & "','" &
							CurrRow.FundCenter.Replace("'", "''") & "','" &
							CurrRow.FundCode.Replace("'", "''") & "','" &
							CurrRow.MDEP.Replace("'", "''") & "','" &
							CurrRow.APE_PT.Replace("'", "''") & "','" &
							CurrRow.CY_Amt & "','" &
							CurrRow.valid & "','" &
							si.UserName & "','" &
							CurrRow.validationError.Replace("'", "''") &
						"')"  				
 'BRApi.ErrorLog.LogMessage(si, "SQLInsert : " & SQLInsert)
								
					Using dbConnApp As DBConnInfo = BRAPi.Database.CreateApplicationDbConnInfo(si)
						BRAPi.Database.ExecuteActionQuery(dbConnApp, SQLInsert, False, True)
					End Using
'brapi.ErrorLog.LogMessage(si,"after SQL statement insert")	
#End Region
'------------------------------------------------------------------------------

				Next

#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "If import mode = partial then check if any entities in table is locked"

			

					Dim lsListOfParents As New List(Of String)
					For Each sFC As String In lsEnitiesInTable
						Dim iEntityID As Integer = BRapi.Finance.Members.GetMemberId(si,dimtype.Entity.Id, sFC.Replace("_General",""))
						Dim sParentFC As String = BRApi.Finance.Members.GetParents(si, BRApi.Finance.Dim.GetDimPk(si, "E_ARMY"), iEntityID, False)(0).Name
						If Not 	lsListOfParents.Contains(sParentFC) Then lsListOfParents.Add(sParentFC)						
					Next	
					
					Dim lsListOfLockedSubCmds As New List(Of String)
	
					'----- is parent locked -----
					For Each sFC As String In lsListOfParents
						
						Dim sIndTargetMbrScript As String = "Cb#" & wfCube & ":E#" & sFC & "_General:C#Local:S#" & wfScenario & ":T#" & wfYear & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
						Dim dIndValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, sIndTargetMbrScript).DataCellEx.DataCellAnnotation
						If dIndValue = "Yes" Then lsListOfLockedSubCmds.Add(sFC)
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRapi.ErrorLog.LogMessage(si, "sFC=" & sFC & "   dIndValue=" & dIndValue)
					Next
					
					'----- is child locked -----
					For Each sFC As String In lsEnitiesInTable
						
						Dim sIndTargetMbrScript As String = "Cb#" & wfCube & ":E#" & sFC & ":C#Local:S#" & wfScenario & ":T#" & wfYear & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
						Dim dIndValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, sIndTargetMbrScript).DataCellEx.DataCellAnnotation
						If dIndValue = "Yes" Then lsListOfLockedSubCmds.Add(sFC)
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRapi.ErrorLog.LogMessage(si, "sFC=" & sFC & "   dIndValue=" & dIndValue)
					Next
					
					If lsListOfLockedSubCmds.Count > 0 Then
						Throw New System.Exception("WARNING: following funds center(s) in the load file are locked - " & String.Join(vbCrLF ,lsListOfLockedSubCmds) )
					End If
				
#End Region
'====================================================================================================================================


				If isFileValid Then

'====================================================================================================================================
#Region "loop thru table rows and sum amounts and append comments for same key4"	

					Dim SQL_GetRows As String = "SELECT * FROM XFC_TGTDST_Import WHERE ACOM='" & sACOM_FundCenter & "' and Scenario='" & wfScenario & "' And FiscalYear='" & wfTime & "' And UserName = '" & si.UserName & "' ORDER BY FundCenter, FundCode, MDEP, APE_PT;"
'brapi.ErrorLog.LogMessage(si,"sql=" & SQL_GetRows)
					Dim dictCY_Amt As New Dictionary(Of String, Long)

					Dim dtTableRows As DataTable
		
					Using dbConn As DbConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
			 			dtTableRows = BRApi.Database.ExecuteSql(dbConn,SQL_GetRows,True)
					End Using
								
						For Each drAggRow As DataRow In dtTableRows.Rows
							Dim sRow_Scenario As String = drAggRow("Scenario")
							Dim sRow_FiscalYear As String = drAggRow("FiscalYear")
							Dim sRow_Fundcenter As String = drAggRow("Fundcenter")
							Dim sRow_FundCode As String = drAggRow("FundCode")
							Dim sRow_MDEP As String = drAggRow("MDEP")
							Dim sRow_APE_PT As String = drAggRow("APE_PT")
							Dim iRow_CY_Amt As Long = drAggRow("Amount")

							Dim sRow_Account As String = ""
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "sRow_Fundcenter=" & sRow_Fundcenter)					
							If sRow_Fundcenter.XFContainsIgnoreCase("_General") Then 
								sRow_Account = "Distr_Target_General"
							
								Dim sKey As String = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M12:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, sKey & "   CY_Amt=" & iRow_CY_Amt & "   CY_Com=" & sRow_CY_Com & "   NY_Amt=" & iRow_NY_Amt  & "   NY_Com=" & sRow_NY_Com)					
						
								If dictCY_Amt.ContainsKey(sKey) Then
									dictCY_Amt(sKey) += iRow_CY_Amt 
								Else
									dictCY_Amt.Add(sKey, iRow_CY_Amt)
								End If
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "Key=" & sKey & "   CY_Amt=" & dictCY_Amt(sKey4) & "   CY_Com=" & dictCY_Com(sKey4) & "   NY_Amt=" & dictNY_Amt(sKey4) & "   NY_Com=" & dictNY_Com(sKey4) )

								sKey = sKey.Replace("Distr_Target_General", "Ctrl_Target_In")
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, sKey & "   CY_Amt=" & iRow_CY_Amt & "   CY_Com=" & sRow_CY_Com & "   NY_Amt=" & iRow_NY_Amt  & "   NY_Com=" & sRow_NY_Com)					
						
								If dictCY_Amt.ContainsKey(sKey) Then
									dictCY_Amt(sKey) += iRow_CY_Amt 
								
								Else
									dictCY_Amt.Add(sKey, iRow_CY_Amt)
								
								End If
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "Key=" & sKey & "   CY_Amt=" & dictCY_Amt(sKey4) & "   CY_Com=" & dictCY_Com(sKey4) & "   NY_Amt=" & dictNY_Amt(sKey4) & "   NY_Com=" & dictNY_Com(sKey4) )
					
							Else
								
								sRow_Account = "Distr_Target"
							
								Dim sKey As String = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M12:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, sKey & "   CY_Amt=" & iRow_CY_Amt & "   CY_Com=" & sRow_CY_Com & "   NY_Amt=" & iRow_NY_Amt  & "   NY_Com=" & sRow_NY_Com)					
						
								If dictCY_Amt.ContainsKey(sKey) Then
									dictCY_Amt(sKey) += iRow_CY_Amt 
								Else
									dictCY_Amt.Add(sKey, iRow_CY_Amt)
								End If
								
								
							End If	
							
						Next	'loop table rows

				
#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "loop thru dictionaries and load cube"	

					Dim objListofLoadAmountScripts As New List(Of MemberScriptandValue)

					For Each kvp As KeyValuePair(Of String, Long) In dictCY_Amt
						Dim sKey As String = kvp.Key
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "sKey=" & sKey)

'------------------------------------------------------------------------------
#Region "load amounts to cube"

						Dim sDataBufferPOVScript_Amt As String = "Cb#" & sACOM & ":C#USD:V#Periodic:I#None:F#Baseline:O#Forms:U4#None:U5#None:U6#None:U7#None:U8#None:" & sKey

						
						Dim sCY_Amt_Script As String = sDataBufferPOVScript_Amt
						Dim iCY_Amt As Long = dictCY_Amt(sKey)
						
						Select Case True
							Case iCY_Amt = 0 
								'----- clear data -----
							    Dim msvCY_Amt_ScriptVal As New MemberScriptAndValue
								msvCY_Amt_ScriptVal.CubeName = wfcube
								msvCY_Amt_ScriptVal.Script = sCY_Amt_Script
								msvCY_Amt_ScriptVal.Amount = 0
								msvCY_Amt_ScriptVal.IsNoData = True
								objListofLoadAmountScripts.Add(msvCY_Amt_ScriptVal)

							Case Else
								'----- load amount -----
								
							    Dim msvCY_Amt_ScriptVal As New MemberScriptAndValue
								msvCY_Amt_ScriptVal.CubeName = wfcube
								msvCY_Amt_ScriptVal.Script = sCY_Amt_Script
								msvCY_Amt_ScriptVal.Amount = iCY_Amt
								msvCY_Amt_ScriptVal.IsNoData = False
								objListofLoadAmountScripts.Add(msvCY_Amt_ScriptVal)
						End Select
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then Brapi.ErrorLog.LogMessage(si, "sCY_Amt_Script=" & sCY_Amt_Script & "   iCY_Amt=" & iCY_Amt)
					
					
#End Region
'------------------------------------------------------------------------------

					Next	'loop dictionary	
'BRApi.ErrorLog.LogMessage(si, "Updated " & objListofLoadAmountScripts.count & " cells out of " & (dictCY_Amt.Count + dictCY_Com.Count + dictNY_Amt.Count + dictNY_Com.Count).ToString)
					
					objResult = BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofLoadAmountScripts)
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then Brapi.ErrorLog.LogMessage(si, "objResult=" & objResult.Message)


'!!!!! DVLP NOTE: this code can replaces load cube above and is faster - needs more testing before implementing !!!!!
'					'---------- run data mgmt sequence ----------
'					Dim sEntityList2 As String = ""
'					For Each MbrInfo As MemberInfo In objMemberInfos_InputMbrs
'						If sEntityList2 = "" Then
'							sEntityList2 = "E#" & MbrInfo.Member.Name 
'						Else
'							sEntityList2 &= ", E#" & MbrInfo.Member.Name 
'						End If
'					Next

'					Dim params2 As New Dictionary(Of String, String) 
'					params2.Add("EntityList", sEntityList2)
'					'params2.Add("EntityList", "E#A97AB, E#A97AC")
					
'					'!!!!!DVLP NOTE: this is a synchronous call so it returns after job is done !!!!!
'					Dim objTAI2 As TaskActivityItem =  BRApi.Utilities.ExecuteDataMgmtSequence(si, "Load_Targets_To_Cube", params2)

'					'system.Threading.Thread.Sleep(500)
'					Dim objTaskActivityItem2 As TaskActivityItem = BRApi.TaskActivity.GetTaskActivityItem(si, objTAI2.UniqueID)
'					If objTaskActivityItem2.HasError Then
'						Throw New System.Exception("ERROR: Data Management Job = Load_Targets_To_Cube failed.  Please check activity log for more details.")
'					End If

#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "Consolidate"	

					'---------- run data mgmt sequence ----------
					Dim sEntityList3 As String = ""
					Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")

					For Each sUserFC As String In lsUserFundCenters
						If sEntityList3 = "" Then
							sEntityList3 = "E#" & sUserFC
						Else
							sEntityList3 &= ", E#" & sUserFC
						End If
					Next
'brapi.ErrorLog.LogMessage(si,"Entitylist = " & sEntityList3)
					
					Dim params3 As New Dictionary(Of String, String) 
					params3.Add("EntityList", sEntityList3)


					'!!!!!DVLP NOTE: this is a synchronous call so it returns after job is done !!!!!
					Dim objTAI3 As TaskActivityItem =  BRApi.Utilities.ExecuteDataMgmtSequence(si, gValue, "ConsolidateTargets", params3)

					'system.Threading.Thread.Sleep(500)
					Dim objTaskActivityItem3 As TaskActivityItem = BRApi.TaskActivity.GetTaskActivityItem(si, objTAI3.UniqueID)
					If objTaskActivityItem3.HasError Then
						Throw New System.Exception("ERROR: Data Management Job = ConsolidateTargets failed.  Please check activity log for more details.")
					End If					
					
			
#End Region 
'====================================================================================================================================


				End If	'isfilevalid
				
'====================================================================================================================================
#Region "staus messages"	

				'If the validation failed, write the error out.
				'If there are more than ten, we show only the first ten messages for the sake of redablity
				Dim sPasstimespent As System.TimeSpan = Now.Subtract(timestart)
				If Not isFileValid Then
					Dim sErrorLog As String = ""
					For Each CurrRow In lsSpendPlanRecords
						sErrorLog = sErrorLog & vbCrLf & CurrRow.StringOutput()
					Next
					'Throw New XFUserMsgException(si, New Exception("LOAD FAILED" & vbCrLf & filePath & " has invalid data." & vbCrLf & vbCrLf & "Please review stage table to view errors."))
					Dim sCompletionMessageFail As String = "IMPORT FAILED" & vbCrLf _
										& "File Name: " & objXFFileInfo.Name & vbCrLf _
										& "User Name: " & si.UserName & vbCrLf _ 
										& "Time Start: " & timeStart & vbCrLf _ 
										& "Time Ended: " & System.DateTime.Now & vbCrLf _ 
										& "Total seconds for import: " & sPasstimespent.TotalSeconds & "." & vbCrLf _
										& "Number of rows processed: " & lines.count & vbCrLf _
										& vbCrLf & "File Contents:" & vbCrLf _
										& sErrorLog

					Me.TargetsImportFileHelper(si, globals, api, args, sCompletionMessageFail, "FAIL", objXFFileInfo.Name)
					
					Dim stastusMsg As String = "LOAD FAILED" & vbCrLf & objXFFileInfo.Name & " has invalid data." & vbCrLf & vbCrLf & $"To view import error(s), scroll right to the column titled ""ValidationError""."
					BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", stastusMsg)
					Return Nothing
				End If
				
				'File load complete. Write file to explorer
				Dim timespent As System.TimeSpan = Now.Subtract(timestart)
	'			Dim sCompletionMessage As String = "IMPORT PASSED" & vbCrLf _
	'												& "seconds for import to complete: " & timespent.TotalSeconds & "." & vbCrLf _
	'												& "Number of rows minus header row: " & lines.count - 1 & vbCrLf _
	'												& "Records Loaded: " & iLineCount & vbcrlf 
				Dim sCompletionMessagePass As String = "IMPORT PASSED" & vbCrLf _
													& "File Name: " & objXFFileInfo.Name & vbCrLf _
													& "User Name: " & si.UserName & vbCrLf _ 
													& "Time Start: " & timeStart & vbCrLf _ 
													& "Time Ended: " & System.DateTime.Now & vbCrLf _ 
													& "Total seconds for import: " & sPasstimespent.TotalSeconds & "." & vbCrLf _
													& "Number of rows processed: " & lines.count & vbCrLf 
													'& vbCrLf & "File Contents:" & vbCrLf _
													'& sErrorLog

				Me.TargetsImportFileHelper(si, globals, api, args, sCompletionMessagePass, "PASS", objXFFileInfo.Name)
				'Throw New Exception("IMPORT PASSED" & vbCrLf & "Output file is located in the following folder for review:" & vbCrLf & "DOCUMENTS/USERS/" & si.UserName.ToUpper)
				Dim uploadStatus As String = "IMPORT PASSED" & vbCrLf & "Output file is located in the following folder for review:" & vbCrLf & "DOCUMENTS/USERS/" & si.UserName.ToUpper
				BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", uploadStatus)
		
#End Region 
'====================================================================================================================================

				Return Nothing
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try					
		End Function	
		
#End Region
'===========================================================================
#Region "Withhold Import File Helper"	
'----------Created to Output log files for REQ Imports----------
		Public Function WithholdsImportFileHelper(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs, ByVal sErrorMsg As String, ByVal sTitle As String, Optional ByVal fName As String = "") 
		
			Dim sUser As String = si.UserName
			Dim sTimeStamp As String = datetime.Now.ToString.Replace("/","").Replace(":","").Replace(" ","_")
			Dim file As New Text.StringBuilder
			
			file.Append(sErrorMsg)
			
			Dim sfileName As String = sTitle & "_" & sUser & "_" & sTimeStamp & "_" & fName
			'Pass text to bytes
			Dim fileBytes As Byte() = Encoding.UTF8.GetBytes(file.ToString)
							
			'Define folder to hold file
			Dim sUserFolderPath As String = "Documents/Users/" & sUser
			Dim sAdminFolderPath As String = "Documents/Public/Admin/Targets/Batch_Upload_Error_Log"
			
			Dim objXFFolderExUser As XFFolderEx = BRApi.FileSystem.GetFolder(si, FileSystemLocation.ApplicationDatabase, sUserFolderPath)							
			Dim objXFFileInfoUser = New XFFileInfo(FileSystemLocation.ApplicationDatabase, String.Concat(sUserFolderPath, "/", sFileName))
			Dim objXFFileUser As New XFFile(objXFFileInfoUser,String.Empty,fileBytes)
			
			Dim objXFFolderExAdmin As XFFolderEx = BRApi.FileSystem.GetFolder(si, FileSystemLocation.ApplicationDatabase, sAdminFolderPath)							
			Dim objXFFileInfoAdmin = New XFFileInfo(FileSystemLocation.ApplicationDatabase, String.Concat(sAdminFolderPath, "/", sFileName))
			Dim objXFFileAdmin As New XFFile(objXFFileInfoAdmin,String.Empty,fileBytes)

			'Load User file
			BRApi.FileSystem.InsertOrUpdateFile(si, objXFFileUser)
			BRApi.FileSystem.InsertOrUpdateFile(si, objXFFileAdmin)
			
			Return Nothing
			
		End Function
#End Region
'===========================================================================
#Region "TGTDST_WTHTIMP_LoadFile"
		'---------------------------------------------------------------------------------------------------
		' Created: 2025-Feb-20 - AK
		'
		' Purpose: 
		'
		' Invocation: MAIN() args.FunctionName.XFEqualsIgnoreCase("TGTDST_TGTIMP_LoadFile")
		'
		' Usage Instructions from a component:
		'	{TGTDST_SolutionHelper}{TGTDST_TGTIMP_LoadFile}{Caller=TGTDST_Import, FilePath = |!FilePath!|}
		'
		'	Where:
		'		FilePath= is a string of the dimensions you want returned
		'
		'
		' Usage Instructions from a rule:
		'	Set reference assemblies = BR\TGTDST_SolutionHelper
		'	add code Private TGTDST_SolutionHelper As New OneStream.BusinessRule.DashboardExtender.TGTDST_SolutionHelper.MainClass
		'	add to rule: 
		'			Dim de_args as new DashboardExtenderArgs
		'			de_args.NameValuePairs.XFSetValue("FilePath", "xxxx")
		'			TGTDST_SolutionHelper.TGTDST_TGTIMP_LoadFile(si, globals, nothing, de_args)
		'
		'
		'Modifications:
		'
		'---------------------------------------------------------------------------------------------------

		Public Function	TGTDST_WTHIMP_LoadFile(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As Object
			Try

'========== debug vars ===================================
Dim tStart As DateTime =  Date.Now()	
Dim sDebugRuleName As String = "TGTDST_SolutionHelper"
Dim sDebugFuncName As String = "TGTDST_WTHIMP_LoadFile"
Dim sCaller As String = args.NameValuePairs.XFGetValue("Caller")
'=========================================================


'====================================================================================================================================
#Region "init module vars"			
				Dim timeStart As DateTime = System.DateTime.Now
			
				Dim wfCube = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
				Dim wfScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
				Dim wfTime As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
				Dim wfYear As Integer = CInt(BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey))
				
				'----- ACOM transformations -----
				Dim sACOM As String  = BRApi.Finance.Metadata.GetMember(si, dimTypeId.Entity, wfCube).Member.name
				If BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0).XFEqualsIgnoreCase("USAREUR") Then
					sACOM = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0) & "_AF"
				Else 
					sACOM = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name.Split(" ")(0)
				End If
				Dim sACOM_FundCenter As String = BRApi.Finance.Entity.Text(si, BRApi.Finance.Members.GetMemberId(si, dimTypeId.Entity, sACOM), 1, 0, 0)	

				'---get user fund centers for target distribution--
				Dim dt As DataTable = Me.GetUserFundCentersByWF(si, globals, api, args)
				Dim oUserFundCenters As New List(Of String)
				For Each row As DataRow In dt.Rows
					oUserFundCenters.Add(row("Value").Replace("_General",""))
					Dim objMemberInfos As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si,"E_" & wfCube,"E#" & row("Value").Replace("_General","") & ".Children.Where(Name DoesNotContain _FC)",True)
					For Each item As MemberInfo In objMemberInfos
						oUserFundCenters.Add(item.Member.Name)
					Next				
				Next
				
				Dim saUserFundCenters() As String = oUserFundCenters.ToArray()
				
'				Dim objSignedOnUser As UserInfo = BRApi.Security.Authorization.GetUser(si, si.AuthToken.UserName)
'				Dim sUserName As String = objSignedOnUser.User.Name
'				Dim sUserDesc As String = objSignedOnUser.User.Description
'				Dim text2 As String = objSignedOnUser.User.Text2
'				Dim sUserFundCenters As String = ""
'				If ((Not String.IsNullOrWhiteSpace(text2)) And text2.XFContainsIgnoreCase("TGTFundCenters") ) Then 
'					text2 = text2.Replace(" ", "")
'					Dim subStart As Integer = text2.IndexOf("TGTFundCenters=[") + 16
'					Dim subEnd As Integer = text2.IndexOf("]",text2.IndexOf("TGTFundCenters=[")) - subStart
'					sUserFundCenters = text2.Substring(subStart, subEnd)
'				End If
'				Dim saUserFundCenters() As String = sUserFundCenters.Split(",")
				
				'---- adjust list per workflow ----
				Dim lsUserFundCenters As New List(Of String)
				Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
				If wfProfileName.XFContainsIgnoreCase("CMD") Then
				
					'----- check if ACOM is locked -----
					Dim sIndTargetMbrScript As String = "Cb#" & wfCube & ":E#" & sACOM_FundCenter & "_General:C#Local:S#" & wfScenario & ":T#" & wfYear & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim dIndValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, sIndTargetMbrScript).DataCellEx.DataCellAnnotation
					If dIndValue = "Yes" Then
						Throw New System.Exception("WARNING: " & sACOM_FundCenter & " is locked")
					End If
					lsUserFundCenters.Add(sACOM_FundCenter)
'For Each FC As String In lsUserFundCenters
'brapi.ErrorLog.LogMessage(si, fc)
'Next
				Else
					
					'----- check if user has access to SubCmds -----
					For Each sUserFC As String In saUserFundCenters
						If Not sUserFC.XFEqualsIgnoreCase(sACOM_FundCenter) And sUserFC.XFContainsIgnoreCase(sACOM_FundCenter) Then lsUserFundCenters.Add(sUserFC)
					Next	
					If lsUserFundCenters.Count = 0 Then
						Throw New System.Exception("WARNING: User does not hava access to any sub cmds")
					End If
					
				End If
				
				
				Dim objResult As XFResult

#End Region 
'====================================================================================================================================

'====================================================================================================================================
#Region "read file"	

				'---------- Confirm source file path exists ----------
				Dim filePath As String = args.NameValuePairs.XFGetValue("FilePath")
				Dim objXFFileInfo = New XFFileInfo(FileSystemLocation.ApplicationDatabase, filePath)
				If objXFFileInfo Is Nothing
					Me.WithholdsImportFileHelper(si, globals, api, args, "File " & objXFFileInfo.Name & " does NOT exist", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(String.Concat("File " & objXFFileInfo.Name & " does NOT exist")))
				End If
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then brapi.ErrorLog.LogMessage(si, sDebugRuleName & "." & sDebugFuncName & "-" & sCaller & ":   FolderPath: " & filePath & ", Name: " & objXFFileInfo.Name)


				'---------- Confirm source file is readable ----------
				Dim objXFFileEx As XFFileEx = BRApi.FileSystem.GetFile(si, objXFFileInfo.FileSystemLocation, objXFFileInfo.FullName, True, True)
				If objXFFileEx Is Nothing
					Me.WithholdsImportFileHelper(si, globals, api, args, "Unable to open file " & objXFFileInfo.Name, "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(String.Concat( "Unable to open file " & objXFFileInfo.Name)))
				End If

				'---------- read file ----------
				'DVLP NOTE: If the file is too large check here for performance issue. Maybe a file streamer to read a line at a time may be better
				Dim sFileText As String = system.Text.Encoding.ASCII.GetString(objXFFileEX.XFFile.ContentFileBytes)
				
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then brapi.ErrorLog.LogMessage(si, sDebugRuleName & "." & sDebugFuncName & "-" & sCaller & ":   Size=" & sFileText.Length)				
				
#End Region 
'====================================================================================================================================

'====================================================================================================================================
#Region "remove invalid chars"	
			
				'----------Clean up CRLF from the file ----------

				Dim patt As String = "(" & vbCrLf & "|" & vbLf & ")(?!" & sACOM_FundCenter & ")"'(?=[a-zA-Z0-9,""@!#$%'()+=-_.:<>?~^]*)" '-- Include what is in the brackt
				Dim cleanedText As String = Regex.Replace(sFileText,patt,"  ")
				
				Dim patt2 As String = "[^a-zA-Z0-9,""@!#$%'()+=_.:<>?~\-\[\]\*\^\\\/" & vbcrlf & vbLf & "]"
				cleanedText = Regex.Replace(cleanedText,patt2," ")
				
				'this handles ZWSP's that get brought in as "???" and ignored by the second pass as question marks are allowed
				Dim patt3 As String = "???"
				cleanedText = cleanedText.Replace(patt3," ")	
				
				'Alternate method not being used
	'			'Looping through Ascii Table for character 
	'				'*2-4-25 requested By Paul Burke To replace special Char. Discovered during testing In Stage, By product owners
	'				For  i As Integer = 1 To 127
	'				Select Case i
	'				Case 48 <= i <= 57 '0-9
	'					'Do Nothing
	'				Case 65 <= i <= 95 'ABC
	'					'Do Nothing
	'				Case 97 <= i <= 126 'abc
	'					'Do Nothing	
	'				Case 32,34,35,36,37,39,40,41,42,43,44,45,46,47,58
	'					'Do Nothing	
	'				Case Else	
	'					line = line.Replace(chr(i)," ")
	'				End Select


				'***********Split will need to be replace with alternate solution to handle CRLF issue*******
				Dim lines As String() = cleanedText.Split(vbCRLF) 
				
				If lines.Count < 1 Then 
					Me.WithholdsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " is empty", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " is empty"))
				End If
				
				'For performance we are capping the upload file to not more than 5000
				If lines.Count > 5001 Then 
					Me.WithholdsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " is too large. Please upload a file not more than 5000 rows", "FAIL", objXFFileInfo.Name)
					Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " is too large. Please upload a file not more than 5000 rows"))
				End If

#End Region 
'====================================================================================================================================
		
'====================================================================================================================================
#Region "clear table"	

				'----------clear ACOM from table ----------
				Dim SQLClearRows As String = "Delete from XFC_WTHDST_Import Where ACOM = '" & sACOM_FundCenter & "' and Scenario = '" & wfScenario & "' And FiscalYear = '" & wfTime & "' And UserName = '" & si.UserName & "'"
				
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si,"SQLClearRows = " & SQLClearRows)

				Using dbConnApp As DBConnInfo = BRAPi.Database.CreateApplicationDbConnInfo(si)
					BRAPi.Database.ExecuteActionQuery(dbConnApp, SQLClearRows.ToString, False, True)
				End Using
					
#End Region 
'====================================================================================================================================

'====================================================================================================================================
#Region "loop thru lines and validate"	
	
				Dim firstLine As Boolean = True
				'Dim currentUsedFlows As List(Of String) = New List(Of String)
				Dim lsWithholdRecords As List (Of WithholdRecord) = New List (Of WithholdRecord)
				Dim isFileValid As Boolean = True
				Dim iLineCount As Integer = 0
				
				'Loop through each line and process
				For Each line As String In lines
					iLineCount += 1
					
'------------------------------------------------------------------------------
#Region "Parse file"

					'Skip empty line
					If String.IsNullOrWhiteSpace(line) Then
						Continue For
					End If

					'If there are back to back (escaped) double quotes, they will be replaced with single quotes.
					'This is done becasue "s are used as column separator in csv files and "s inside would be represented as escaped quotes ("")
					line = line.Replace("""""", "'")

'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "Line : " & line)
					'Use reg expressions to split the csv.
					'The expression accounts for commas that are with in "" to treat them as data.
					Dim pattern As String = ",(?=(?:[^""]*""[^""]*"")*[^""]*$)"
					Dim fields As String () = Regex.Split(line, pattern)
					
					'Check number of column and skip first line
					If firstLine Then
						'There needs to be 9 columns
						Dim sValidNumCols As Integer = 30
						If fields.Length <> sValidNumCols Then
							Me.WithholdsImportFileHelper(si, globals, api, args, objXFFileInfo.Name & " has invalid structure at line #" & iLineCount & ". Please check the file if its in the correct format. Expected number of columns is " & sValidNumCols & ", number columns in file header is " & fields.Length & vbCrLf & line, "FAIL", objXFFileInfo.Name)
							Throw New XFUserMsgException(si, New Exception(objXFFileInfo.Name & " has invalid structure at line #" & iLineCount & ". Please check the file if its in the correct format. Expected number of columns is " & sValidNumCols & ", number columns in file header is "& fields.Length & vbCrLf & line ))
						End If
						
						firstLine = False
						Continue For
					End If
				
					'----- The parsed fields are stored in the class. If new column is introduced, it needs to be added to the REQ class object as well -----
					Dim CurrRow As WithholdRecord = New WithholdRecord
					'Trim any unprintable character and surrounding quotes

					CurrRow.ACOM = fields(0).Trim().Trim("""")
					'CurrRow.Scenario is derived 
					CurrRow.FiscalYear = fields(1).Trim().Trim("""")
					CurrRow.FundCenter = fields(2).Trim().Trim("""")
					CurrRow.FundCode = fields(3).Trim().Trim("""")
					CurrRow.MDEP = fields(4).Trim().Trim("""")
					CurrRow.APE_PT = fields(5).Trim().Trim("""")
					CurrRow.OBL_CY_M1_Amt = fields(6).Trim().Trim("""")
					CurrRow.OBL_CY_M2_Amt = fields(7).Trim().Trim("""")
					CurrRow.OBL_CY_M3_Amt = fields(8).Trim().Trim("""")
					CurrRow.OBL_CY_M4_Amt = fields(9).Trim().Trim("""")
					CurrRow.OBL_CY_M5_Amt = fields(10).Trim().Trim("""")
					CurrRow.OBL_CY_M6_Amt = fields(11).Trim().Trim("""")
					CurrRow.OBL_CY_M7_Amt = fields(12).Trim().Trim("""")
					CurrRow.OBL_CY_M8_Amt = fields(13).Trim().Trim("""")
					CurrRow.OBL_CY_M9_Amt = fields(14).Trim().Trim("""")
					CurrRow.OBL_CY_M10_Amt = fields(15).Trim().Trim("""")
					CurrRow.OBL_CY_M11_Amt = fields(16).Trim().Trim("""")
					CurrRow.OBL_CY_M12_Amt = fields(17).Trim().Trim("""")
					'CurrRow.OBL_NY_M12_Amt = fields(18).Trim().Trim("""")
					CurrRow.COM_CY_M1_Amt = fields(18).Trim().Trim("""")
					CurrRow.COM_CY_M2_Amt = fields(19).Trim().Trim("""")
					CurrRow.COM_CY_M3_Amt = fields(20).Trim().Trim("""")
					CurrRow.COM_CY_M4_Amt = fields(21).Trim().Trim("""")
					CurrRow.COM_CY_M5_Amt = fields(22).Trim().Trim("""")
					CurrRow.COM_CY_M6_Amt = fields(23).Trim().Trim("""")
					CurrRow.COM_CY_M7_Amt = fields(24).Trim().Trim("""")
					CurrRow.COM_CY_M8_Amt = fields(25).Trim().Trim("""")
					CurrRow.COM_CY_M9_Amt = fields(26).Trim().Trim("""")
					CurrRow.COM_CY_M10_Amt = fields(27).Trim().Trim("""")
					CurrRow.COM_CY_M11_Amt = fields(28).Trim().Trim("""")
					CurrRow.COM_CY_M12_Amt = fields(29).Trim().Trim("""")
					'CurrRow.COM_NY_M12_Amt = fields(30).Trim().Trim("""")					

					
					If CurrRow.OBL_CY_M1_Amt = "" Then CurrRow.OBL_CY_M1_Amt = "0"
					If CurrRow.OBL_CY_M2_Amt = "" Then CurrRow.OBL_CY_M2_Amt = "0"
					If CurrRow.OBL_CY_M3_Amt = "" Then CurrRow.OBL_CY_M3_Amt = "0"
					If CurrRow.OBL_CY_M4_Amt = "" Then CurrRow.OBL_CY_M4_Amt = "0"
					If CurrRow.OBL_CY_M5_Amt = "" Then CurrRow.OBL_CY_M5_Amt = "0"
					If CurrRow.OBL_CY_M6_Amt = "" Then CurrRow.OBL_CY_M6_Amt = "0"
					If CurrRow.OBL_CY_M7_Amt = "" Then CurrRow.OBL_CY_M7_Amt = "0"
					If CurrRow.OBL_CY_M8_Amt = "" Then CurrRow.OBL_CY_M8_Amt = "0"
					If CurrRow.OBL_CY_M9_Amt = "" Then CurrRow.OBL_CY_M9_Amt = "0"
					If CurrRow.OBL_CY_M10_Amt = "" Then CurrRow.OBL_CY_M10_Amt = "0"
					If CurrRow.OBL_CY_M11_Amt = "" Then CurrRow.OBL_CY_M11_Amt = "0"
					If CurrRow.OBL_CY_M12_Amt = "" Then CurrRow.OBL_CY_M12_Amt = "0"
					If CurrRow.COM_CY_M1_Amt = "" Then CurrRow.COM_CY_M1_Amt = "0"
					If CurrRow.COM_CY_M2_Amt = "" Then CurrRow.COM_CY_M2_Amt = "0"
					If CurrRow.COM_CY_M3_Amt = "" Then CurrRow.COM_CY_M3_Amt = "0"
					If CurrRow.COM_CY_M4_Amt = "" Then CurrRow.COM_CY_M4_Amt = "0"
					If CurrRow.COM_CY_M5_Amt = "" Then CurrRow.COM_CY_M5_Amt = "0"
					If CurrRow.COM_CY_M6_Amt = "" Then CurrRow.COM_CY_M6_Amt = "0"
					If CurrRow.COM_CY_M7_Amt = "" Then CurrRow.COM_CY_M7_Amt = "0"
					If CurrRow.COM_CY_M8_Amt = "" Then CurrRow.COM_CY_M8_Amt = "0"
					If CurrRow.COM_CY_M9_Amt = "" Then CurrRow.COM_CY_M9_Amt = "0"
					If CurrRow.COM_CY_M10_Amt = "" Then CurrRow.COM_CY_M10_Amt = "0"
					If CurrRow.COM_CY_M11_Amt = "" Then CurrRow.COM_CY_M11_Amt = "0"
					If CurrRow.COM_CY_M12_Amt = "" Then CurrRow.COM_CY_M12_Amt = "0"

						
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then brapi.ErrorLog.LogMessage(si, sDebugRuleName & "." & sDebugFuncName & "-" & sCaller & ":   Record=" & CurrRow.StringOutput)				

					'----- confirm WF ACOM fundcenter matches ACOM fundcenter in file -----
					If Not currRow.ACOM.XFEqualsIgnoreCase(sACOM_FundCenter) Then
						Me.WithholdsImportFileHelper(si, globals, api, args, "ACOM=" & currRow.ACOM & " in the file does not match the ACOM = " & sACOM_FundCenter & " of the workflow", objXFFileInfo.Name)
						Throw New XFUserMsgException(si, New Exception("ACOM=" & currRow.ACOM & " in the file does not match the ACOM = " & sACOM_FundCenter & " of the workflow"))					
					End If	
					
					'----- If fundcenter is a parent, add _General -----
					Dim objDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & sACOM)
					Dim membList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "E#" & currRow.FundCenter & ".base", True)
					If membList.Count > 1 Then
						currRow.FundCenter = currRow.FundCenter & "_General"
					End If
					
					'----- assign WF scenario to REQ -----
					currRow.Scenario = wfScenario
					
					'----- confirm WF year matches year in file -----
					If currRow.FiscalYear <> wfTime Then
						Me.WithholdsImportFileHelper(si, globals, api, args, "Fiscal year=" & currRow.FiscalYear & " in the file does not match the fiscal year = " & wfTime & " of the workflow", objXFFileInfo.Name)
						Throw New XFUserMsgException(si, New Exception("Fiscal year=" & currRow.FiscalYear & " in the file does not match the fiscal year = " & wfTime & " of the workflow"))					
					End If
					
#Region "U3 APPN  grabber "					
					'====== Get APPN_FUND And PARENT APPN_L2 ======
					Dim U1Name As String = CurrRow.FundCode					
					Dim U1DimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN_FUND")
					Dim U1MemberID As Integer = BRApi.Finance.Members.GetMemberId(si,dimType.UD1.Id, U1Name)
					Dim U1ParentName As String = BRApi.Finance.Members.GetParents(si,U1DimPk, U1MemberId, False, )(0).Name 				
				

					'====== GET BA Parent for APEPT ======
					Dim U3Name As String = CurrRow.APE_PT
					Dim U3objDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U3_APE_PT")
					Dim U3memSearch As String = "U3#APPN.BASE.Where(Name Contains " & U3Name & " And  Name Contains " & U1ParentName & " )"
					Dim U3membList As List(Of Memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, U3objDimPk ,U3memSearch ,True)

					' check if 0 for  U3membList
					If U3membList.Count = 0 Then
							Throw New XFUserMsgException(si, New Exception("Error: Invalid APE value: " & CurrRow.APE_PT & " does Not exist"))
					End If
					
					Dim U3Member As String  = U3membList.Item(0).Member.Name	
					CurrRow.APE_PT = U3Member
					
					
'================================================================================================						
#End Region						
				
#End Region
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
#Region "Validate members"
	
					CurrRow.valid = True
					Dim sValidationError As String = ""
					
					'----- Check if ACOM is valid -----
					objDimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "E#" & CurrRow.ACOM , True)
					If (membList.Count <> 1 ) Then 
						Throw New XFUserMsgException(si, New Exception("ERROR: invalid ACOM:" & CurrRow.ACOM & " does not exist"))
					End If
					
					'----- VCheck if fiscal year is valid -----
					objDimPk = DimPk.TimeDimPk
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "T#" & CurrRow.FiscalYear, True)
					If (membList.Count <> 1 ) Then 
						Throw New XFUserMsgException(si, New Exception("ERROR: invalid Currenct Year:" & CurrRow.FiscalYear & " does not exist"))
					End If

'--------------------------------------------------------------------------
#Region "Test if OBL amount is numeric "

					
					'-----Check if amount is numeric -----
					If Not isnumeric(CurrRow.OBL_CY_M1_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M1 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M1_Amt
						CurrRow.OBL_CY_M1_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M2_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M2 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M2_Amt
						CurrRow.OBL_CY_M2_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M3_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M3 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M3_Amt
						CurrRow.OBL_CY_M3_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M4_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M4 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M4_Amt
						CurrRow.OBL_CY_M4_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M5_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M5 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M5_Amt
						CurrRow.OBL_CY_M5_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M6_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M6 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M6_Amt
						CurrRow.OBL_CY_M6_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M7_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M7 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M7_Amt
						CurrRow.OBL_CY_M7_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M8_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M8 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M8_Amt
						CurrRow.OBL_CY_M8_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M9_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M9 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M9_Amt
						CurrRow.OBL_CY_M9_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M10_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M10 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M10_Amt
						CurrRow.OBL_CY_M10_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M11_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M11 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M11_Amt
						CurrRow.OBL_CY_M11_Amt = 0
					End If
					If Not isnumeric(CurrRow.OBL_CY_M12_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M12 amount contains nun-numeric. Amount="& CurrRow.OBL_CY_M12_Amt
						CurrRow.OBL_CY_M12_Amt = 0
					End If

					
#End Region
'--------------------------------------------------------------------------

'--------------------------------------------------------------------------
#Region "Test if COM amount is numeric"
				
					
					If Not isnumeric(CurrRow.COM_CY_M1_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M1 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M1_Amt
						CurrRow.COM_CY_M1_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M2_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M2 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M2_Amt
						CurrRow.COM_CY_M2_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M3_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M3 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M3_Amt
						CurrRow.COM_CY_M3_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M4_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M4 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M4_Amt
						CurrRow.COM_CY_M4_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M5_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M5 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M5_Amt
						CurrRow.COM_CY_M5_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M6_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M6 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M6_Amt
						CurrRow.COM_CY_M6_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M7_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M7 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M7_Amt
						CurrRow.COM_CY_M7_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M8_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M8 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M8_Amt
						CurrRow.COM_CY_M8_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M9_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M9 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M9_Amt
						CurrRow.COM_CY_M9_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M10_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M10 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M10_Amt
						CurrRow.COM_CY_M10_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M11_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M11 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M11_Amt
						CurrRow.COM_CY_M11_Amt = 0
					End If
					If Not isnumeric(CurrRow.COM_CY_M12_Amt) Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M12 amount contains nun-numeric. Amount="& CurrRow.COM_CY_M12_Amt
						CurrRow.COM_CY_M12_Amt = 0
					End If
					
#End Region
'--------------------------------------------------------------------------

'--------------------------------------------------------------------------
#Region "Test if OBL amount has decimal "
										
					'-----Check if amount has decimal-----
					If CurrRow.OBL_CY_M1_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M1 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M1_Amt
						CurrRow.OBL_CY_M1_Amt = 0
					End If
					If CurrRow.OBL_CY_M2_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M2 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M2_Amt
						CurrRow.OBL_CY_M2_Amt = 0
					End If					
					If CurrRow.OBL_CY_M3_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M3 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M3_Amt
						CurrRow.OBL_CY_M3_Amt = 0
					End If
					If CurrRow.OBL_CY_M4_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M4 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M4_Amt
						CurrRow.OBL_CY_M4_Amt = 0
					End If
					If CurrRow.OBL_CY_M5_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M5 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M5_Amt
						CurrRow.OBL_CY_M5_Amt = 0
					End If
					If CurrRow.OBL_CY_M6_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M6 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M6_Amt
						CurrRow.OBL_CY_M6_Amt = 0
					End If
					If CurrRow.OBL_CY_M7_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M7 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M7_Amt
						CurrRow.OBL_CY_M7_Amt = 0
					End If
					If CurrRow.OBL_CY_M8_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M8 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M8_Amt
						CurrRow.OBL_CY_M8_Amt = 0
					End If
					If CurrRow.OBL_CY_M9_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M9 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M9_Amt
						CurrRow.OBL_CY_M9_Amt = 0
					End If
					If CurrRow.OBL_CY_M10_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M10 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M10_Amt
						CurrRow.OBL_CY_M10_Amt = 0
					End If
					If CurrRow.OBL_CY_M11_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M11 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M11_Amt
						CurrRow.OBL_CY_M11_Amt = 0
					End If
					If CurrRow.OBL_CY_M12_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY OBL M12 amount contains decimals.  Amount = " & CurrRow.OBL_CY_M12_Amt
						CurrRow.OBL_CY_M12_Amt = 0
					End If
					
#End Region
'--------------------------------------------------------------------------

'--------------------------------------------------------------------------
#Region "Test if COM amount has decimal "
					
					If CurrRow.COM_CY_M1_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M1 amount contains decimals.  Amount = " & CurrRow.COM_CY_M1_Amt
						CurrRow.COM_CY_M1_Amt = 0
					End If
					If CurrRow.COM_CY_M2_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M2 amount contains decimals.  Amount = " & CurrRow.COM_CY_M2_Amt
						CurrRow.COM_CY_M2_Amt = 0
					End If					
					If CurrRow.COM_CY_M3_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M3 amount contains decimals.  Amount = " & CurrRow.COM_CY_M3_Amt
						CurrRow.COM_CY_M3_Amt = 0
					End If
					If CurrRow.COM_CY_M4_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M4 amount contains decimals.  Amount = " & CurrRow.COM_CY_M4_Amt
						CurrRow.COM_CY_M4_Amt = 0
					End If
					If CurrRow.COM_CY_M5_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M5 amount contains decimals.  Amount = " & CurrRow.COM_CY_M5_Amt
						CurrRow.COM_CY_M5_Amt = 0
					End If
					If CurrRow.COM_CY_M6_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M6 amount contains decimals.  Amount = " & CurrRow.COM_CY_M6_Amt
						CurrRow.COM_CY_M6_Amt = 0
					End If
					If CurrRow.COM_CY_M7_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M7 amount contains decimals.  Amount = " & CurrRow.COM_CY_M7_Amt
						CurrRow.COM_CY_M7_Amt = 0
					End If
					If CurrRow.COM_CY_M8_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M8 amount contains decimals.  Amount = " & CurrRow.COM_CY_M8_Amt
						CurrRow.COM_CY_M8_Amt = 0
					End If
					If CurrRow.COM_CY_M9_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M9 amount contains decimals.  Amount = " & CurrRow.COM_CY_M9_Amt
						CurrRow.COM_CY_M9_Amt = 0
					End If
					If CurrRow.COM_CY_M10_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M10 amount contains decimals.  Amount = " & CurrRow.COM_CY_M10_Amt
						CurrRow.COM_CY_M10_Amt = 0
					End If
					If CurrRow.COM_CY_M11_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M11 amount contains decimals.  Amount = " & CurrRow.COM_CY_M11_Amt
						CurrRow.COM_CY_M11_Amt = 0
					End If
					If CurrRow.COM_CY_M12_Amt.XFContainsIgnoreCase(".") Then
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "ERROR: FY COM M12 amount contains decimals.  Amount = " & CurrRow.COM_CY_M12_Amt
						CurrRow.COM_CY_M12_Amt = 0
					End If
					
#End Region
'--------------------------------------------------------------------------

					'----- truncate error message if too big			
					If sValidationError.Length > 256 Then sValidationError = Strings.Left(sValidationError, 256) 

					
					'----- Check if Fund Center being loaded is with in the user's security list ----
					Dim sFundCenter As String = CurrRow.FundCenter
					If Not lsuserfundcenters.Contains(sFundCenter.Replace("_General","")) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: User does not have privileges to Funds Center: " & sFundCenter.Replace("_General","")
					End If 	
					
					
					'----- Check if fundcode being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN_FUND")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U1#" & CurrRow.fundCode, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid FundCode: " & CurrRow.fundCode & " does not exist"
					End If
								
					'----- Check if mdep being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U2_MDEP")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U2#" & CurrRow.MDEP, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid MDEP value: " & CurrRow.MDEP & " does not exist"
					End If
					
					'----- Check if ape being loaded is valid -----
					objDimPk  = BRApi.Finance.Dim.GetDimPk(si, "U3_APE_PT")
					membList = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk, "U3#" & CurrRow.APE_PT, True)
					If (membList.Count <> 1 ) Then 
						CurrRow.valid = False
						If sValidationError <> "" Then sValidationError &= vbCrlf 
						sValidationError &= "Error: Invalid APE value: " & CurrRow.APE_PT & " does not exist"
					End If
						
					CurrRow.validationError = sValidationError
'If Not CurrRow.valid Then BRApi.ErrorLog.LogMessage(si, "Error line : " & currRow.StringOutput())					
						
					If Not CurrRow.valid Then isFileValid = False

					'Add REQ to the REQ list
					lsWithholdRecords.Add(currRow)
			
#End Region	
'------------------------------------------------------------------------------

				Next	'loop lines

#End Region
'====================================================================================================================================

'====================================================================================================================================
#Region "loop thru rows and load table"	
		
				Dim lsEnitiesInTable As New List(Of String)

				'loop through all parsed requirements list
				For Each CurrRow As WithholdRecord In lsWithholdRecords

					'------ capture unique list of entities in table -----	
					If Not lsEnitiesInTable.Contains(CurrRow.FundCenter) Then lsEnitiesInTable.Add(CurrRow.FundCenter)
'------------------------------------------------------------------------------
#Region "load table"
				
					'insert into table
					Dim SQLInsert As String = "
					INSERT Into [dbo].[XFC_WTHDST_Import]
								([ACOM]
								,[Scenario]
								,[FiscalYear]
								,[FundCenter]
								,[FundCode]
								,[MDEP]
								,[APE_PT]
								,[OBL_M1]
								,[OBL_M2]
								,[OBL_M3]
								,[OBL_M4]
								,[OBL_M5]
								,[OBL_M6]
								,[OBL_M7]
								,[OBL_M8]
								,[OBL_M9]
								,[OBL_M10]
								,[OBL_M11]
								,[OBL_M12]
								,[COM_M1]
								,[COM_M2]
								,[COM_M3]
								,[COM_M4]
								,[COM_M5]
								,[COM_M6]
								,[COM_M7]
								,[COM_M8]
								,[COM_M9]
								,[COM_M10]
								,[COM_M11]
								,[COM_M12]
								,[Valid]
								,[UserName]
								,[ValidationError])
				    VALUES
		   				('" & 
							CurrRow.ACOM.Replace("'", "''") & "','" &
							CurrRow.Scenario.Replace("'", "''") & "','" &
							CurrRow.FiscalYear.Replace("'", "''") & "','" &
							CurrRow.FundCenter.Replace("'", "''") & "','" &
							CurrRow.FundCode.Replace("'", "''") & "','" &
							CurrRow.MDEP.Replace("'", "''") & "','" &
							CurrRow.APE_PT.Replace("'", "''") & "','" &
							CurrRow.OBL_CY_M1_Amt & "','" &
							CurrRow.OBL_CY_M2_Amt & "','" &
							CurrRow.OBL_CY_M3_Amt & "','" &
							CurrRow.OBL_CY_M4_Amt & "','" &
							CurrRow.OBL_CY_M5_Amt & "','" &
							CurrRow.OBL_CY_M6_Amt & "','" &
							CurrRow.OBL_CY_M7_Amt & "','" &
							CurrRow.OBL_CY_M8_Amt & "','" &
							CurrRow.OBL_CY_M9_Amt & "','" &
							CurrRow.OBL_CY_M10_Amt & "','" &
							CurrRow.OBL_CY_M11_Amt & "','" &
							CurrRow.OBL_CY_M12_Amt & "','" &
							CurrRow.COM_CY_M1_Amt & "','" &
							CurrRow.COM_CY_M2_Amt & "','" &
							CurrRow.COM_CY_M3_Amt & "','" &
							CurrRow.COM_CY_M4_Amt & "','" &
							CurrRow.COM_CY_M5_Amt & "','" &
							CurrRow.COM_CY_M6_Amt & "','" &
							CurrRow.COM_CY_M7_Amt & "','" &
							CurrRow.COM_CY_M8_Amt & "','" &
							CurrRow.COM_CY_M9_Amt & "','" &
							CurrRow.COM_CY_M10_Amt & "','" &
							CurrRow.COM_CY_M11_Amt & "','" &
							CurrRow.COM_CY_M12_Amt & "','" &
							CurrRow.valid & "','" &
							si.UserName & "','" &
							CurrRow.validationError.Replace("'", "''") &
						"')"  				
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "SQLInsert : " & SQLInsert)
								
					Using dbConnApp As DBConnInfo = BRAPi.Database.CreateApplicationDbConnInfo(si)
						BRAPi.Database.ExecuteActionQuery(dbConnApp, SQLInsert, False, True)
					End Using

#End Region
'------------------------------------------------------------------------------

				Next

#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "If import mode = partial then check if any entities in table is locked"

				

					Dim lsListOfLockedSubCmds As New List(Of String)
	
					'----- check if FC is locked   -----
					For Each sFC As String In lsEnitiesInTable
						
						Dim sIndTargetMbrScript As String = "Cb#" & wfCube & ":E#" & sFC & ":C#Local:S#" & wfScenario & ":T#" & wfYear & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
						Dim dIndValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, sIndTargetMbrScript).DataCellEx.DataCellAnnotation
						If dIndValue = "Yes" Then lsListOfLockedSubCmds.Add(sFC)
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRapi.ErrorLog.LogMessage(si, "sFC=" & sFC & "   dIndValue=" & dIndValue)
					Next
					
					If lsListOfLockedSubCmds.Count > 0 Then
						Throw New System.Exception("WARNING: following funds center(s) in the load file are locked - " & String.Join(vbCrLF ,lsListOfLockedSubCmds) )
					End If
				
#End Region
'====================================================================================================================================


				If isFileValid Then
					
'====================================================================================================================================
#Region "loop thru table rows and sum amounts and append comments for same key4"	

					Dim SQL_GetRows As String = "SELECT * FROM XFC_WTHDST_Import WHERE ACOM='" & sACOM_FundCenter & "' and Scenario='" & wfScenario & "' And FiscalYear='" & wfTime & "' And UserName = '" & si.UserName & "' ORDER BY FundCenter, FundCode, MDEP, APE_PT;"

					Dim dict_Amt As New Dictionary(Of String, Long)

						Dim dtTableRows As DataTable
			
						Using dbConn As DbConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
				 			dtTableRows = BRApi.Database.ExecuteSql(dbConn,SQL_GetRows,True)
						End Using								
						
						For Each drAggRow As DataRow In dtTableRows.Rows
							Dim sRow_Scenario As String = drAggRow("Scenario")
							Dim sRow_FiscalYear As String = drAggRow("FiscalYear")
							Dim sRow_Fundcenter As String = drAggRow("Fundcenter")
							Dim sRow_FundCode As String = drAggRow("FundCode")
							Dim sRow_MDEP As String = drAggRow("MDEP")
							Dim sRow_APE_PT As String = drAggRow("APE_PT")
							Dim iRow_OBL_CY_M1_Amt As Long = drAggRow("OBL_M1")
							Dim iRow_OBL_CY_M2_Amt As Long = drAggRow("OBL_M2")
							Dim iRow_OBL_CY_M3_Amt As Long = drAggRow("OBL_M3")
							Dim iRow_OBL_CY_M4_Amt As Long = drAggRow("OBL_M4")
							Dim iRow_OBL_CY_M5_Amt As Long = drAggRow("OBL_M5")
							Dim iRow_OBL_CY_M6_Amt As Long = drAggRow("OBL_M6")
							Dim iRow_OBL_CY_M7_Amt As Long = drAggRow("OBL_M7")
							Dim iRow_OBL_CY_M8_Amt As Long = drAggRow("OBL_M8")
							Dim iRow_OBL_CY_M9_Amt As Long = drAggRow("OBL_M9")
							Dim iRow_OBL_CY_M10_Amt As Long = drAggRow("OBL_M10")
							Dim iRow_OBL_CY_M11_Amt As Long = drAggRow("OBL_M11")
							Dim iRow_OBL_CY_M12_Amt As Long = drAggRow("OBL_M12")
							Dim iRow_COM_CY_M1_Amt As Long = drAggRow("COM_M1")
							Dim iRow_COM_CY_M2_Amt As Long = drAggRow("COM_M2")
							Dim iRow_COM_CY_M3_Amt As Long = drAggRow("COM_M3")
							Dim iRow_COM_CY_M4_Amt As Long = drAggRow("COM_M4")
							Dim iRow_COM_CY_M5_Amt As Long = drAggRow("COM_M5")
							Dim iRow_COM_CY_M6_Amt As Long = drAggRow("COM_M6")
							Dim iRow_COM_CY_M7_Amt As Long = drAggRow("COM_M7")
							Dim iRow_COM_CY_M8_Amt As Long = drAggRow("COM_M8")
							Dim iRow_COM_CY_M9_Amt As Long = drAggRow("COM_M9")
							Dim iRow_COM_CY_M10_Amt As Long = drAggRow("COM_M10")
							Dim iRow_COM_CY_M11_Amt As Long = drAggRow("COM_M11")
							Dim iRow_COM_CY_M12_Amt As Long = drAggRow("COM_M12")

							Dim sRow_Account As String = ""
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then BRApi.ErrorLog.LogMessage(si, "sRow_Fundcenter=" & sRow_Fundcenter)					
							sRow_Account = "Phased_Obligation_Withhold"

'------------------------------------------------------------------------------
#Region "load obligation to dictionary"

							Dim sKey As String = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M1:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M1_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M1_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M2:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M2_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M2_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M3:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M3_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M3_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M4:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M4_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M4_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M5:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M5_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M5_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M6:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M6_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M6_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M7:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M7_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M7_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M8:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M8_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M8_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M9:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M9_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M9_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M10:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M10_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M10_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M11:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M11_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M11_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M12:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_OBL_CY_M12_Amt 
							Else
								dict_Amt.Add(sKey, iRow_OBL_CY_M12_Amt)
							End If
							
#End Region
'------------------------------------------------------------------------------

							sRow_Account = "Phased_Commitment_Withhold"

'------------------------------------------------------------------------------
#Region "load commitment to dictionary"

							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M1:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M1_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M1_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M2:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M2_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M2_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M3:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M3_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M3_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M4:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M4_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M4_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M5:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M5_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M5_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M6:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M6_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M6_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M7:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M7_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M7_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M8:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M8_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M8_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M9:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M9_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M9_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M10:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M10_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M10_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M11:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M11_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M11_Amt)
							End If
							sKey = "S#" & sRow_Scenario & ":T#" & sRow_FiscalYear & "M12:E#" & sRow_Fundcenter & ":U1#" & sRow_FundCode & ":U2#" & sRow_MDEP & ":U3#" & sRow_APE_PT & ":A#" & sRow_Account
							If dict_Amt.ContainsKey(sKey) Then
								dict_Amt(sKey) += iRow_COM_CY_M12_Amt 
							Else
								dict_Amt.Add(sKey, iRow_COM_CY_M12_Amt)
							End If
						
#End Region
'------------------------------------------------------------------------------
					
						Next	'loop table rows
									
				
#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "loop thru dictionaries and load cube"	

					Dim objListofLoadAmountScripts As New List(Of MemberScriptandValue)

					For Each kvp As KeyValuePair(Of String, Long) In dict_Amt
						Dim sKey As String = kvp.Key
'BRApi.ErrorLog.LogMessage(si, "sKey=" & sKey & "   Value=" & kvp.Value)

'------------------------------------------------------------------------------
#Region "load amounts to cube"

						'!!!!! DVLP NOTE: withholds are stored are obj class = 92 !!!!!
						Dim sDataBufferPOVScript_Amt As String = "Cb#" & sACOM & ":C#USD:V#Periodic:I#None:F#Baseline:O#Forms:U4#None:U5#None:U6#92:U7#None:U8#None:" & sKey

						
						Dim sAmt_Script As String = sDataBufferPOVScript_Amt
						Dim iAmt As Long = dict_Amt(sKey)
						
						Select Case True
							Case iAmt = 0
								'----- clear data -----
							    Dim msvAmt_ScriptVal As New MemberScriptAndValue
								msvAmt_ScriptVal.CubeName = wfcube
								msvAmt_ScriptVal.Script = sAmt_Script
								msvAmt_ScriptVal.Amount = 0
								msvAmt_ScriptVal.IsNoData = True
								objListofLoadAmountScripts.Add(msvAmt_ScriptVal)

							Case Else
								'----- load amount -----
								
							    Dim msvAmt_ScriptVal As New MemberScriptAndValue
								msvAmt_ScriptVal.CubeName = wfcube
								msvAmt_ScriptVal.Script = sAmt_Script
								msvAmt_ScriptVal.Amount = iAmt
								msvAmt_ScriptVal.IsNoData = False
								objListofLoadAmountScripts.Add(msvAmt_ScriptVal)
						End Select
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then Brapi.ErrorLog.LogMessage(si, "sAmt_Script=" & sAmt_Script & "   iAmt=" & iAmt)
									
#End Region
'------------------------------------------------------------------------------

					Next	'loop dictionary	
'BRApi.ErrorLog.LogMessage(si, "Updated " & objListofLoadAmountScripts.count & " cells out of " & dict_Amt.Count )

								
					objResult = BRApi.Finance.Data.SetDataCellsUsingMemberScript(si, objListofLoadAmountScripts)
'If si.UserName.XFEqualsIgnoreCase(DEBUG_USERNAME) Then Brapi.ErrorLog.LogMessage(si, "objResult=" & objResult.Message)


'!!!!! DVLP NOTE: this code can replaces load cube above and is faster - needs more testing before implementing !!!!!
'					'---------- run data mgmt sequence ----------
'					Dim sEntityList2 As String = ""
'					For Each sUserFC As String In lsUserFundCenters
'						If sEntityList2 = "" Then
'							sEntityList2 = "E#" & sUserFC & "_General" 
'						Else
'							sEntityList2 &= ", E#" & sUserFC & "_General" 
'						End If
'					Next

'					Dim params2 As New Dictionary(Of String, String) 
'					params2.Add("EntityList", sEntityList2)
					'params2.Add("EntityList", "E#A97AA_General, E#A97CC_General")
					
'					'!!!!!DVLP NOTE: this is a synchronous call so it returns after job is done !!!!!
'					Dim objTAI2 As TaskActivityItem =  BRApi.Utilities.ExecuteDataMgmtSequence(si, "Load_Withholds_To_Cube", params2)
'
'					Dim objTaskActivityItem2 As TaskActivityItem = BRApi.TaskActivity.GetTaskActivityItem(si, objTAI2.UniqueID)
'					If objTaskActivityItem2.HasError Then
'						Throw New System.Exception("ERROR: Data Management Job = Load_Withholds_To_Cube failed.  Please check activity log for more details.")
'					End If

#End Region
'====================================================================================================================================


'====================================================================================================================================
#Region "Consolidate"	

					'---------- run data mgmt sequence ----------
					Dim sEntityList3 As String = ""
					Dim gValue As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "40 CMD TGT")
					For Each sUserFC As String In lsUserFundCenters
						If sEntityList3 = "" Then
							sEntityList3 = "E#" & sUserFC
						Else
							sEntityList3 &= ", E#" & sUserFC
						End If
					Next
					
					Dim params3 As New Dictionary(Of String, String) 
					params3.Add("EntityList", sEntityList3)					

					'!!!!!DVLP NOTE: this is a synchronous call so it returns after job is done !!!!!
					Dim objTAI3 As TaskActivityItem =  BRApi.Utilities.ExecuteDataMgmtSequence(si, gValue, "ConsolidateTargets", params3)

					'system.Threading.Thread.Sleep(500)
					Dim objTaskActivityItem3 As TaskActivityItem = BRApi.TaskActivity.GetTaskActivityItem(si, objTAI3.UniqueID)
					If objTaskActivityItem3.HasError Then
						Throw New System.Exception("ERROR: Data Management Job = ConsolidateTargets failed.  Please check activity log for more details.")
					End If
			
#End Region 
'====================================================================================================================================

				End If	'isfilevalid
				
'====================================================================================================================================
#Region "staus messages"	

				'If the validation failed, write the error out.
				'If there are more than ten, we show only the first ten messages for the sake of redablity
				Dim sPasstimespent As System.TimeSpan = Now.Subtract(timestart)
				If Not isFileValid Then
					Dim sErrorLog As String = ""
					For Each CurrRow In lsWithholdRecords
						sErrorLog = sErrorLog & vbCrLf & CurrRow.StringOutput()
					Next
					'Throw New XFUserMsgException(si, New Exception("LOAD FAILED" & vbCrLf & filePath & " has invalid data." & vbCrLf & vbCrLf & "Please review stage table to view errors."))
					Dim sCompletionMessageFail As String = "IMPORT FAILED" & vbCrLf _
										& "File Name: " & objXFFileInfo.Name & vbCrLf _
										& "User Name: " & si.UserName & vbCrLf _ 
										& "Time Start: " & timeStart & vbCrLf _ 
										& "Time Ended: " & System.DateTime.Now & vbCrLf _ 
										& "Total seconds for import: " & sPasstimespent.TotalSeconds & "." & vbCrLf _
										& "Number of rows processed: " & lines.count & vbCrLf _
										& vbCrLf & "File Contents:" & vbCrLf _
										& sErrorLog

					Me.WithholdsImportFileHelper(si, globals, api, args, sCompletionMessageFail, "FAIL", objXFFileInfo.Name)
					
					Dim stastusMsg As String = "LOAD FAILED" & vbCrLf & objXFFileInfo.Name & " has invalid data." & vbCrLf & vbCrLf & $"To view import error(s), scroll right to the column titled ""ValidationError""."
					BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", stastusMsg)
					Return Nothing
				End If
				
				'File load complete. Write file to explorer
				Dim timespent As System.TimeSpan = Now.Subtract(timestart)
	'			Dim sCompletionMessage As String = "IMPORT PASSED" & vbCrLf _
	'												& "seconds for import to complete: " & timespent.TotalSeconds & "." & vbCrLf _
	'												& "Number of rows minus header row: " & lines.count - 1 & vbCrLf _
	'												& "Records Loaded: " & iLineCount & vbcrlf 
				Dim sCompletionMessagePass As String = "IMPORT PASSED" & vbCrLf _
													& "File Name: " & objXFFileInfo.Name & vbCrLf _
													& "User Name: " & si.UserName & vbCrLf _ 
													& "Time Start: " & timeStart & vbCrLf _ 
													& "Time Ended: " & System.DateTime.Now & vbCrLf _ 
													& "Total seconds for import: " & sPasstimespent.TotalSeconds & "." & vbCrLf _
													& "Number of rows processed: " & lines.count & vbCrLf 
													'& vbCrLf & "File Contents:" & vbCrLf _
													'& sErrorLog

				Me.WithholdsImportFileHelper(si, globals, api, args, sCompletionMessagePass, "PASS", objXFFileInfo.Name)
				'Throw New Exception("IMPORT PASSED" & vbCrLf & "Output file is located in the following folder for review:" & vbCrLf & "DOCUMENTS/USERS/" & si.UserName.ToUpper)
				Dim uploadStatus As String = "IMPORT PASSED" & vbCrLf & "Output file is located in the following folder for review:" & vbCrLf & "DOCUMENTS/USERS/" & si.UserName.ToUpper
				BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", uploadStatus)
		
#End Region 
'====================================================================================================================================

				Return Nothing
				
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try					
		End Function	
		
#End Region
'===========================================================================
#Region "Clear Key5 params"
Public Function ClearKey5param()
	Try
Dim paramsToClear As String = "ML_CMD_PGM_FormulateAPEPT," & _
														"ML_CMD_PGM_FormulateAPPN," & _
														"ML_CMD_PGM_FormulateCType," & _
														"ML_CMD_PGM_FormulateMDEP," & _
														"ML_CMD_PGM_FormulateDollarType," & _
														"ML_CMD_PGM_FormulateObjectClass," & _
														"ML_CMD_PGM_FormulateSAG" 
							
						
							
							
							
						Dim selectionChangedTaskResult As XFSelectionChangedTaskResult '= Me.ClearSelections(si, globals, api, args, paramsToClear)	
						selectionChangedTaskResult.ChangeCustomSubstVarsInDashboard = True	
						selectionChangedTaskResult.ChangeCustomSubstVarsInLaunchedDashboard = True
						Return selectionChangedTaskResult

    Catch ex As Exception
        Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
    End Try
End Function

Public Function ClearKey5params_NoFCAPPN()
	Try
Dim paramsToClear As String = "ML_CMD_PGM_FormulateAPEPT," & _
														"ML_CMD_PGM_FormulateCType," & _
														"ML_CMD_PGM_FormulateMDEP," & _
														"ML_CMD_PGM_FormulateDollarType," & _
														"ML_CMD_PGM_FormulateObjectClass," & _
														"ML_CMD_PGM_FormulateSAG" 
							

						Dim selectionChangedTaskResult As XFSelectionChangedTaskResult '= Me.ClearSelections(si, globals, api, args, paramsToClear)	
						selectionChangedTaskResult.ChangeCustomSubstVarsInDashboard = True	
						selectionChangedTaskResult.ChangeCustomSubstVarsInLaunchedDashboard = True
						Return selectionChangedTaskResult

    Catch ex As Exception
        Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
    End Try
End Function
#End Region	

#Region "Set Default APPN Parameter"
Public Function SetDeafultAPPNParam() As Object

	Dim dKeyVal As New Dictionary(Of String, String)
							
	dKeyVal.Add("ML_CMD_PGM_FormulateAPPN","OMA")
	
	If args.SelectionChangedTaskInfo.CustomSubstVarsWithUserSelectedValues.XFGetValue("BL_CMD_PGM_RelatedREQList","NA") <> "NA" Then
		dKeyVal.Add("BL_CMD_PGM_RelatedREQList",args.SelectionChangedTaskInfo.CustomSubstVarsWithUserSelectedValues.XFGetValue("BL_CMD_PGM_RelatedREQList","NA"))
	End If	
'Added 2 line to clear user cache before launching getcascadingfilters
		BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName,$"CMD_PGMCascadingFilterCache",$"CMD_PGM_rebuildparams_APPN","")
		
		BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName,$"CMD_PGM_CascadingFilterCache",$"CMD_PGM_rebuildparams_Other","")	
	'Return Me.SetParameter(si, globals, api, dKeyVal)
		
End Function
#End Region
	End Class
	

	
#Region "Spendplan Record Class"
	Public Class SpendPlanRecord
		'Class to hold the requirement object
		'-----Mapping definitions----
		Public Dim ACOM As String = ""			
		Public Dim Scenario As String = ""			'derived from WF
		Public Dim FiscalYear As String = ""		
		Public Dim FundCenter As String = ""
		Public Dim FundCode As String = ""
		Public Dim MDEP As String = ""
		Public Dim APE_PT As String = ""
		Public Dim CY_Amt As String = ""


		Public Dim valid As Boolean = True
		Public Dim validationError As String = ""
		
		Public Function StringOutput() As String
			Dim output As String = Me.ACOM & "," & _	
			Me.Scenario & "," & _
			Me.FiscalYear & "," & _
			Me.FundCenter & "," & _
			Me.FundCode & "," & _
			Me.MDEP & "," & _
			Me.APE_PT & "," & _
			Me.CY_Amt & "," & _
			Me.valid & "," & _
			Me.validationError
			
			Return output
			
		End Function
	End Class
	
#End Region

#Region "Withhold Record Class"
	Public Class WithholdRecord
		'Class to hold the requirement object
		'-----Mapping definitions----
		Public Dim ACOM As String = ""			
		Public Dim Scenario As String = ""			'derived from WF
		Public Dim FiscalYear As String = ""		
		Public Dim FundCenter As String = ""
		Public Dim FundCode As String = ""
		Public Dim MDEP As String = ""
		Public Dim APE_PT As String = ""
		Public Dim OBL_CY_M1_Amt As String = ""
		Public Dim OBL_CY_M2_Amt As String = ""
		Public Dim OBL_CY_M3_Amt As String = ""
		Public Dim OBL_CY_M4_Amt As String = ""
		Public Dim OBL_CY_M5_Amt As String = ""
		Public Dim OBL_CY_M6_Amt As String = ""
		Public Dim OBL_CY_M7_Amt As String = ""
		Public Dim OBL_CY_M8_Amt As String = ""
		Public Dim OBL_CY_M9_Amt As String = ""
		Public Dim OBL_CY_M10_Amt As String = ""
		Public Dim OBL_CY_M11_Amt As String = ""
		Public Dim OBL_CY_M12_Amt As String = ""
		Public Dim COM_CY_M1_Amt As String = ""
		Public Dim COM_CY_M2_Amt As String = ""
		Public Dim COM_CY_M3_Amt As String = ""
		Public Dim COM_CY_M4_Amt As String = ""
		Public Dim COM_CY_M5_Amt As String = ""
		Public Dim COM_CY_M6_Amt As String = ""
		Public Dim COM_CY_M7_Amt As String = ""
		Public Dim COM_CY_M8_Amt As String = ""
		Public Dim COM_CY_M9_Amt As String = ""
		Public Dim COM_CY_M10_Amt As String = ""
		Public Dim COM_CY_M11_Amt As String = ""
		Public Dim COM_CY_M12_Amt As String = ""

		Public Dim valid As Boolean = True
		Public Dim validationError As String = ""
		
		Public Function StringOutput() As String
			Dim output As String = Me.ACOM & "," & _	
			Me.Scenario & "," & _
			Me.FiscalYear & "," & _
			Me.FundCenter & "," & _
			Me.FundCode & "," & _
			Me.MDEP & "," & _
			Me.APE_PT & "," & _
			Me.OBL_CY_M1_Amt & "," & _
			Me.OBL_CY_M2_Amt & "," & _
			Me.OBL_CY_M3_Amt & "," & _
			Me.OBL_CY_M4_Amt & "," & _
			Me.OBL_CY_M5_Amt & "," & _
			Me.OBL_CY_M6_Amt & "," & _
			Me.OBL_CY_M7_Amt & "," & _
			Me.OBL_CY_M8_Amt & "," & _
			Me.OBL_CY_M9_Amt & "," & _
			Me.OBL_CY_M10_Amt & "," & _
			Me.OBL_CY_M11_Amt & "," & _
			Me.OBL_CY_M12_Amt & "," & _
			Me.COM_CY_M1_Amt & "," & _
			Me.COM_CY_M2_Amt & "," & _
			Me.COM_CY_M3_Amt & "," & _
			Me.COM_CY_M4_Amt & "," & _
			Me.COM_CY_M5_Amt & "," & _
			Me.COM_CY_M6_Amt & "," & _
			Me.COM_CY_M7_Amt & "," & _
			Me.COM_CY_M8_Amt & "," & _
			Me.COM_CY_M9_Amt & "," & _
			Me.COM_CY_M10_Amt & "," & _
			Me.COM_CY_M11_Amt & "," & _
			Me.COM_CY_M12_Amt & "," & _
			Me.valid & "," & _
			Me.validationError
			
			Return output
			
		End Function
	End Class
	
#End Region

End Namespace]]></sourceCode>
                                        </file>
                                        <file name="CMD_TGT_Import_Helper.vb" fileType="VisualBasic" businessRuleType="DashboardExtender" compilerActionType="Compile" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports System.Text.RegularExpressions
Imports Microsoft.VisualBasic.FileIO
Imports Microsoft.Data.SqlClient

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardExtender.CMD_TGT_Import_Helper
	Public Class MainClass
		
        Private si As SessionInfo
        Private globals As BRGlobals
        Private api As Object
        Private args As DashboardExtenderArgs
		
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardExtenderArgs) As Object
            ' Assign to global variables
            Me.si = si
            Me.globals = globals
            Me.api = api
            Me.args = args
	
			Try
				Select Case args.FunctionType
					
					Case Is = DashboardExtenderFunctionType.ComponentSelectionChanged
						Dim dbExt_ChangedResult As New XFSelectionChangedTaskResult()
#Region "Import TGT"
						'This makes sure there is only one import running at a time to make sure data is not overidden.
						'DEV NOTE: This may not be necessary with the new approach of adding the user into the loading tables
						If args.FunctionName.XFEqualsIgnoreCase("ImportTGT") Then
							dbExt_ChangedResult = Workspace.GBL.GBL_Assembly.GBL_Helpers.Check_WF_Complete_Lock(si, globals, api, args)
							Me.ImportTGT()
						Else If args.FunctionName.XFEqualsIgnoreCase("ImportWH") Then
							dbExt_ChangedResult = Workspace.GBL.GBL_Assembly.GBL_Helpers.Check_WF_Complete_Lock(si, globals, api, args)
							Me.ImportWH()
						End If
#End Region 
				End Select

				Return Nothing
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
#Region "TGT Mass Import"
		Public Function	ImportTGT() As Object							
			Dim Dist As New CMD_TGT_Dist()
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			
			Dim timeStart As DateTime = System.DateTime.Now
			Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)

			Dim mbrComd = BRApi.Finance.Metadata.GetMember(si, dimTypeId.Entity, wfInfoDetails("CMDName")).Member
			Dim comd As String = BRApi.Finance.Entity.Text(si, mbrComd.MemberId, 1, 0, 0)
			
			Dim fileName As String = args.NameValuePairs.XFGetValue("FileName") 

			Dim FilePath As String = $"{BRApi.Utilities.GetFileShareFolder(si, FileshareFolderTypes.FileShareRoot,Nothing)}/{FileName}"
			'Confirm source file exists
			'Dim filePath As String = args.NameValuePairs.XFGetValue("FilePath") 
'			Dim fullFile = Workspace.GBL.GBL_Assembly.GBL_Import_Helpers.PrepImportFile(si,filePath)

	        Dim validFile As Boolean = True
			Dim ImportTGT_DT As New DataTable()
			Using sr As New StreamReader(System.IO.File.OpenRead(filePath))
				ImportTGT_DT = Workspace.GBL.GBL_Assembly.GBL_Import_Helpers.GetCsvDataReader(si, globals, sr, ",", Dist.ColumnMaps)
			End Using
			If ImportTGT_DT Is Nothing	Then
				BRApi.ErrorLog.LogMessage(si, "Blank")
			Else 
				BRApi.ErrorLog.LogMessage(si, "ImportTGT_DT count = " & ImportTGT_DT.Rows.count)
			End If
			ImportTGT_DT.TableName = "ImportTGT_DT"
			
			'Check for errors
			Dim errRow As DataRow = ImportTGT_DT.AsEnumerable().
										FirstOrDefault(Function(r) Not String.IsNullOrEmpty(r.Field(Of String)("Invalid Errors")) )
										
			If errRow IsNot Nothing Then validFile = False
'BRApi.ErrorLog.LogMessage(si, "errRow: " & sScenario & " " & ImportTGT_DT.Rows.Count & ", passed: " & validFile)	
				
			'Write to the cube
			

			Dim stastusMsg As String = ""
			If Not validFile Then
				stastusMsg = "LOAD FAILED" & vbCrLf & fileName & " has invalid data." & vbCrLf & vbCrLf & $"To view import error(s), please take look at the column titled ""ValidationError""."
			Else 
				Me.UpdateUD3(ImportTGT_DT)
				stastusMsg = "IMPORT PASSED" & vbCrLf 
			End If

			BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", stastusMsg)
			Brapi.Utilities.SetSessionDataTable(si,si.UserName, "CMD_TGT_Import_" & sScenario,  ImportTGT_DT)
			
			Brapi.Utilities.SetSessionDataTable(si,si.UserName, $"CMD_TGT_Import_TGT_Dist_{sScenario}", ImportTGT_DT)	

			'Load to cube
			If validFile Then
				
				Dim wsID  = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False,"40 CMD TGT")
				Dim EntityList As String = "E#" & String.Join(",E#", ImportTGT_DT.AsEnumerable().Select(Function(row) row.Field(Of String)("FundsCenter"))) & ""
	Brapi.ErrorLog.LogMessage(si,"@HERE1" &String.Join(",",EntityList))
				Dim customSubstVars As New Dictionary(Of String, String) 
				customSubstVars.Add("EntityList",EntityList)
				BRApi.Utilities.ExecuteDataMgmtSequence(si, wsID, "CMD_TGT_Load_TGT_Dist_to_Cube", customSubstVars)
			End If
			
Brapi.ErrorLog.LogMessage(si,"Done")

		Return Nothing
		End Function
#End Region

#Region "TGT Mass Import"
		Public Function	ImportWH() As Object							
			Dim Dist As New CMD_TGT_Dist()
BRApi.ErrorLog.LogMessage(si, "in TGT Import")			
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			
			Dim timeStart As DateTime = System.DateTime.Now
			Dim sScenario As String = "" 'Scenario will be determined from the Cycle.

			Dim mbrComd = BRApi.Finance.Metadata.GetMember(si, dimTypeId.Entity, wfInfoDetails("CMDName")).Member
			Dim comd As String = BRApi.Finance.Entity.Text(si, mbrComd.MemberId, 1, 0, 0)

			'Confirm source file exists
			Dim filePath As String = args.NameValuePairs.XFGetValue("FilePath") 
'			Dim fullFile = Workspace.GBL.GBL_Assembly.GBL_Import_Helpers.PrepImportFile(si,filePath)

	        Dim validFile As Boolean = True
			Dim ImportTGT_DT As New DataTable()
			Using sr As New StreamReader(System.IO.File.OpenRead(filePath))
				ImportTGT_DT = Workspace.GBL.GBL_Assembly.GBL_Import_Helpers.GetCsvDataReader(si, globals, sr, ",", Dist.ColumnMaps)
			End Using
			
			'Check for errors
			Dim errRow As DataRow = ImportTGT_DT.AsEnumerable().
										FirstOrDefault(Function(r) Not String.IsNullOrEmpty(r.Field(Of String)("Invalid Errors")) )
										
			If errRow IsNot Nothing Then validFile = False

'			Dim REQDataTable As New DataTable("XFC_CMD_PGM_REQ")
'			Dim REQDetailDataTable As New DataTable("XFC_CMD_PGM_REQ_Details")
			
'            If validFile Then
'				'get req_id and guid
'				UpdateColsForDatabase(Importreq_DT)
'				PostProcessNewREQ(ImportREQ_DT)
				
''BRApi.ErrorLog.LogMessage(si, "Post proc completed " & Importreq_DT.TableName)					
'				'Split fullDataTable and insert into the two tables
'				Me.SplitAndInsertIntoREQTables(Importreq_DT, REQDataTable,REQDetailDataTable)
				
'            End If
			
			'write to cube
'			Dim REQ_IDs As New List(Of String)
'			For Each r As DataRow In ImportTGT_DT.Rows
'				REQ_IDs.Add(r("REQ_ID").ToString)	
'			Next
			
			'If the validation failed, write the error out.
			'If there are more than ten, we show only the first ten messages for the sake of redablity
'			Dim sPasstimespent As System.TimeSpan = Now.Subtract(timestart)
'			If Not validFile Then
'				Dim sErrorLog As String = ""
								
'				Dim stastusMsg As String = "LOAD FAILED" & vbCrLf & objXFFileInfo.Name & " has invalid data." & vbCrLf & vbCrLf & $"To view import error(s), please take look at the column titled ""ValidationError""."
'				BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", stastusMsg)
'				Brapi.Utilities.SetSessionDataTable(si,si.UserName, "CMD_IPGM_mport",  fullDataTable)
'				Return Nothing
'			End If
			
'			'File load complete. Write file to explorer
'			'Dim uploadStatus As String = "IMPORT PASSED" & vbCrLf & "Output file is located in the following folder for review:" & vbCrLf & "DOCUMENTS/USERS/" & si.UserName.ToUpper
'			Dim uploadStatus As String = "IMPORT PASSED" & vbCrLf 
'			BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus", uploadStatus)
'			Brapi.Utilities.SetSessionDataTable(si,si.UserName, "CMD_IPGM_mport",  fullDataTable)

'Get Entity List
'Run DM Sequence to load data into Cube
		Return Nothing
		End Function
#End Region

#Region "Helper Functions"
		Public  Function UpdateUD3(ByRef importTGT_DT As DataTable) As Object
			
			For Each r As DataRow In importTGT_DT.Rows
				r("APE9") = r("FundsCode").ToString().Trim & "_" & r("APE9").ToString().Trim
Brapi.ErrorLog.LogMessage(si,"APE: " & r("APE9"))
				
			Next
			Return Nothing
	End Function

#End Region
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                    </folder>
                                    <folder name="Factory">
                                        <file name="CMD_TGT_Svc_Factory.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Compile" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName
	Public Class CMD_TGT_Svc_Factory
		Implements IWsAssemblyServiceFactory

        Public Function CreateWsAssemblyServiceInstance(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal workspace As DashboardWorkspace, ByVal wsasType As WsAssemblyServiceType, ByVal itemName As String) As IWsAssemblyServiceBase Implements IWsAssemblyServiceFactory.CreateWsAssemblyServiceInstance
            Try				
                Select Case wsasType                   
					Case Is = WsAssemblyServiceType.FinanceCustomCalculate			
						Return New CMD_TGT_FinCustCalc()
						
                    Case Is = WsAssemblyServiceType.Component
'brapi.ErrorLog.LogMessage(si, "Component")						
                     '   Return New WsasComponent()

                    Case Is = WsAssemblyServiceType.Dashboard
'brapi.ErrorLog.LogMessage(si, "Dashboard")						
                        'Return New WsasDashboard()

                    Case Is = WsAssemblyServiceType.DataManagementStep
'brapi.ErrorLog.LogMessage(si, "DataManagementStep")						
                        'Return New CMD_TGT_DataManagementStep()

                    Case Is = WsAssemblyServiceType.DataSet
'brapi.ErrorLog.LogMessage(si, "DataSet")						
                        'Return New WsasDataSet()

                    Case Is = WsAssemblyServiceType.DynamicDashboards
'brapi.ErrorLog.LogMessage(si, "DynamicDashboards")						
                    	'Return New WsasDynamicDashboards()

                    Case Is = WsAssemblyServiceType.DynamicCubeView
'brapi.ErrorLog.LogMessage(si, "DynamicCubeView")						
                    	'Return New WsasDynamicCubeView()

                    Case Is = WsAssemblyServiceType.DynamicGrid						
                        Return New CMD_TGT_Dyn_Grid_Svc()

                    Case Is = WsAssemblyServiceType.FinanceCore
'brapi.ErrorLog.LogMessage(si, "DynamicGrid")						
                        'Return New WsasFinanceCore()

                    Case Is = WsAssemblyServiceType.FinanceGetDataCell
'brapi.ErrorLog.LogMessage(si, "FinanceGetDataCell")						
                        'Return New WsasFinanceGetDataCell()

                    Case Is = WsAssemblyServiceType.FinanceMemberLists
'brapi.ErrorLog.LogMessage(si, "FinanceMemberLists")						
                        'Return New WsasFinanceMemberLists()

                    Case Is = WsAssemblyServiceType.SqlTableEditor
'brapi.ErrorLog.LogMessage(si, "SqlTableEditor")						
                        'Return New WsasSqlTableEditor()

                    Case Is = WsAssemblyServiceType.TableView
'brapi.ErrorLog.LogMessage(si, "TableView")						
                        'Return New WsasTableView()

                    Case Is = WsAssemblyServiceType.XFBRString
'brapi.ErrorLog.LogMessage(si, "XFBRString")						
                    	'Return New WsasXFBRString()

                    Case Else
                        Return Nothing
                End Select

                Return Nothing
            Catch ex As Exception
                Throw New XFException(si, ex)
            End Try
        End Function

	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                        <folder name="Factory Services">
                                            <file name="CMD_TGT_Dyn_Grid_Svc.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Unknown" isEncrypted="false">
                                                <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800
Imports Workspace.GBL.GBL_Assembly

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName
	Public Class CMD_TGT_Dyn_Grid_Svc
		Implements IWsasDynamicGridV800
		
		Private si As SessionInfo
        Private globals As BRGlobals
        Private workspace As DashboardWorkspace
        Private args As DashboardDynamicGridArgs
		Private api As Object

        Public Function GetDynamicGridData(ByVal si As SessionInfo, ByVal brGlobals As BRGlobals, ByVal workspace As DashboardWorkspace, ByVal args As DashboardDynamicGridArgs) As XFDynamicGridGetDataResult Implements IWsasDynamicGridV800.GetDynamicGridData
            
			'Assign to global variables
            Me.si = si
            Me.globals = globals
            Me.workspace = workspace
            Me.args = args	
			Me.api = api
			Try

                If (brGlobals IsNot Nothing) AndAlso (workspace IsNot Nothing) AndAlso (args IsNot Nothing) Then
                	If args.Component.Name.XFEqualsIgnoreCase("dg_CMD_TGT_ImportDist") Then
						Return dg_CMD_TGT_ImportDist()
					End If
					
'					If args.Component.Name.XFEqualsIgnoreCase("dg_CMD_PGM_REQList") Then
'				    	Return dg_CMD_PGM_REQList()            
'					End If
					
'					If args.Component.Name.XFEqualsIgnoreCase("dg_CMD_PGM_Prioritize_REQ") Then
'				    	Return dg_CMD_PGM_Prioritize_REQ()            
'					End If
										
'					If args.Component.Name.XFEqualsIgnoreCase("dg_CMD_PGM_Rollover_REQ") Then
'				    	Return dg_CMD_PGM_Rollover_REQ()            
'					End If
				
				End If

                Return Nothing
            Catch ex As Exception
                Throw New XFException(si, ex)
            End Try
        End Function

        Public Function SaveDynamicGridData(ByVal si As SessionInfo, ByVal brGlobals As BRGlobals, ByVal workspace As DashboardWorkspace, ByVal args As DashboardDynamicGridArgs) As XFDynamicGridSaveDataResult Implements IWsasDynamicGridV800.SaveDynamicGridData
            Try

                If (brGlobals IsNot Nothing) AndAlso (workspace IsNot Nothing) AndAlso (args IsNot Nothing) Then
                End If

                Return Nothing
            Catch ex As Exception
                Throw New XFException(si, ex)
            End Try
        End Function
		
		Private Function dg_CMD_TGT_ImportDist() As XFDynamicGridGetDataResult
			'Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			'Dim sScenario As String = wfInfoDetails("ScenarioName")
			Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
			
			Dim tableName As String = "CMD_TGT_Import_" & sScenario
			Dim dt As DataTable = BRApi.Utilities.GetSessionDataTable(si, si.UserName,tableName)
			If dt Is Nothing Then Return Nothing
			Dim skp As New Dictionary(Of String, Object)
			
			Dim columnDefinitions As New List(Of XFDynamicGridColumnDefinition)
			Dim ValidationError As New XFDynamicGridColumnDefinition()
			ValidationError.ColumnName = "ValidationError"
			ValidationError.IsFromTable = True
			ValidationError.IsVisible = True
			ValidationError.AllowUpdates = False
			columnDefinitions.Add(ValidationError)
			
						
			Dim FiscalYear As New XFDynamicGridColumnDefinition()
			FiscalYear.ColumnName = "FiscalYear"
			FiscalYear.IsFromTable = True
			FiscalYear.IsVisible = True
			FiscalYear.AllowUpdates = False
			columnDefinitions.Add(FiscalYear)
			
			
			Dim FundCenter As New XFDynamicGridColumnDefinition()
			FundCenter.ColumnName = "FundCenter"
			FundCenter.IsFromTable = True
			FundCenter.IsVisible = True
			FundCenter.AllowUpdates = False
			columnDefinitions.Add(FundCenter)
			
			Dim APPN As New XFDynamicGridColumnDefinition()
			APPN.ColumnName = "FundCode"
			APPN.IsFromTable = True
			APPN.IsVisible = True
			APPN.AllowUpdates = False
			columnDefinitions.Add(APPN)
			
			Dim MDEP As New XFDynamicGridColumnDefinition()
			MDEP.ColumnName = "MDEP"
			MDEP.IsFromTable = True
			MDEP.IsVisible = True
			MDEP.AllowUpdates = False
			columnDefinitions.Add(MDEP)
			
			Dim APE9 As New XFDynamicGridColumnDefinition()
			APE9.ColumnName = "APE9"
			APE9.IsFromTable = True
			APE9.IsVisible = True
			APE9.AllowUpdates = False
			columnDefinitions.Add(APE9)
			Dim xfdt As New XFDataTable(si,dt,Nothing,10000)
			Dim rslt As New XFDynamicGridGetDataResult(xfdt,columnDefinitions,DataAccessLevel.AllAccess)
'BRApi.ErrorLog.LogMessage(si, "row count: " & rslt.DataTable.Rows.Count )
			Return rslt

		End Function

	End Class
End Namespace
]]></sourceCode>
                                            </file>
                                            <file name="CMD_TGT_FinCustCalc.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Compile" isEncrypted="false">
                                                <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName
	Public Class CMD_TGT_FinCustCalc
		Implements IWsasFinanceCustomCalculateV800
		
		Public si As SessionInfo
		Public globals As BRGlobals
		Public api As FinanceRulesApi
		Public args As FinanceRulesArgs
		Public Global_Functions As OneStream.BusinessRule.Finance.Global_Functions.MainClass

        Public Sub CustomCalculate(ByVal si As SessionInfo, ByVal brGlobals As BRGlobals, ByVal api As FinanceRulesApi, ByVal args As FinanceRulesArgs) Implements IWsasFinanceCustomCalculateV800.CustomCalculate
            Try
#Region "General Initialization"
				Me.si = si
				Me.api = api
				Me.args = args
				Me.globals = globals
				Me.Global_Functions = New OneStream.BusinessRule.Finance.Global_Functions.MainClass(si,globals,api,args)
#End Region
BRApi.ErrorLog.LogMessage(SI, "args.CustomCalculateArgs.FunctionName.ToLower() " & args.CustomCalculateArgs.FunctionName.ToLower())
				Select Case args.CustomCalculateArgs.FunctionName.ToLower()
					Case "copycprobetotarget"
						Me.CopycPROBEtoTGT()
					Case "tgtdst_load_targets_to_cube"
						Me.Load_TGT_Data_to_Cube("TGT_Dist")
					Case "loadwhtocube"
						Me.Load_TGT_Data_to_Cube("WH")
					Case "procdistout"
						Me.Process_TGT_Dist_Out()
				End Select

            Catch ex As Exception
                Throw New XFException(si, ex)
            End Try
        End Sub
		
#Region "CopycPROBEtoTGT"		
		Private Sub CopycPROBEtoTGT()
			Dim apiCube = api.Pov.Cube.Name
			Dim src_DataBuffer As New DataBuffer()

			Dim apiYear As Integer = TimeDimHelper.GetYearFromId(api.Pov.Time.MemberId)	
			Dim apiYear2Char As String = Strings.Right(apiYear, 2) 
			Dim scenario As String = args.CustomCalculateArgs.NameValuePairs.XFGetValue("cPROBEscen")
			brapi.ErrorLog.LogMessage(si,$"Hit {apiCube} - {api.pov.scenario.Name} - {api.pov.entity.name}")
		
			'Build SQL to return list of requirements that fit the user's criterias
			Dim SQL As String
			SQL = $"SELECT Appropriation_CD, Dollar_Type, Partial_Fund_CD  
					FROM XFC_APPN_Mapping"

			'Fetch mapping table 
			Dim dtU1Mappings As New DataTable
			Using dbConn As DbConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
				 dtU1Mappings = BRApi.Database.ExecuteSql(dbConn,SQL,True)
			End Using

			'Loop through the fetched datatable and load to dictionary
			Dim dictU1Mapping As Dictionary(Of String, String) = New Dictionary(Of String, String)
			For Each dataRow As DataRow In dtU1Mappings.Rows		
				Dim sAppn As String =  dataRow.Item("Appropriation_CD").tolower	
				Dim sDlrTyp As String =  dataRow.Item("Dollar_Type").tolower		
				Dim sPartFund As String =  dataRow.Item("Partial_Fund_CD")	
			
				If Not dictU1Mapping.ContainsKey(sAppn & sDlrTyp) Then 
					dictU1Mapping.Add(sAppn & sDlrTyp, sPartFund & apiYear2Char )
				End If
			Next
			
			Dim Val_Approach = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetValidationApproach(si,api.Pov.Entity.Name,api.Pov.Time.Name)
			If Val_Approach("CMD_Val_Pay_NonPay_Approach") = "Yes" Then
				Dim Src_Data As String = $"E#{apiCube}:S#{scenario}:C#Aggregated:V#Periodic:O#Top:I#Top:F#Tot_Position:U5#Top:U6#Top:U7#Top:U8#Top"
				Src_DataBuffer = api.Data.GetDataBufferUsingFormula($"FilterMembers(RemoveNoData({Src_Data}),[A#BO5])")
			End If
			
			Dim CurrCubeBuffer As DataBuffer = api.Data.GetDataBufferUsingFormula("FilterMembers(RemoveNoData(V#Periodic),[A#Target],[O#AdjInput],[F#L2_Ctrl_Intermediate])")
			Dim destBuffer As DataBuffer = New DataBuffer(currCubeBuffer.CommonDataBufferCellPk)

            Dim ClearCubeData As DataBuffer = New DataBuffer()
			
			Dim Src_Calc As String = $"E#{apiCube}:S#{scenario}:C#Aggregated:V#Periodic:O#Top:I#Top:A#BO1:F#Tot_Position:U5#Top:U6#Top:U7#Top:U8#Top"
			BRAPI.ErrorLog.LogMessage(SI, $"Hit: {Src_Calc}")
			Dim Src_CalcBuffer As DataBuffer = api.Data.GetDataBufferUsingFormula("FilterMembers(" & Src_Calc & ")")
			Src_CalcBuffer.LogDataBuffer(api,$"SRC: {api.pov.entity.Name}",200)

			For Each Src_CalcCell As DataBufferCell In Src_CalcBuffer.DataBufferCells.Values
				Dim destU1 As String
				If dictU1Mapping.ContainsKey(Src_CalcCell.DataBufferCellPk.GetUD1Name(api).ToLower & Src_CalcCell.DataBufferCellPk.GetUD4Name(api).ToLower) Then
					destU1 = dictU1Mapping(Src_CalcCell.DataBufferCellPk.GetUD1Name(api).ToLower & Src_CalcCell.DataBufferCellPk.GetUD4Name(api).ToLower)
				Else
					destU1 = Src_CalcCell.DataBufferCellPk.GetUD1Name(api).ToLower & "_General"
				End If
				
				If Val_Approach("CMD_Val_Pay_NonPay_Approach") = "Yes" Then
					
					Dim Pay_TGT As Decimal = GetBCValue(Src_CalcCell,Src_DataBuffer,"BO5")
					Dim NonPay_TGT = Src_CalcCell.CellAmount-Pay_TGT
					
					Dim DestNonPaycell As New DataBufferCell(UpdateCellDefinition(Src_CalcCell,"Target","L2_Ctrl_Intermediate","AdjInput","None",destU1,,,,"None","Non_Pay","None","None"))
	
					UpdateValue(DestNonPaycell, CurrCubeBuffer, destBuffer, NonPay_TGT)
					CurrCubeBuffer.DataBufferCells.Remove(DestNonPaycell.DataBufferCellPk)
					
					Dim DestPaycell As New DataBufferCell(UpdateCellDefinition(Src_CalcCell,"Target","L2_Ctrl_Intermediate","AdjInput","None",destU1,,,,"None","Pay_Benefits","None","None"))
	
					UpdateValue(DestPaycell, CurrCubeBuffer, destBuffer, Pay_TGT)
					CurrCubeBuffer.DataBufferCells.Remove(DestPaycell.DataBufferCellPk)
					BRAPI.ErrorLog.LogMessage(SI, $"Hit: {Src_CalcCell.CellAmount} - {Pay_TGT}")

				Else
					Dim Destcell As New DataBufferCell(UpdateCellDefinition(Src_CalcCell,"Target","L2_Ctrl_Intermediate","AdjInput","None",destU1,,,,"None","CostCat_General","None","None"))
	
					UpdateValue(Destcell, CurrCubeBuffer, destBuffer, Src_CalcCell.CellAmount)
					CurrCubeBuffer.DataBufferCells.Remove(Destcell.DataBufferCellPk)
				End If

			Next

			Dim destInfo As ExpressionDestinationInfo = api.Data.GetExpressionDestinationInfo("V#Periodic")
destBuffer.LogDataBuffer(api,$"Dest: {api.pov.Cons.Name}",200)
			api.Data.SetDataBuffer(destBuffer, destInfo,,,,,,,,,,,,,True)
			destBuffer.DataBufferCells.Clear()

			For Each ClearCubeCell As DataBufferCell In CurrCubeBuffer.DataBufferCells.Values
				Dim Status As New DataCellStatus(False)
				Dim ClearCell As New DataBufferCell(ClearCubeCell.DataBufferCellPk, 0, Status)
				ClearCubeData.SetCell(si, ClearCell)
			Next

			Dim ClearInfo = api.Data.GetExpressionDestinationInfo("V#Periodic")
			api.Data.SetDataBuffer(ClearCubeData, ClearInfo)
			
			
		End Sub
#End Region

#Region "Load_TGT_Data_to_Cube"
		Public Sub Load_TGT_Data_to_Cube(ByVal loadType As String)			
			'Load_Type Param - Status Updates, New Req Creation, Rollover, Mpr Req Creation, Copy
			Dim tgt_Acct As String = "Target"
			Dim tgt_Flow As String = "L3_Dist_Intermediate_In"
			Dim tgt_Origin As String = "AdjInput"
			Dim entDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_Army")	
			Dim EntBase = Not BRApi.Finance.Members.HasChildren(si, entDimPk, api.Pov.Entity.MemberId)
			Dim EntityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,api.Pov.Entity.Name)
			If EntityLevel.XFContainsIgnoreCase("L3") And EntBase = True And loadType = "TGT_DIST"
				tgt_Flow = "L3_Dist_Final"
				tgt_Origin = "Import"
			Else If EntityLevel.XFContainsIgnoreCase("L4") And EntBase = True And loadType = "TGT_DIST"
				tgt_Flow = "L4_Dist_Final"
				tgt_Origin = "Import"
			Else If EntityLevel.XFContainsIgnoreCase("L4") And EntBase = False And loadType = "TGT_DIST"
				tgt_Flow = "L4_Dist_Intermediate_In"
			Else If EntityLevel.XFContainsIgnoreCase("L5") And EntBase = True And loadType = "TGT_DIST"
				tgt_Flow = "L5_Dist_Final"
				tgt_Origin = "Import"
			Else If EntityLevel.XFContainsIgnoreCase("L2") And EntBase = False And loadType = "TGT_WH"
				tgt_Flow = "L2_Dist_Final"
				tgt_Acct = "TGT_WH"
			Else If EntityLevel.XFContainsIgnoreCase("L3") And EntBase = False And loadType = "TGT_WH"
				tgt_Flow = "L3_Dist_Final"
				tgt_Acct = "TGT_WH"
			Else If EntityLevel.XFContainsIgnoreCase("L4") And EntBase = False And loadType = "TGT_WH"
				tgt_Flow = "L4_Dist_Final"
				tgt_Acct = "TGT_WH"
			End If
			Dim TGT_Import_DT As DataTable = Brapi.Utilities.GetSessionDataTable(si,si.UserName, $"CMD_TGT_Import_{loadType}_{api.pov.scenario.Name}")	
			Dim CurrCubeBuffer As DataBuffer = api.Data.GetDataBufferUsingFormula($"FilterMembers(REMOVEZeros(V#Periodic),[A#{tgt_Acct}],[O#{tgt_Origin}],[F#{tgt_Flow}])")

			Dim destBuffer As DataBuffer = New DataBuffer()
			Dim ClearCubeData As DataBuffer = New DataBuffer()
			'Select form the DataTable
            'Filter rows by FundsCenter = current POV entity and loop them into a DataBuffer
            Dim filteredRows = TGT_Import_DT.AsEnumerable().
                Where(Function(r) Not IsDBNull(r("FundsCenter")) AndAlso
                                  String.Equals(r("FundsCenter").ToString(), api.Pov.Entity.Name, StringComparison.OrdinalIgnoreCase)).ToList()
            For Each row As DataRow In filteredRows
                Dim tgtcellPk As New DataBufferCellPk()
                Dim status As New DataCellStatus(True)
                Dim tgtDataCell As New DataBufferCell(tgtcellPk, 0, status)				
				Dim Destcell As New DataBufferCell(UpdateCellDefinition(tgtDataCell,tgt_Acct,tgt_Flow,tgt_Origin,"None",row("FundsCode").ToString(),row("MDEP").ToString(),row("APE9").ToString(),"None","None","None","None"))
                'Determine amount: prefer period column FY_<POVPeriodNum>, fallback to common amount column	
				If Not IsDBNull(row("Amount")) AndAlso row("Amount") <> 0 Then
					Destcell.CellAmount = Convert.ToDecimal(row("Amount"))
					destBuffer.DataBufferCells.Add(Destcell.DataBufferCellPk,Destcell)
					CurrCubeBuffer.DataBufferCells.Remove(Destcell.DataBufferCellPk)
				End If
            Next
			'Delete from the DatatABLE
'destBuffer.LogDataBuffer(api,"@ DataBuffer: " & api.Pov.Entity.Name & " : "  & api.Pov.Time.Name ,1000)
			Dim destInfo As ExpressionDestinationInfo = api.Data.GetExpressionDestinationInfo("V#Periodic")
			If destBuffer.DataBufferCells.Count > 0 Then
				api.Data.SetDataBuffer(destBuffer, destInfo,,,,,,,,,,,,, True)
				destBuffer.DataBufferCells.Clear()
			End If

			For Each ClearCubeCell As DataBufferCell In CurrCubeBuffer.DataBufferCells.Values
				Dim Status As New DataCellStatus(False)
				Dim ClearCell As New DataBufferCell(ClearCubeCell.DataBufferCellPk, 0, Status)
				ClearCubeData.SetCell(si, ClearCell)
			Next
	
			Dim ClearInfo = api.Data.GetExpressionDestinationInfo("V#Periodic")
			If ClearCubeData.DataBufferCells.Count > 0 Then
				api.Data.SetDataBuffer(ClearCubeData, ClearInfo)
			End If
			
		End Sub
#End Region

	Private Sub Process_TGT_Dist_Out()
		
	End Sub
		
#Region "Helper Functions"		
		''-------------------------------------------------------------------------		
		Public Function UpdateCellDefinition(ByRef destcell As DataBufferCell,Optional ByRef DriverDB_Acct As String = "NoPassedValue",Optional ByRef DriverDB_Flow As String = "NoPassedValue",Optional ByRef DriverDB_Origin As String = "NoPassedValue",Optional ByRef DriverDB_IC As String = "NoPassedValue",Optional ByRef DriverDB_UD1 As String = "NoPassedValue",Optional ByRef DriverDB_UD2 As String = "NoPassedValue",Optional ByRef DriverDB_UD3 As String = "NoPassedValue",Optional ByRef DriverDB_UD4 As String = "NoPassedValue",Optional ByRef DriverDB_UD5 As String = "NoPassedValue",Optional ByRef DriverDB_UD6 As String = "NoPassedValue",Optional ByRef DriverDB_UD7 As String = "NoPassedValue",Optional ByRef DriverDB_UD8 As String = "NoPassedValue") As DatabufferCell
		
			Dim BufferCell = Global_Functions.UpdateCellDefinition(destcell,DriverDB_Acct,DriverDB_Flow,DriverDB_Origin,DriverDB_IC,DriverDB_UD1,DriverDB_UD2,DriverDB_UD3,DriverDB_UD4,DriverDB_UD5,DriverDB_UD6,DriverDB_UD7,DriverDB_UD8)
			Return BufferCell
			
	    End Function
				
		''-------------------------------------------------------------------------
		Public Function GetBCValue(ByRef srccell As DataBufferCell,ByRef DriverDB As DataBuffer,Optional ByRef DriverDB_Acct As String = "NoPassedValue",Optional ByRef DriverDB_Flow As String = "NoPassedValue",Optional ByRef DriverDB_Origin As String = "NoPassedValue",Optional ByRef DriverDB_IC As String = "NoPassedValue",Optional ByRef DriverDB_UD1 As String = "NoPassedValue",Optional ByRef DriverDB_UD2 As String = "NoPassedValue",Optional ByRef DriverDB_UD3 As String = "NoPassedValue",Optional ByRef DriverDB_UD4 As String = "NoPassedValue",Optional ByRef DriverDB_UD5 As String = "NoPassedValue",Optional ByRef DriverDB_UD6 As String = "NoPassedValue",Optional ByRef DriverDB_UD7 As String = "NoPassedValue",Optional ByRef DriverDB_UD8 As String = "NoPassedValue") As Decimal
			
			Return Global_Functions.GetBCValue(srccell,DriverDB,DriverDB_Acct,DriverDB_Flow,DriverDB_Origin,DriverDB_IC,DriverDB_UD1,DriverDB_UD2,DriverDB_UD3,DriverDB_UD4,DriverDB_UD5,DriverDB_UD6,DriverDB_UD7,DriverDB_UD8)
			
		End Function
		
		''-------------------------------------------------------------------------
		Public Sub UpdateValue(ByRef srcCell As DataBufferCell, ByRef currCellDB As DataBuffer, ByRef destDB As DataBuffer, ByVal value As Decimal)
			
			Global_Functions.UpdateValue(srccell,currCellDB,destDB,value)

		End Sub
		
#End Region

	End Class
End Namespace
]]></sourceCode>
                                            </file>
                                        </folder>
                                    </folder>
                                    <folder name="Helper Classes">
                                        <file name="CMD_TGT_Dist.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800
Imports Workspace.GBL.GBL_Assembly

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName
	Public Class CMD_TGT_Dist
		Public ReadOnly ColumnMaps As New List(Of GBL_ColumnMap)

		Public Sub New()
			Dim command As New GBL_ColumnMap("ACOM","CMD",GetType(String),True,"WFCube",String.Empty,String.Empty,30)
			ColumnMaps.Add(command)
            Dim fiscalyear As New GBL_ColumnMap("FiscalYear","FiscalYear",GetType(String),True,"WFTime",String.Empty,String.Empty,4)
			ColumnMaps.Add(fiscalyear)
            Dim fundscenter As New GBL_ColumnMap("FundCenter","FundsCenter",GetType(String),True,"Ent_Member","WFCube","E#",100)
			ColumnMaps.Add(fundscenter)
            Dim fundcode As New GBL_ColumnMap("FundCode","FundsCode",GetType(String),True,"Member","U1_FundCode","U1#",100)
			ColumnMaps.Add(fundcode)
            Dim mdep As New GBL_ColumnMap("MDEP","MDEP",GetType(String),True,"Member","U2_MDEP","U2#",100)
			ColumnMaps.Add(mdep)
            Dim ape9 As New GBL_ColumnMap("APE(9)","APE9",GetType(String),True,"U3_Member","U3_All_APE","U3#",100)
			ColumnMaps.Add(ape9)
            Dim dollarType As New GBL_ColumnMap("DollarType","DollarType",GetType(String),True,"U4_Member","U4_DollarType","U4#",100)
			ColumnMaps.Add(dollarType)
            Dim costCat As New GBL_ColumnMap("CostCat","CostCat",GetType(String),True,"U6_Member","U6_CostCat","U6#",100)
			ColumnMaps.Add(costCat)
            Dim amount As New GBL_ColumnMap("Amount","Amount",GetType(Decimal),True,"Numeric",String.Empty,String.Empty,100)
			ColumnMaps.Add(amount)
		End Sub
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                        <file name="CMD_TGT_WH.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800
Imports Workspace.GBL.GBL_Assembly

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName
	Public Class CMD_TGT_WH
		Public ReadOnly ColumnMaps As New List(Of GBL_ColumnMap)

		Public Sub New()
			Dim command As New GBL_ColumnMap("ACOM","CMD",GetType(String),True,"WFCube",String.Empty,String.Empty,30)
			ColumnMaps.Add(command)
            Dim fiscalyear As New GBL_ColumnMap("FiscalYear","FiscalYear",GetType(String),True,"WFTime",String.Empty,String.Empty,4)
			ColumnMaps.Add(fiscalyear)
            Dim fundscenter As New GBL_ColumnMap("FundCenter","FundsCenter",GetType(String),True,"Ent_Member","WFCube","E#",100)
			ColumnMaps.Add(fundscenter)
            Dim fundcode As New GBL_ColumnMap("FundCode","FundsCode",GetType(String),True,"Member","U1_FundCode","U1#",100)
			ColumnMaps.Add(fundcode)
            Dim mdep As New GBL_ColumnMap("MDEP","MDEP",GetType(String),True,"Member","U2_MDEP","U2#",100)
			ColumnMaps.Add(mdep)
            Dim ape9 As New GBL_ColumnMap("APE(9)","APE9",GetType(String),True,"Member","U3_All_APE","U3#",100)
			ColumnMaps.Add(ape9)
            Dim dollarType As New GBL_ColumnMap("DollarType","DollarType",GetType(String),True,"U4_Member","U4_DollarType","U4#",100)
			ColumnMaps.Add(dollarType)
            Dim costCat As New GBL_ColumnMap("CostCat","CostCat",GetType(String),True,"U6_Member","U6_CostCat","U6#",100)
			ColumnMaps.Add(costCat)
            Dim amount As New GBL_ColumnMap("Amount","Amount",GetType(Decimal),True,"Numeric",String.Empty,String.Empty,100)
			ColumnMaps.Add(amount)
		End Sub
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                    </folder>
                                    <folder name="XFBRs">
                                        <file name="CMD_TGT_DataBuffers.vb" fileType="VisualBasic" businessRuleType="DashboardStringFunction" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardStringFunction.CMD_TGT_DataBuffers
	Public Class MainClass
		Public si As SessionInfo
        Public globals As BRGlobals
        Public api As Object
        Public args As DashboardStringFunctionArgs
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As Object
			Try
				Me.si = si
				Me.globals = globals
				Me.api = api
				Me.args = args

				Select Case args.FunctionName.ToLower()
				Case "getreviewsumtgtdist"	
					Return Me.GetReviewSumTgtDist()
				Case "getreviewtgtdist"	
					Return Me.getreviewtgtdist()
				Case "getreviewrectgt"
					Return Me.GetReviewRecTGT()
				Case "getmodify_distwh"
					Return Me.GetModify_DistWH()
				Case "getreviewtoplinesummary"
					Return Me.GetReviewTopLineSummary()
				Case "gettopline_ctrls"
					Return Me.getTopLine_Ctrls()
				End Select

				Return Nothing
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function

	#Region "Get Review Sum TGT Dist"
		Public Function GetReviewSumTgtDist() As String
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs.XFGetValue("Entity","NA")
			Dim RptType As String = args.NameValuePairs("RptType")  'Dist/Dist Variance
			Dim RowType As String = args.NameValuePairs("RowType")
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim Time As String = args.NameValuePairs("Time")
			Dim toSort As New Dictionary(Of String, String)
			Dim u1commDims As String = String.Empty
			Dim u2commDims As String = String.Empty
			Dim u4commDims As String = String.Empty
			Dim u5commDims As String = String.Empty
			Dim u6commDims As String = String.Empty
			Dim output = ""
			Dim commDims As String
			Dim u1Mbr As String = "OM"
			If RowType = "PROC"
				u1Mbr = "PROC"
			ElseIf RowType = "RDTE"
				u1Mbr = "RDA"
			ElseIf RowType = "OTH_APPN"
				u1Mbr ="OTH_APPN"
			End If
			Dim u1DimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN")	
			Dim appnList As New List(Of MemberInfo)
			
			Dim FilterString As String = $",[U3#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
			brapi.ErrorLog.LogMessage(si,$"Hit -{Entity}")
			If Entity = String.Empty Or Entity = "NA" Or Entity = vbNullString Then
				Return "U1#One:U2#Top:U3#Top:U4#Top:U6#Top"
			End If
			Dim EntityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,Entity)
			Dim Acct As String = "Target"
			Dim Flow As String = $"{EntityLevel}_Dist_Balance"
			Dim Val_Approach = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetValidationApproach(si,Entity,Time)
			Brapi.ErrorLog.LogMessage(si,"Val_Approach: " & Val_Approach.ToString)
			For Each pair In Val_Approach
				If pair.Key.xfcontainsignorecase("APPN")
					If pair.Value <> "APPN"
						FilterString &= $",[U1#APPN.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
						appnList = BRApi.Finance.Members.GetMembersUsingFilter(si, u1DimPk, $"U1#APPN", True)
					Else
						appnList = BRApi.Finance.Members.GetMembersUsingFilter(si, u1DimPk, $"U1#{u1Mbr}.Base.Options(Cube=Army,ScenarioType=ScenarioType1,MergeMembersFromReferencedCubes=False)", True)
					End If
				ElseIf pair.Key.xfcontainsignorecase("MDEP")
					If pair.Value = "Yes"
						FilterString &= $",[U2#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u2commDims = "U2#Top:"
					End If
				ElseIf pair.Key.xfcontainsignorecase("DollarType")
					If pair.Value = "Yes"
						FilterString &= $",[U4#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u4commDims = "U4#Top:"
					End If
				ElseIf pair.Key.xfcontainsignorecase("Pay_NonPay")
					If pair.Value = "Yes"
						FilterString &= $",[U6#Pay_Benefits,U6#Non_Pay]"
					Else
						u6commDims = "U6#CostCat:"
					End If
				End If
			Next
			Dim dict_FundCodeAPPN1Map As New Dictionary(Of String, String)
			If Val_Approach("CMD_Val_APPN_Approach") <> "APPN"		
				'Build SQL to return list of requirements that fit the user's criterias
				Dim SQL As String
				SQL = $"SELECT Partial_Fund_CD,Appropriation_CD  
						FROM XFC_APPN_Mapping"
	
				'Fetch mapping table 
				Dim dtU1Mappings As New DataTable()
				Using dbConn As DbConnInfo = BRApi.Database.CreateApplicationDbConnInfo(si)
					 dtU1Mappings = BRApi.Database.ExecuteSql(dbConn,SQL,True)
				End Using
				
				'Loop through the fetched datatable and load to dictionary
				For Each u1MapRow As DataRow In dtU1Mappings.Rows		
					If Not dict_FundCodeAPPN1Map.ContainsKey(u1MapRow.Item("Partial_Fund_CD")) Then 
						dict_FundCodeAPPN1Map.Add(u1MapRow.Item("Partial_Fund_CD"),u1MapRow.Item("Appropriation_CD"))
					End If
				Next
			End If

			For Each appn As MemberInfo In appnList
				
				If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
				If appn.Member.Name = "APPN"
					commDims =  $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#{Acct}:V#Periodic:O#Top:I#Top:F#{Flow}:{u2commDims}{u4commDims}U5#Top:{u6commDims}U7#Top:U8#Top"
				Else
					commDims =  $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#{Acct}:V#Periodic:O#Top:I#Top:F#{Flow}:U1#{appn.Member.Name}:{u2commDims}{u4commDims}U5#Top:{u6commDims}U7#Top:U8#Top"
				End If
				BRAPI.ErrorLog.LogMessage(si,$"FilterMembers(REMOVENODATA({commDims}){FilterString})")
				globals.SetStringValue("Filter", $"FilterMembers(REMOVENODATA({commDims}){FilterString})")
		
				GetDataBuffer(si,globals,api,args)
		
				If Not globals.GetObject("Results") Is Nothing
		
				Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
		
				For Each msb In results.Keys
				   msb.Scenario = vbNullString
				   msb.Entity =  Entity		   
				   msb.Account = vbNullString
				   msb.Origin = vbNullString
				   msb.IC = vbNullString
				   msb.Flow = vbNullString
				   If Val_Approach("CMD_Val_APPN_Approach") = "APPN" Then
					   msb.UD1 = appn.Member.Name
				   Else
					   msb.UD1 = dict_FundCodeAPPN1Map(msb.UD1.Substring(0,7))
				   End If
				   If u2commDims = "U2#Top:"
				   		msb.UD2 = "Top"
				   End If
				
				   If Val_Approach("CMD_Val_APE_Approach") = "ABO Level"
						If RowType = "RDTE" Then
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
						Else If RowType <> "PROC"
							Dim U3mbr_Expansion As String = ".Ancestors.Where(Text1 = SAG)"
							Dim objU3DimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "U3_All_APE")
							Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, $"U3#{msb.UD3}{U3mbr_Expansion}",True)
							msb.UD3 = lsAncestorList(0).Member.Name	
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
						Else
							msb.UD3 = msb.UD3.Substring(0,msb.UD3.Length-3)
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3.Substring(0,msb.UD3.Length-3))
						End If
				   End If
				   If u4commDims = "U4#Top:"
				   		msb.UD4 = "Top"
				   End If
				   msb.UD5 = vbNullString
				   If u6commDims = "U6#CostCat:"
				   		msb.UD6 = "CostCat"
				   End If
				   msb.UD7 = vbNullString
				   msb.UD8 = vbNullString	   
					If Not toSort.ContainsKey(msb.GetMemberScript)
						toSort.Add(msb.GetMemberScript, $"U1#{msb.UD1},U3#{msb.UD3},U2#{msb.UD2},U4#{msb.UD4},U6#{msb.UD6}")
					End If
				Next
			End If
		Next
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
	#End Region

	#Region "Get Review TGT Dist"
		Public Function getreviewtgtdist() As Object
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs("Entity")
			Dim RowType As String = args.NameValuePairs("RowType") 'OMA/OPA/RDTE/Other
			Dim RptType As String = args.NameValuePairs("RptType")  'Dist/Dist Variance
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim Time As String = args.NameValuePairs("Time")
			Dim toSort As New Dictionary(Of String, String)
			Dim u1commDims As String = String.Empty
			Dim u2commDims As String = String.Empty
			Dim u4commDims As String = String.Empty
			Dim u5commDims As String = String.Empty
			Dim u6commDims As String = String.Empty
			Dim output = ""
			Dim commDims As String
			Dim FilterString As String
			
			Dim EntityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,Entity)
			Dim Acct As String = "Target"
			Dim Flow As String = $"{EntityLevel}_Dist_Balance"
			Dim Val_Approach = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetValidationApproach(si,wfInfoDetails("CMDName"),Time)
			For Each pair In Val_Approach
				If pair.Key.xfcontainsignorecase("APPN")
					If pair.Value = "Yes"
						FilterString = $",[U1#APPN.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u1commDims = "U1#Top:"
					End If
				Else If pair.Key.xfcontainsignorecase("MDEP")
					If pair.Value = "Yes"
						FilterString = $",[U2#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u2commDims = "U2#Top:"
					End If
				Else If pair.Key.xfcontainsignorecase("DollarType")
					If pair.Value = "Yes"
						FilterString = $",[U4#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u4commDims = "U4#Top:"
					End If
				Else If pair.Key.xfcontainsignorecase("cType")
					If pair.Value = "Yes"
						FilterString = $",[U5#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
					Else
						u5commDims = "U5#Top:"
					End If
				Else If pair.Key.xfcontainsignorecase("Pay_NonPay")
					If pair.Value = "Yes"
						FilterString = $",[U6#Pay_Benefits,U6#Non_Pay]"
					Else
						u6commDims = "U6#Top:"
					End If
				End If
			Next
						

			Dim entDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_Army")		
			Dim entList = BRApi.Finance.Members.GetMembersUsingFilter(si, entDimPk, $"E#{Entity}", True)
			

			If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
			commDims =  $"Cb#{wfInfoDetails("CMDName")}:C#USD:S#{Scenario}:T#{Time}:E#[{Entity}]:A#{Acct}:V#Periodic:O#Top:I#Top:F#{Flow}:{u1commDims}{u2commDims}{u4commDims}{u5commDims}{u6commDims}U7#Top:U8#Top"

			globals.SetStringValue("Filter", $"FilterMembers(REMOVENODATA({commDims}){FilterString})")
	
			GetDataBuffer(si,globals,api,args)
	
			If Not globals.GetObject("Results") Is Nothing
	
			Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")

			Dim objU3DimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "U3_All_APE")
	
			For Each msb In results.Keys
			   msb.Scenario = vbNullString
			   msb.Entity =  Entity		   
			   msb.Account = vbNullString
			   msb.Origin = vbNullString
			   msb.IC = vbNullString
			   msb.Flow = vbNullString
			   msb.UD1 = vbNullString
			   msb.UD2 = vbNullString   
			
			   Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, "U3#" &  msb.UD3 & ".Ancestors.Where(MemberDim = U3_SAG)", True)
			   msb.UD3 = lsAncestorList(0).Member.Name	   
			   msb.UD4 = vbNullString
			   msb.UD5 = vbNullString
			   msb.UD6 = vbNullString
			   msb.UD7 = vbNullString
			   msb.UD8 = vbNullString	   
				If Not toSort.ContainsKey(msb.GetMemberScript)
					toSort.Add(msb.GetMemberScript, $"E#{msb.entity},U1#{msb.UD1},U2#{msb.UD2},U3#{msb.UD3},U4#{msb.UD4},U5#{msb.UD5},U6#{msb.UD6}")
				End If
			Next
		End If
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
	#End Region
	
	#Region "Get Review TopLine Summary"
		Public Function GetReviewTopLineSummary() As Object
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs("Entity")
			Dim RowType As String = args.NameValuePairs.XFGetValue("RowType","NA") 
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim PBScenario As String = args.NameValuePairs.XFGetValue("PBScenario","NA")
			Dim Time As String = args.NameValuePairs("Time")
			Dim Dist_Acct As String = "Target"
			Dim Dist_Flow As String = "L2_Ctrl_Intermediate"
			Dim mbr_Expansion As String = String.Empty
			Dim u1Mbr As String = "OM"
			If RowType = "PROC"
				u1Mbr = "PROC"
			ElseIf RowType = "RDTE"
				u1Mbr = "RDA"
			ElseIf RowType = "OTH_APPN"
				u1Mbr ="OTH_APPN"
			End If
			Dim u1DimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "U1_APPN")		
			Dim appnList = BRApi.Finance.Members.GetMembersUsingFilter(si, u1DimPk, $"U1#{u1Mbr}.Base.Options(Cube=Army,ScenarioType=ScenarioType1,MergeMembersFromReferencedCubes=False)", True)

			Dim toSort As New Dictionary(Of String, String)
			Dim output = ""
			Dim FilterString As String
		    For Each appn As MemberInfo In appnList

				If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
				FilterString = String.Empty
				If PBScenario = "NA" or PBScenario = String.Empty
					FilterString = $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#Target:V#Periodic:O#Top:I#Top:F#L2_Ctrl_Intermediate:U1#{appn.Member.Name}:U2#Top:U4#Top:U5#Top:U6#Top:U7#None:U8#None"	
				Else
					FilterString = $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#Target:V#Periodic:O#Top:I#Top:F#L2_Ctrl_Intermediate:U1#{appn.Member.Name}:U2#Top:U4#Top:U5#Top:U6#Top:U7#None:U8#None +
								     Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{PBScenario}:T#{Time}:E#[{wfInfoDetails("CMDName")}]:A#BO1:V#Periodic:O#Top:I#Top:F#Tot_Position:U1#{appn.Member.Name}:U2#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#Top +
					                 Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{PBScenario}:T#{Time}:E#[{wfInfoDetails("CMDName")}]:A#BO5:V#Periodic:O#Top:I#Top:F#Tot_Position:U1#{appn.Member.Name}:U2#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#Top"
				End If
				globals.SetStringValue("Filter", $"REMOVENODATA({FilterString})")
		
				GetDataBuffer(si,globals,api,args)
		
				If Not globals.GetObject("Results") Is Nothing
		
				Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
		
				For Each msb In results.Keys
					msb.Scenario = vbNullString
					msb.Entity =  vbNullString		   
					msb.Account = vbNullString
					msb.Origin = vbNullString
					msb.IC = vbNullString
					msb.Flow = vbNullString
					msb.UD1 = appn.Member.Name
					msb.UD2 = vbNullString   
						If RowType = "RDTE" Then
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
						Else If RowType <> "PROC"
							Dim U3mbr_Expansion As String = ".Ancestors.Where(Text1 = SAG)"
							Dim objU3DimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "U3_All_APE")
							Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, $"U3#{msb.UD3}{U3mbr_Expansion}",True)
							msb.UD3 = lsAncestorList(0).Member.Name	
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
						Else
							msb.UD3 = msb.UD3.Substring(0,msb.UD3.Length-3)
							globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3.Substring(0,msb.UD3.Length-3))
						End If
					msb.UD4 = vbNullString
					msb.UD5 = vbNullString
					msb.UD6 = vbNullString
					msb.UD7 = vbNullString
					msb.UD8 = vbNullString	   
					If Not toSort.ContainsKey(msb.GetMemberScript)
						toSort.Add(msb.GetMemberScript, $"E#{msb.entity},U1#{msb.UD1},U3#{msb.UD3}")
					End If
				Next
			End If
		Next
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
	#End Region
	
	#Region "Get Review Received TGT"
		Public Function GetReviewRecTGT() As Object
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs("Entity")
			Dim RptType As String = args.NameValuePairs("RptType")  'TGT Received/TGT Received by Appn
			Dim RowType As String = args.NameValuePairs.XFGetValue("RowType","NA") 
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim Time As String = args.NameValuePairs("Time")
			Dim Dist_Acct As String = "Target"
			Dim Dist_Flow As String = "L2_Ctrl_Intermediate"
			Dim mbr_Expansion As String = String.Empty
			Dim u3Mbrs As String = "U3#Top:"
			If RptType = "TGT_Rec" Then
				mbr_Expansion = ".Children"
				u3Mbrs = String.Empty
			End If
			Dim entDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_Army")		
			Dim entList = BRApi.Finance.Members.GetMembersUsingFilter(si, entDimPk, $"E#{Entity}{mbr_Expansion}", True)

			Dim toSort As New Dictionary(Of String, String)
			Dim output = ""
			Dim FilterString As String
			
			For Each Ent As MemberInfo In entList
				Dim EntBase = Not BRApi.Finance.Members.HasChildren(si, entDimPk, Ent.Member.MemberId)
				Dim EntityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,Ent.Member.Name)
	
				Select Case EntityLevel
				    Case "L3"
						If EntBase = True
				        	Dist_Flow = "L3_Dist_Final"
						Else
							Dist_Flow = "L3_Ctrl_Intermediate"
						End If
				    Case "L4"
						If EntBase = True
				        	Dist_Flow = "L4_Dist_Final"
						Else
							Dist_Flow = "L4_Ctrl_Intermediate"
						End If

						If EntBase = True
				        	Dist_Flow = "L5_Dist_Final"
						Else
							Dist_Flow = "L5_Ctrl_Intermediate"
						End If
						
				End Select
			

				If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
				FilterString = String.Empty
	
				FilterString = $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#{Dist_Acct}:V#Periodic:O#Top:I#Top:F#{Dist_Flow}:U2#Top:{u3Mbrs}U4#Top:U5#Top:U6#Top:U7#None:U8#None"
	
				globals.SetStringValue("Filter", $"REMOVENODATA({FilterString})")
		
				GetDataBuffer(si,globals,api,args)
		
				If Not globals.GetObject("Results") Is Nothing
		
				Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
		
				For Each msb In results.Keys
					msb.Scenario = vbNullString
					msb.Entity =  Entity		   
					msb.Account = vbNullString
					msb.Origin = vbNullString
					msb.IC = vbNullString
					msb.Flow = vbNullString
					msb.UD2 = vbNullString   
					If RptType = "TGT_Rec_Appn" Then
						msb.UD3 = vbNullString	
					Else
						If globals.GetStringValue($"RptU3_{msb.UD3}","NA")
							If RowType = "RDTE" Then
								globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
							Else If RowType <> "PROC"
								Dim U3mbr_Expansion As String = ".Ancestors.Where(MemberDim = U3_SAG)"
								Dim objU3DimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "U3_All_APE")
								Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, $"U3#{msb.UD3}{U3mbr_Expansion}",True)
								msb.UD3 = lsAncestorList(0).Member.Name	
								globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3)
							Else
								msb.UD3 = msb.UD3.Substring(0,msb.UD3.Length-3)
								globals.SetStringValue($"RptU3_{msb.UD3}",msb.UD3.Substring(0,msb.UD3.Length-3))
							End If
						Else
							msb.UD3 = globals.GetStringValue($"RptU3_{msb.UD3}","NA")
						End If
					End If
					msb.UD4 = vbNullString
					msb.UD5 = vbNullString
					msb.UD6 = vbNullString
					msb.UD7 = vbNullString
					msb.UD8 = vbNullString	   
					If Not toSort.ContainsKey(msb.GetMemberScript)
						If RptType = "TGT_Rec_Appn" Then
							toSort.Add(msb.GetMemberScript, $"E#{msb.entity},U1#{msb.UD1}")
						Else
							toSort.Add(msb.GetMemberScript, $"E#{msb.entity},U1#{msb.UD1},U3#{msb.UD3}")
						End If
					End If
				Next
			End If
		Next
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
	#End Region

	#Region "Get Modify TGT DIST/WH"
		Public Function GetModify_DistWH() As Object
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs("Entity")
			Dim Appn As String = args.NameValuePairs("APPN")
			Dim Mdep As String = args.NameValuePairs("MDEP")
			Dim SagApe As String = args.NameValuePairs("SAGAPE")
			Dim DollarType As String = args.NameValuePairs("DollarType")
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim Time As String = args.NameValuePairs("Time")
			Dim Acct As String = "TGT_WH"
			Dim Flow As String = "L2_Control"
			Dim mbr_Expansion As String = ".ChildrenInclusive"

			Dim entDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_Army")		
			Dim entList = BRApi.Finance.Members.GetMembersUsingFilter(si, entDimPk, $"E#{Entity}{mbr_Expansion}", True)

			Dim toSort As New Dictionary(Of String, String)
			Dim output = ""
			Dim commDims As String
			Dim FilterString As String = $",[U1#{Appn}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
										   ,[U2#{Mdep}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
										   ,[U3#{SagApe}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
										   ,[U4#{DollarType}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"

			For Each Ent As MemberInfo In entList
				Dim EntBase = Not BRApi.Finance.Members.HasChildren(si, entDimPk, Ent.Member.MemberId)
				Dim EntityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,Ent.Member.Name)
				If Entity <> Ent.Member.Name Then
					Acct = "Target"
				End If
	
				Select Case EntityLevel
				    Case "L2"
						If Acct = "TGT_WH"
				        	Flow = "L2_Dist_Final"
						End If
				    Case "L3"
						If Acct = "TGT_WH"
				        	Flow = "L3_Dist_Final"
						ElseIf EntBase = True
				        	Flow = "L3_Dist_Final"
						Else
							Flow = "L3_Ctrl_Intermediate"
						End If
				    Case "L4"
						If Acct = "TGT_WH"
				        	Flow = "L4_Dist_Final"
						ElseIf EntBase = True
				        	Flow = "L4_Dist_Final"
						Else
							Flow = "L4_Ctrl_Intermediate"
						End If
				    Case "L5"
				        Flow = "L5_Dist_Final"
						
				End Select
				
	
				If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
				commDims = String.Empty
	
				commDims = $"Cb#{wfInfoDetails("CMDName")}:C#Local:S#{Scenario}:T#{Time}:E#[{Ent.Member.Name}]:A#{Acct}:V#Periodic:O#Top:I#Top:F#{Flow}:U5#Top:U6#CostCat:U7#None:U8#None"
				
				globals.SetStringValue("Filter", $"FilterMembers(REMOVENODATA({commDims}){FilterString})")
		brapi.ErrorLog.LogMessage(si,$"FilterMembers(REMOVENODATA({commDims}){FilterString})")
				GetDataBuffer(si,globals,api,args)
		
				If Not globals.GetObject("Results") Is Nothing
		
				Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
		
				For Each msb In results.Keys
					brapi.ErrorLog.LogMessage(si,"Hit:" & msb.ud3)
				   msb.Scenario = vbNullString
				   msb.Entity =  Ent.Member.Name	   
				   msb.Account = Acct
				   msb.Origin = vbNullString
				   msb.IC = vbNullString
				   msb.Flow = Flow
				   msb.UD5 = vbNullString
				   msb.UD6 = vbNullString
				   msb.UD7 = vbNullString
				   msb.UD8 = vbNullString	   
					If Not toSort.ContainsKey(msb.GetMemberScript)
						toSort.Add(msb.GetMemberScript, $"U1#{msb.UD1},U2#{msb.UD2},U3#{msb.UD3},U4#{msb.UD4},A#{msb.Account},E#{msb.entity}")
					End If
				Next
			End If
		Next
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
	#End Region
	
	#Region "Get TopLine Ctrls"
		Public Function getTopLine_Ctrls() As Object
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim Entity As String = args.NameValuePairs("Entity")
			Dim APPN As String = args.NameValuePairs.XFGetValue("APPN","NA")
			Dim SAGAPE As String = args.NameValuePairs.XFGetValue("SAGAPE","NA") 
			Dim Scenario As String = args.NameValuePairs("Scenario")
			Dim Time As String = args.NameValuePairs("Time")

			Dim toSort As New Dictionary(Of String, String)
			Dim output = ""
			Dim FilterString As String = String.Empty
			Dim Filters As String = String.Empty
			If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"

		    FilterString = $"Cb#{wfInfoDetails("CMDName")}:C#Aggregated:S#{Scenario}:T#{Time}:E#[{Entity}]:A#Target:V#Periodic:O#Top:I#Top:F#L2_Ctrl_Intermediate:U5#Top:U6#CostCat:U7#Top:U8#Top"
			Filters = $",[U1#{APPN}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
					    ,[U2#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
			            ,[U3#{SAGAPE}.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]
			            ,[U4#Top.Base.Options(Cube={wfInfoDetails("CMDName")},ScenarioType=Target,MergeMembersFromReferencedCubes=False)]"
			globals.SetStringValue("Filter", $"FilterMembers(REMOVENODATA({FilterString}){Filters})")
	BRAPi.ErrorLog.LogMessage(si,$"FilterMembers(REMOVENODATA({FilterString}){Filters})")
			GetDataBuffer(si,globals,api,args)
	
			If Not globals.GetObject("Results") Is Nothing
	
			Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
	
			For Each msb In results.Keys
				BRAPi.errorlog.LogMessage(si,"Hit:" & msb.UD1)
				msb.Scenario = vbNullString
				msb.Entity =  vbNullString		   
				msb.Account = vbNullString
				msb.Origin = vbNullString
				msb.IC = vbNullString
				msb.Flow = vbNullString   
				msb.UD5 = vbNullString
				msb.UD6 = vbNullString
				msb.UD7 = vbNullString
				msb.UD8 = vbNullString	   
				If Not toSort.ContainsKey(msb.GetMemberScript)
					toSort.Add(msb.GetMemberScript, $"U1#{msb.UD1},U3#{msb.UD3}")
				End If
			Next
		End If
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
	brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
		output = "U5#One"
		End If
		
		Return output
	
		End Function
#End Region
	
#Region "Utilities: Get DataBuffer"
	
	Public Sub GetDataBuffer(ByRef si As SessionInfo, ByRef globals As BRGlobals, ByRef api As Object,ByRef args As DashboardStringFunctionArgs)
		'Dim filter = globals.GetStringValue("Filter","NA")

		'Dim workspaceID As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si, False, "00 GBL")				
		Dim Dictionary As New Dictionary(Of String, String)
		
		'BRApi.Finance.Calculate.ExecuteCustomCalculateBusinessRule(si,workspaceID, "workspace.GBL.GBL Objects.WSMU","Global_Buffers",Dictionary,customcalculatetimetype.CurrentPeriod)
		BRApi.Finance.Calculate.ExecuteCustomCalculateBusinessRule(si,"Global_Buffers","GetCVDataBuffer",Dictionary,customcalculatetimetype.CurrentPeriod)

'brapi.ErrorLog.LogMessage(si,"HIt 2")
	End Sub

#End Region	
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                        <file name="CMD_TGT_Member_Filter.vb" fileType="VisualBasic" businessRuleType="DashboardStringFunction" compilerActionType="Compile" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine

Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardStringFunction.CMD_TGT_Member_Filter
	Public Class MainClass
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As Object
			Try
				If args.FunctionName.XFEqualsIgnoreCase("DrillDownQuery") Then
'brapi.ErrorLog.LogMessage(si, "Function Call")					
					Return Me.DrillDownQuery(si, globals, api, args)
				End If
				
				If args.FunctionName.XFEqualsIgnoreCase("ModifyWithholds") Then
'brapi.ErrorLog.LogMessage(si, "Function Call")					
					Return Me.ModifyWithholds(si, globals, api, args)
				End If
				Return Nothing
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
#Region "ModifyWithholds Intersections"
	Public Function ModifyWithholds(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As Object
brapi.ErrorLog.LogMessage(si, "Inside ModifyWithholds")		
		Dim Entity As String = args.NameValuePairs("Entity")
		Dim lEntity As List(Of String) = StringHelper.SplitString(Entity,",")
'		Dim Scenario As String = args.NameValuePairs("Scenario")
'		Dim lScenario As List(Of String) = StringHelper.SplitString(Scenario,",")
'		Dim Time As String = args.NameValuePairs("Time")
'		Dim View As String = args.NameValuePairs("View")
'		Dim Account As String = args.NameValuePairs("Account")
'		Dim APPN As String = args.NameValuePairs("APPN")
'		Dim lAPPN As List(Of String) = StringHelper.SplitString(APPN,"_")
'		APPN = lAPPN(4)
brapi.ErrorLog.LogMessage(si,$"Entity: {Entity}")
		Dim toSort As New Dictionary(Of String, String)
		Dim output = ""
		Dim FilterString As String
'brapi.ErrorLog.LogMessage(si,$"Account: {Account}")
'brapi.ErrorLog.LogMessage(si,$"Entity List: " & lEntity.Count)
		If String.IsNullOrWhiteSpace(Entity) Then Return "E#None:U1#None:U3#None"
'brapi.ErrorLog.LogMessage(si,$"Entity Count: " & lEntity.Count)		
		For Each e As String In lEntity
			FilterString = String.Empty
'brapi.ErrorLog.LogMessage(si,$"Entity Loop: {e} - {FilterString}")
'			For Each s As String In lScenario
'				If String.IsNullOrWhiteSpace(FilterString) Then
'				'	FilterString = $"Cb#ARMY:C#Local:S#{s}:T#{Time}:E#[{e}]:A#{Account}:V#{View}:O#Top:I#Top:F#Top:U2#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#Top"
'				Else
'				'	FilterString = $"{FilterString} + Cb#ARMY:C#Aggregated:S#{s}:T#{Time}:E#[{e}]:A#{Account}:V#{View}:O#Top:I#Top:F#Top:U2#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#Top"		
'				End If
'			Next
	
'brapi.ErrorLog.LogMessage(si,$"Hit 2nd: {FilterString}")
			'globals.SetStringValue("Filter", $"FilterMembers(REMOVENODATA({FilterString}),[U1#{APPN}.Base.Options(Cube=ARMY,ScenarioType=Forecast,MergeMembersFromReferencedCubes=False)],[U3#{APPN}.Base.Options(Cube=ARMY,ScenarioType=Forecast,MergeMembersFromReferencedCubes=False)])")
brapi.ErrorLog.LogMessage(si, "Before GetDataBuffer")		
			GetDataBuffer(si,globals,api,args)
brapi.ErrorLog.LogMessage(si, "After GetDataBuffer")							
Return Nothing	
			If Not globals.GetObject("Results") Is Nothing
				Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
	
'brapi.ErrorLog.LogMessage(si,$"Hit - E#{e}:U1#Top:U3#{APPN}")
		
				Dim objU3DimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "U3_APE_PT")
				Dim objCommandDimPK As DimPK = BRapi.Finance.Dim.GetDimPk(si, "E_ARMY")
				Dim Command As String = e.Split("_")(0) 
				Dim lCommand As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objCommandDimPK, $"E#{Command}.Ancestors.Where(Text1 = {Command})", True,,)
				Dim CommandName As String = lCommand(0).Member.Name
			
			'Add Total row
'				If Not toSort.ContainsKey($"E#{CommandName}:U1#Top:U3#{APPN}")
'					toSort.Add($"E#{CommandName}:U1#Top:U3#{APPN}:Name(Total)",$"E#{CommandName},U1#Top")
'				End If
				For Each msb In results.Keys
				   msb.Scenario = vbNullString
				   msb.Entity =  CommandName		   
				   msb.Account = vbNullString
				   msb.Origin = vbNullString
				   msb.IC = vbNullString
				   msb.Flow = vbNullString
				   msb.UD2 = vbNullString   
		'brapi.ErrorLog.LogMessage(si,"320" & msb.UD3.Split("_")(0))
			  	   Select Case msb.UD3.Split("_")(0)
				   Case "OMA" 
		'brapi.ErrorLog.LogMessage(si,$"Hit")		
					   Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, "U3#" &  msb.UD3 & ".Ancestors.Where(Text1 = SAG)", True,,)
					   msb.UD3 = lsAncestorList(0).Member.Name
				   Case "OPA" 	 
					   Dim lsAncestorList As List(Of memberinfo) = BRApi.Finance.Members.GetMembersUsingFilter(si, objU3DimPK, "U3#" &  msb.UD3 & ".Parents", True,,)
					   msb.UD3 = lsAncestorList(0).Member.Name
			       End Select 
			   
				   msb.UD4 = vbNullString
				   msb.UD5 = vbNullString
				   msb.UD6 = vbNullString
				   msb.UD7 = vbNullString
				   msb.UD8 = vbNullString	   
					If Not toSort.ContainsKey(msb.GetMemberScript)
						toSort.Add(msb.GetMemberScript, $"E#{msb.entity},U1#{msb.UD1}")
					End If
				Next
			End If
		Next
	
		Dim sorted As Dictionary(Of String, String) = toSort.OrderByDescending(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
	
		For Each item In sorted
			output &= item.key & ","
		Next
'brapi.ErrorLog.LogMessage(si,"output:" & output)
		
		If output = "" Then
			output = "U5#One"
		End If
		
		Return output

	End Function
#End Region
		
		
#Region "Drill Down Query"
'XFBR(Workspace.CMD_TGT.CMD_TGT_Assembly.CMD_TGT_Member_Filter,DrillDownQuery, DrillDownQuery, DrillEntity=|!DrillEntity!|, DrillCons=|!DrillEntity!|, DrillScenario=|!DrillScenario!|, DrillTime=|!DrillTime!|, DrillAccount=|!DrillAccount!|, DrillFlow=|!DrillFlow!|, DrillView=|!DrillView!|, DrillOrigin=|!DrillOrigin!|, DrillU1=|!DrillU1!|, DrillU2=|!DrillU2!|, DrillU3=|!DrillU3!|, DrillU4=|!DrillU4!|, DrillU5=|!DrillU5!|, DrillU6=|!DrillU6!|, DrillU7=|!DrillU7!|, DrillU8=|!DrillU8!|)
		Public Function DrillDownQuery(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As Object
			Dim output = ""
			Dim DrillEntity As String = args.NameValuePairs.XFGetValue("DrillEntity", String.Empty)
			Dim DrillCons As String = args.NameValuePairs.XFGetValue("DrillCons", String.Empty)
			Dim DrillScenario As String = args.NameValuePairs.XFGetValue("DrillScenario", String.Empty)
			Dim DrillTime As String = args.NameValuePairs.XFGetValue("DrillTime", String.Empty)
			Dim DrillAccount As String = args.NameValuePairs.XFGetValue("DrillAccount", String.Empty)
			Dim DrillFlow As String = args.NameValuePairs.XFGetValue("DrillFlow", String.Empty)
			Dim DrillView As String = args.NameValuePairs.XFGetValue("DrillView", String.Empty)
			Dim DrillOrigin As String = args.NameValuePairs.XFGetValue("DrillOrigin", String.Empty)
			Dim DrillU1 As String = args.NameValuePairs.XFGetValue("DrillU1", String.Empty)
			Dim DrillU2 As String = args.NameValuePairs.XFGetValue("DrillU2", String.Empty)
			Dim DrillU3 As String = args.NameValuePairs.XFGetValue("DrillU3", String.Empty)
			Dim DrillU4 As String = args.NameValuePairs.XFGetValue("DrillU4", String.Empty)
			Dim DrillU5 As String = args.NameValuePairs.XFGetValue("DrillU5", String.Empty)
			Dim DrillU6 As String = args.NameValuePairs.XFGetValue("DrillU6", String.Empty)
			Dim DrillU7 As String = args.NameValuePairs.XFGetValue("DrillU7", String.Empty)
			Dim DrillU8 As String = args.NameValuePairs.XFGetValue("DrillU8", String.Empty)
			Dim FilterString = ""
			Dim GlobalTime As String = BRApi.Workflow.General.GetGlobalTime(si)

'brapi.ErrorLog.LogMessage(si, "Filter String  " & FilterString)
'brapi.ErrorLog.LogMessage(si, $"{DrillEntity} | {DrillAccount} | {DrillScenario} | {DrillTime} | {Drillu1} | {DrillU2} | {DrillU3}")			
			
Return Nothing			
			
			If (DrillEntity = "" OrElse
				DrillCons = "" OrElse
				DrillScenario = "" OrElse
				DrillTime = "" OrElse
				DrillAccount = "" OrElse
				DrillFlow = "" OrElse
				DrillView = "" OrElse
				DrillOrigin = "" OrElse
				DrillU1 = "" OrElse
				DrillU2 = "" OrElse
				DrillU3 = "" OrElse
				DrillU4 = "" OrElse
				DrillU5 = "" OrElse
				DrillU6 = "" OrElse
				DrillU7 = "" OrElse
				DrillU8 = "") Then
				
				output = "Cb#CMD_Consol:E#None:C#USD:S#None:F#None:T#" & GlobalTime & ":A#None:V#TYD:O#Import:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#:None:U7#None:U8#None"
			
			Else
				
				Dim ScenarioId As Integer = BRApi.Finance.Members.GetMemberId(si, DimTypeId.Scenario, DrillScenario)
				Dim ScenarioType As String = BRApi.Finance.Scenario.GetScenarioType(si, ScenarioId).ToString()
				
				'Base Members will go in FilterString
				FilterString = "Cb#CMD_Consol:E#[" & DrillEntity & "]:C#[" & DrillCons & "]:S#[" & DrillScenario & "]:F#[" & DrillFlow & "]:T#[" & DrillTime & "]:A#[" & DrillAccount & "]:V#[" & DrillView & "]:O#[" & DrillOrigin & "]:I#None"

Return Nothing

				'Parent Members or Sub total Members to drill down on
				globals.SetStringValue("Filter", $"REMOVEZEROS(FilterMembers({FilterString},
													[U1#{DrillU1}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U2#{DrillU2}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U3#{DrillU3}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U4#{DrillU4}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U5#{DrillU5}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U6#{DrillU6}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U7#{DrillU7}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)],
													[U8#{DrillU8}.Base.Option(Cube=CMD_Consol,ScenarioType={ScenarioType},MergeMembersFromReferencedCubes=False)]")
				
				
				GetDataBuffer(si, globals, api, args)
				
				Dim toSort As New Dictionary(Of String, String)
				If (Not globals.GetObject("Results") Is Nothing And Not globals.GetObject("ResultsCommon") Is Nothing)
					Dim results As Dictionary(Of MemberScriptBuilder, DataBufferCell) = globals.GetObject("Results")
					Dim msbCom As MemberScriptBuilder = globals.GetObject("ResultsCommon")
					For Each msb In results.Keys
						Dim tempStr As String = msb.Entity
						setMSB(si, msb, msbCom)
						msb.Entity = DrillEntity
						If(Not toSort.ContainsKey(msb.GetMemberScript)) Then
							toSort.Add(msb.GetMemberScript, tempStr)
						End If
					Next
				End If
				
				Dim sorted As Dictionary(Of String, String) = toSort.OrderBy(Function(x) x.Value).ToDictionary(Function(x) x.Key, Function(y) y.Value)
					For Each item In sorted
						output &= item.Key & ","
					Next
					If (output.Length > 0) Then
						output = output.Substring(0, output.Length -1)
					End If
						Return output
			End If
		End Function

#Region "Set Member Script Builder"
'Remove / comment the case statements that are being drilled down on above in globals.setStringValue
		Public Sub setMSB(ByRef si As SessionInfo, ByRef msbToSet As MemberScriptBuilder, ByRef msbCom As MemberScriptBuilder)
			Dim msbComMemNameList As KeyedByDimTypeList(Of String) = msbCom.MemberNames
			For Each kvp As KeyValuePair(Of DimType, String) In msbComMemNameList.KeyValuePairs	
				Select Case kvp.Key
					Case DimType.Account
						If(msbToSet.Account = "XFCommon" Or msbToSet.Account.Length = 0)
							msbToSet.Account = kvp.Value
						End If
					Case DimType.Entity
						If(msbToSet.Entity = "XFCommon" Or msbToSet.Entity.Length = 0)
							msbToSet.Entity = kvp.Value
						End If
					Case DimType.Scenario
						If(msbToSet.Scenario = "XFCommon" Or msbToSet.Scenario.Length = 0)
							msbToSet.Scenario = kvp.Value
						End If
					Case DimType.Consolidation
						If(msbToSet.Consolidation = "XFCommon" Or msbToSet.Consolidation.Length = 0)
							msbToSet.Consolidation = kvp.Value
						End If
					Case DimType.Time
						If(msbToSet.Time = "XFCommon" Or msbToSet.Time.Length = 0)
							msbToSet.Time = kvp.Value
						End If
					Case DimType.IC
						If(msbToSet.IC = "XFCommon" Or msbToSet.IC.Length = 0)
							msbToSet.IC = kvp.Value
						End If
					Case DimType.Origin
						If(msbToSet.Origin = "XFCommon" Or msbToSet.Origin.Length = 0)
							msbToSet.Origin = kvp.Value
						End If
					Case DimType.View
						If(msbToSet.View = "XFCommon" Or msbToSet.View.Length = 0)
							msbToSet.View = kvp.Value
						End If
	'				Case DimType.UD1
	'					If(msbToSet.UD1 = "XFCommon" Or msbToSet.UD1.Length = 0)
	'						msbToSet.UD1 = kvp.Value
	'					End If
	'				Case DimType.UD2
	'					If(msbToSet.UD2 = "XFCommon" Or msbToSet.UD2.Length = 0)
	'						msbToSet.UD2 = kvp.Value
	'					End If
	'				Case DimType.UD3
	'					If(msbToSet.UD3 = "XFCommon" Or msbToSet.UD3.Length = 0)
	'						msbToSet.UD3 = kvp.Value
	'					End If
	'				Case DimType.UD4
	'					If(msbToSet.UD4 = "XFCommon" Or msbToSet.UD4.Length = 0)
	'						msbToSet.UD4 = kvp.Value
	'					End If
	'				Case DimType.UD5
	'					If(msbToSet.UD5 = "XFCommon" Or msbToSet.UD5.Length = 0)
	'						msbToSet.UD5 = kvp.Value
	'					End If
	'				Case DimType.UD6
	'					If(msbToSet.UD6 = "XFCommon" Or msbToSet.UD6.Length = 0)
	'						msbToSet.UD6 = kvp.Value
	'					End If
	'				Case DimType.UD7
	'					If(msbToSet.UD7 = "XFCommon" Or msbToSet.UD7.Length = 0)
	'						msbToSet.UD7 = kvp.Value
	'					End If
	'				Case DimType.UD8
	'					If(msbToSet.UD8 = "XFCommon" Or msbToSet.UD8.Length = 0)
	'						msbToSet.UD8 = kvp.Value
	'					End If
					End Select
			Next
		End Sub
#End Region

#End Region

#Region "Utility Function"
		Public Sub GetDataBuffer(ByRef si As SessionInfo, ByRef globals As BRGlobals, ByRef api As Object, ByRef args As DashboardStringFunctionArgs)
			Dim nvp As New Dictionary(Of String, String)
brapi.ErrorLog.LogMessage(si, "Inside GetDataBuffer")				
'			Dim GlobalBuffers As New Workspace.GBL.GBL_Assembly.GBL_Buffers()	
'			GlobalBuffers.Global_Buffers()
			'GetDataBuffer(si,globals,api,args)
			BRApi.Finance.Calculate.ExecuteCustomCalculateBusinessRule(si, "Workspace.GBL.GBL_Assembly.GBL_Buffers.Global_Buffers", "GetCVDataBuffer", nvp, 0)
		End Sub
#End Region
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                        <file name="CMD_TGT_String_Helper.vb" fileType="VisualBasic" businessRuleType="Unknown" compilerActionType="Unknown" isEncrypted="false">
                                            <sourceCode><![CDATA[Imports System
Imports System.Collections.Generic
Imports System.Data
Imports System.Data.Common
Imports System.Globalization
Imports System.IO
Imports System.Linq
Imports Microsoft.VisualBasic
Imports OneStream.Finance.Database
Imports OneStream.Finance.Engine
Imports OneStream.Shared.Common
Imports OneStream.Shared.Database
Imports OneStream.Shared.Engine
Imports OneStream.Shared.Wcf
Imports OneStream.Stage.Database
Imports OneStream.Stage.Engine
Imports OneStreamWorkspacesApi
Imports OneStreamWorkspacesApi.V800

'TGT_String_Helper
Namespace Workspace.__WsNamespacePrefix.__WsAssemblyName.BusinessRule.DashboardStringFunction.CMD_TGT_String_Helper
	Public Class MainClass
        Private si As SessionInfo
        Private globals As BRGlobals
        Private api As Object
        Private args As DashboardStringFunctionArgs
		Public Function Main(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As Object
			Try			
	            Me.si = si
	            Me.globals = globals
	            Me.api = api
	            Me.args = args
'This will define the wf profile's command level i.e., CMD vs SubCMD from which the code is executed
'This will be used primarily for case statements
				Dim sWFProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
				Dim wfCMDLevel As String = String.Empty
				If sWFProfileName.XFContainsIgnoreCase("CMD")
					wfCMDLevel = "CMD"
				Else
					wfCMDLevel = "SubCMD"
				End If
				
				Select Case args.FunctionName.ToLower()
					Case "gettgtreviewdist"
						Return Me.GetTGTReviewDist()
					Case "returnentity"
						Return Me.ReturnEntityList()
					Case "returnmodifyflow"
						Return Me.ReturnModifyFlow()
					Case "returnmodifyorigin"
						Return Me.ReturnModifyOrigin()
					Case "returnentctrlacct"
						Return Me.ReturnEntCtrlAcct()
					Case "getcascadingmbrfilter"
						Return Me.GetCascadingMbrFilter()
					Case "getpaynonpay"
						Return Me.GetPayNonPay()
					Case "getentflow"
						Return Me.GetEntFlow()
				End Select				

#Region "GetProfileEntity"
'Called By CMD_TGT_SelectTopLineTargetsInitDistrVsSpendPlan
				If args.FunctionName.XFEqualsIgnoreCase("GetProfileEntity") Then
					Dim wfProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
					Dim wfCube = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName
					
					Dim sEntity As String = wfProfileName.Split(" ")(0).Trim
					If wfCube.XFContainsIgnoreCase("USAREUR") Then 
						sEntity = sEntity & "_AF"
					End If 
'BRapi.ErrorLog.LogMessage(si, "GetProfileEntity:  sEntity=" & sEntity)				
					Return sEntity
						
				End If

#End Region

#Region "CopySourceU1"
'Called By CMD_TGT_SelectTopLineTargetsInitDistrVsSpendPlan
				If args.FunctionName.XFEqualsIgnoreCase("CopySourceU1") Then
					Dim sU1 As String = args.NameValuePairs.XFGetValue("U1")
					Dim sScenario As String = args.NameValuePairs.XFGetValue("SourcePosition")
					
					If sScenario.XFContainsIgnoreCase("cProbe")
						If sU1.XFEqualsIgnoreCase("Appropriation") Then Return "[Appropriation.Descendants.Where(Text3 Contains L2).Where(Name DoesNotContain _General)]"
						Return $"{sU1}"
					Else
						Return $"{sU1}.Base"
					End If
				End If

#End Region

#Region "CopySourceAccount"
'Called By CMD_TGT_SelectTopLineTargetsInitDistrVsSpendPlan
				If args.FunctionName.XFEqualsIgnoreCase("CopySourceAccount") Then
					Dim sSource As String = args.NameValuePairs.XFGetValue("SourcePosition")
		
					If sSource.XFContainsIgnoreCase("cProbe") Then
						Return "BO1"
					Else
						Return "Total_Appr_Distr_Budget"
					End If
				End If
#End Region

#Region "CopySourceScenario"
'Called By CMD_TGT_SelectTopLineTargetsInitDistrVsSpendPlan
				If args.FunctionName.XFEqualsIgnoreCase("CopySourceScenario") Then
					Dim sWFTime As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
					Dim sSource As String = args.NameValuePairs.XFGetValue("SourcePosition")
					Dim sPBScenario As String = args.NameValuePairs.XFGetValue("PBScenario")
		
					If sSource.XFContainsIgnoreCase("cProbe") Then
						If String.IsNullOrWhiteSpace(sPBScenario) Then
							Return "None"
						End If	
							Return sPBScenario
					Else
						Return "Initial_Distribution_FY" & sWFTime
					End If
				End If
#End Region

#Region "CopySourceAccountScenario"
'Called By CMD_TGT_SelectTopLineTargetsInitDistrVsSpendPlan
				If args.FunctionName.XFEqualsIgnoreCase("CopySourceAccountScenario") Then
						Dim sWFTime As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey)
						Dim sSource As String = args.NameValuePairs.XFGetValue("SourcePosition")
						Dim sPBScenario As String = args.NameValuePairs.XFGetValue("PBScenario")
		
						If sSource.XFContainsIgnoreCase("cProbe") Then
							If String.IsNullOrWhiteSpace(sPBScenario) Then
								Return "S#None" & ":A#BO1:Name(Copy From cPROBE)"
							End If	
							Return "S#" & sPBScenario & ":A#BO1:Name(Copy From cPROBE)"
						Else
							Return "S#Initial_Distribution_FY" & sWFTime & ":A#Total_Appr_Distr_Budget:Name(Copy From Initial Distribution)"
						End If
				End If
#End Region

#Region "TargetLockCheck"
				If args.FunctionName.XFEqualsIgnoreCase("TargetLockCheck") Then
					Return Me.TargetLockCheck(si,api,args)
				End If
#End Region





'++++++++++
				
#Region "Get Target Amount Account"		
				'Return correct distribution target account for parent vs base FC 
				If args.FunctionName.XFEqualsIgnoreCase("GetTgtAmtAcct") Then
					Dim sFC As String = args.NameValuePairs.XFGetValue("FC","")
					Dim sAccount As String = ""
					If String.IsNullOrWhiteSpace(sFC) Then Return Nothing
					If sFC.XFContainsIgnoreCase("_general") Then
						sAccount = "Distr_Target_General"
					Else
						sAccount =  "Distr_Target"
					End If
'BRApi.ErrorLog.LogMessage(si, $"{BRName}.{args.FunctionName} - sAccount = {sAccount}")
					Return sAccount
				End If
#End Region 

#Region "Remove General from FC"		
				'Return correct distribution target account for parent vs base FC 
				If args.FunctionName.XFEqualsIgnoreCase("RemoveGeneralFromFC") Then
					Dim sFC As String = args.NameValuePairs.XFGetValue("FC","").ToLower.Replace("_general","").Trim()
					Dim sExpansion As String = args.NameValuePairs.XFGetValue("Expansion","")
					If String.IsNullOrWhiteSpace(sFC) Then Return Nothing
					sFC = sFC & sExpansion
'BRApi.ErrorLog.LogMessage(si, $"{BRName}.{args.FunctionName} - sFC = {sFC}")
					Return sFC
				End If
#End Region 

#Region "Display CMD Rows or Columns"
' Example: IsColumnVisible = XFBR(zMH_TGT_String_Helper,DisplayCmdRows,IsCMD=True)

				If args.FunctionName.XFEqualsIgnoreCase("DisplayCmdRows") Then
					Dim currentProfile As WorkflowProfileInfo = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey)
					Dim sWFProfile As String = currentProfile.Name
					Dim sIsCMD As String = args.NameValuePairs.XFGetValue("IsCMD")
'Brapi.ErrorLog.LogMessage(si, "sIsCMD = " & sIsCMD)
					
						If (sWFProfile.Contains("CMD")) And (sIsCMD = "True") Then
								Return "True"
									
							Else If (Not sWFProfile.Contains("CMD")) And (sIsCMD = "False")Then
								Return "True"
							Else
								Return "False"
						End If
						
				End If
#End Region

#Region "Get Mass Upload Status"
			
			If args.FunctionName.XFEqualsIgnoreCase("GetImportStatus") Then
   				Return BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, "UploadStatus", "UploadStatus","")
			End If
			
#End Region

#Region "ShowHideScenario"
		If args.FunctionName.XFEqualsIgnoreCase("ShowHideScenario") Then
				Dim sourceType As String = args.NameValuePairs.XFGetValue("sourceType").ToUpper
				Dim visible As String = ""
					If sourceType.XFContainsIgnoreCase("cPROBE") Then
						visible = "True"
					Else
						visible = "False"
					End If	
'BRapi.ErrorLog.LogMessage(si, "sourceType=" & visible)						
				Return visible
			End If
#End Region

#Region "ShowHidePublishSPLButtonMain"
		If args.FunctionName.XFEqualsIgnoreCase("ShowHidePublishSPLButtonMain") Then
		        Dim btnType As String = args.NameValuePairs.XFGetValue("btnType").ToUpper
				Dim visibleBTN As String = ""
					If btnType.XFContainsIgnoreCase("Initial") Then
						visibleBTN = "True"
					Else
						visibleBTN = "False"
					End If	
'BRapi.ErrorLog.LogMessage(si, "btuoone=" & visible)						
				Return visibleBTN
			End If
#End Region

#Region "Show Hide Component By FC Lock Status"
		If args.FunctionName.XFEqualsIgnoreCase("ShowHideComponentByFCLockStatus") Then
		        Dim sCube As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).CubeName	
				Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity", "")	
				Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
				Dim sTimeM12 As String = BRApi.Finance.Time.GetNameFromId(si,si.WorkflowClusterPk.TimeKey) & "M12"	
				'Check TGT_Target_Distribution_Complete_Ind
				Dim indTargetMbrScript As String = "Cb#" & sCube & ":E#" & sEntity & ":C#Local:S#" & sScenario & ":T#" & sTimeM12 & ":V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
				Dim indSourceValue As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, sCube, indTargetMbrScript).DataCellEx.DataCellAnnotation
				Dim isVisible As Boolean = True
				Dim sMode As String = args.NameValuePairs.XFGetValue("mode", "")
				Select Case sMode
				Case "ShowWhenLocked"
					If indSourceValue.XFContainsIgnoreCase("yes") Then
						isVisible = True
					Else
						isVisible = False
					End If
				Case Else
					If indSourceValue.XFContainsIgnoreCase("yes") Then isVisible = False
				End Select
				Return isVisible
			End If
#End Region

#Region "Display Copy and Phase withholds button"
' Example: IsColumnVisible = XFBR(TGT_String_Helper,Displaycpywthbtn)

				If args.FunctionName.XFEqualsIgnoreCase("Displaycpywthbtn") Then
					Dim currentProfile As WorkflowProfileInfo = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey)
					Dim sWFProfile As String = currentProfile.Name
					'Dim sIsCMD As String = args.NameValuePairs.XFGetValue("IsCMD")
				
						If (sWFProfile.Contains("CMD"))  Then
								Return "True"
							Else
								Return "False"
						End If
					End If
#End Region

#Region "DisplayWFComponentsCMDDST: Display Lock Unlock WF Components CMD/FC"
				If args.FunctionName.XFEqualsIgnoreCase("DisplayWFComponentsCMDDST") Then
					Return Me.DisplayWFComponentsCMDDST(si, globals, api, args)
				End If
#End Region

				
#Region "Get Validation Status"
			
			If args.FunctionName.XFEqualsIgnoreCase("GetValidationStatusMsg") Then
   				Return BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, "ValidationStatusMsg", "ValidationStatusMsg","")
			End If
			
#End Region

				Return Nothing
			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
		
#Region "GetCascadingMbrFilter"
		Public Function GetCascadingMbrFilter() As String
			Try
				' Read incoming args
				Dim cmd As String = args.NameValuePairs.XFGetValue("cmd", "NA")
				Dim entity As String = args.NameValuePairs.XFGetValue("entity", "NA")
				Dim appn As String = args.NameValuePairs.XFGetValue("appn", String.Empty)
				Dim mdep As String = args.NameValuePairs.XFGetValue("mdep", "NA")
				Dim sag As String = args.NameValuePairs.XFGetValue("sag", "NA")
				Dim ape As String = args.NameValuePairs.XFGetValue("ape", "NA")
				Dim dollarType As String = args.NameValuePairs.XFGetValue("dollarType", "NA")
				Dim status As String = args.NameValuePairs.XFGetValue("status", "NA")
				Dim returnType As String = args.NameValuePairs.XFGetValue("returnType", "NA")
				Dim cvName As String = args.NameValuePairs.XFGetValue("cvName", "NA") '"CMD_PGM_cPROBE_FDX_CV"

				' Build a compact signature for Entity + Appn only
				Dim currRebuildparams As String = String.Concat(cmd, "|", entity, "|", appn, "|", status)
				
				' Use workspace session settings to persist last seen signatures per user/workspace
				Dim cacheCat As String = $"CMD_TGT_CascadingFilterCache_{cvName}"
				Dim filterDTparams As String = $"CMD_TGT_FilterDTparams_{cvName}"
				Dim rebuildparams As String = "CMD_TGT_rebuildparams_{cvName}"

				Dim prevRebuildParams As String = BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, cacheCat, rebuildparams, "")
				Dim needsRebuild As Boolean = Not String.Equals(prevRebuildParams, currRebuildparams, StringComparison.Ordinal)

				Dim dt As New DataTable 
BRApi.Errorlog.LogMessage(si,$"Hit here - {entity} - {returnType} - {appn} - {Cmd} - {needsRebuild}")

				If needsRebuild Then
					BRApi.Utilities.SetWorkspaceSessionSetting(si, si.UserName, cacheCat, rebuildparams, currRebuildparams)
					If cvName.Substring(0,7) = "CMD_TGT"
						BRApi.Errorlog.LogMessage(si,$"Hit This")
						dt = GetFDXCascadingMbrFilter(cvName,entity,appn)
					Else
						BRApi.Errorlog.LogMessage(si,$"Hit Else")
						dt = GetFDXCascadingMbrFilter(cvName,Cmd,appn)
					End If
				Else
					dt = BRApi.Utilities.GetSessionDataTable(si, si.UserName, "CMD_TGT_CascadingFilter")
				End If
				
				Dim returnTypeMap As New Dictionary(Of String, String)(StringComparer.OrdinalIgnoreCase) From {
					{"APPN", "UD1"},
					{"MDEP", "UD2"},
					{"SAG",  "UD3"},
					{"APE",  "UD3"},
					{"DollarType",  "UD4"}
				}

				' Determine which physical column (if any) corresponds to the requested returnType
				Dim selectedColumn = String.Empty
				selectedColumn = returnTypeMap.XFGetValue(returnType,"Not Found")
				If Not dt Is Nothing Then

					' Build a deterministic signature of the inputs (full)
					Dim currFilterDTparams As String = String.Concat(entity, "|", appn, "|", status, "|", returnType, "|", mdep, "|", sag, "|", ape, "|", dollarType)
	
					Dim prevFilterDTparams As String = BRApi.Utilities.GetWorkspaceSessionSetting(si, si.UserName, cacheCat, filterDTparams, "")
	
	
					Dim filterParts As New List(Of String)
	
					' Only add filters when parameter is provided and not "NA"
					If Not String.IsNullOrWhiteSpace(mdep) AndAlso Not mdep.Equals("NA", StringComparison.OrdinalIgnoreCase) Then
						filterParts.Add("[UD2] = '" & mdep.Replace("'", "''") & "'")
					End If
	
					If Not String.IsNullOrWhiteSpace(ape) AndAlso Not ape.Equals("NA", StringComparison.OrdinalIgnoreCase) Then
						filterParts.Add("[UD3] = '" & ape.Replace("'", "''") & "'")
					End If
	
					If Not String.IsNullOrWhiteSpace(dollarType) AndAlso Not dollarType.Equals("NA", StringComparison.OrdinalIgnoreCase) Then
						filterParts.Add("[UD4] = '" & dollarType.Replace("'", "''") & "'")
					End If
	
	
					Dim filterExpr As String = If(filterParts.Count > 0, String.Join(" AND ", filterParts), String.Empty)
					' Filter dt into a DataTable so it can be converted to a DataView
					Dim filteredDt As DataTable
					If String.IsNullOrEmpty(filterExpr) Then
						filteredDt = dt.Copy()
					Else
						filteredDt = dt.Clone()
						Dim selectedRows() As DataRow = dt.Select(filterExpr)
						For Each row As DataRow In selectedRows
							filteredDt.ImportRow(row)
						Next
					End If
					BRApi.Utilities.SetSessionDataTable(si, si.UserName, "CMD_TGT_CascadingFilter",filteredDt)
	
					Dim dv As DataView = New DataView(filteredDt)
					' Map returnType values to column keys (case-insensitive)

					If selectedColumn <> "Not Found"
	
						dv.RowFilter = $"{selectedColumn} IS NOT NULL AND {selectedColumn} <> ''"
						dv.Sort = selectedColumn & " ASC"
						Dim mlDT = dv.ToTable(True, selectedColumn) ' Distinct values only
		
						Dim result As String = String.Empty
						For Each dr As DataRow In mlDT.Rows
							Dim val As String = dr(selectedColumn).ToString()
							If Not String.IsNullOrWhiteSpace(val) Then
								If String.IsNullOrEmpty(result) Then
									result = $"{selectedColumn}#{val}"
								Else
									result &= $",{selectedColumn}#{val}"
								End If
							End If
						Next

						Return result
					Else
						Return String.Empty
					End If
				Else
'BRapi.ErrorLog.LogMessage(si,"Hit Empty")
					Return $"{selectedColumn}#None"
				End If					

			Catch ex As Exception
				Throw ErrorHandler.LogWrite(si, New XFException(si, ex))
			End Try
		End Function
#End Region 'Updated 10/16/2025
		
#Region "Helper Functions"
	
		Private Function GetFDXCascadingMbrFilter(ByVal cvName As String,ByVal entFilter As String,ByVal appn As String) As DataTable
			Dim dt As New DataTable()
			Dim wsName As String = "00 GBL"
			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			Dim sScenario As String = ScenarioDimHelper.GetNameFromId(si, si.WorkflowClusterPk.ScenarioKey)
			Dim CprobeScen As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetSrccPROBEScen(si,wfInfoDetails("ScenarioName"))

			Dim entDim = $"E_{wfInfoDetails("CMDName")}"
			Dim scenDim = "S_RMW"
			Dim scenFilter = $"S#{CprobeScen}"
			Dim timeFilter = String.Empty '$"T#{wfInfoDetails("TimeName")}"
			Dim NameValuePairs = New Dictionary(Of String,String)
'			If appn = String.Empty
'				appn = "OMA"
'			End If
			NameValuePairs.Add("ML_GBL_APPN",appn)
			
			If cvName.Substring(0,7) = "CMD_TGT"
				wsName = "40 CMD TGT"
				scenFilter = $"S#{wfInfoDetails("ScenarioName")}"
				NameValuePairs.Remove("ML_GBL_APPN")
			End If
			Dim nvbParams As NameValueFormatBuilder = New NameValueFormatBuilder(String.Empty,NameValuePairs,False)
			Dim wsID As Guid = BRApi.Dashboards.Workspaces.GetWorkspaceIDFromName(si,False,wsName)
			dt = BRApi.Import.Data.FdxExecuteCubeViewTimePivot(si, wsID, cvName, entDim, $"E#{entFilter}", scenDim, scenFilter, timeFilter, nvbParams, False, True, True, String.Empty, 1, False)
If dt Is Nothing
	BRAPI.ErrorLog.LogMessage(si,$"Hit NOthing - {wfInfoDetails("ScenarioName")} - {CprobeScen}")
End If
			Return dt
		End Function
#End Region 'Updated 10/16/2025

#Region "Get Pay/Non-Pay"
		Public Function GetPayNonPay() As String
			Dim PayNonPayType As String = args.NameValuePairs.XFGetValue("PayNonPayType","NA")
			Dim Entity As String = args.NameValuePairs.XFGetValue("Entity","NA")
			

			Dim wfInfoDetails = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetWFInfoDetails(si)
			If Entity = wfInfoDetails("CMDName")
				Dim mbrInfo As MemberInfo = BRApi.Finance.Members.GetMemberInfo(si, dimType.Entity.Id, Entity)
				Entity = BRApi.Finance.Entity.Text(si, mbrInfo.Member.MemberId, 1, DimConstants.Unknown, DimConstants.Unknown)
			End If
			Dim Val_Approach = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetValidationApproach(si,Entity,wfInfoDetails("TimeName"))
			If Val_Approach("CMD_Val_Pay_NonPay_Approach") = "Yes"
				If PayNonPayType = "cPROBEBO5"
					Return "A#BO5"
				ElseIf PayNonPayType = "TopLineAdj" Or PayNonPayType = "ModifyTGTDistWH" Or PayNonPayType = "NewTGTDist" Or PayNonPayType = "NewWH" Then
					Return "U6#CostCat,U6#Pay_Benefits,U6#Non_Pay"
				End If
			Else
				If PayNonPayType = "cPROBEBO5" 
					Return "A#NA"
				ElseIf (PayNonPayType = "TopLineAdj" Or PayNonPayType = "ModifyTGTDistWH" Or PayNonPayType = "NewTGTDist" Or PayNonPayType = "NewWH") Then
					Return "U6#CostCat_General"
				End If
			End If
			
			
		End Function


#End Region

#Region "Get Entity Flow"
		Public Function GetEntFlow() As String
			Dim Entity As String = args.NameValuePairs.XFGetValue("Entity","NA")
			Dim newRowType As String = args.NameValuePairs.XFGetValue("newRowType","NA")
			Dim entityLevel As String = Workspace.GBL.GBL_Assembly.GBL_Helpers.GetEntityLevel(si,Entity)
			If newRowType = "WH"
				Return $"{entityLevel}_Dist_Final"
			Else
				Return $"{entityLevel}_Ctrl_Intermediate"
			End If
			
			
		End Function


#End Region
#Region "TargetLockCheck"
		Private Function TargetLockCheck(ByVal si As SessionInfo, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As String
			'Command: XFBR({TGT_String_Helper}{TargetLockCheck}{argsPath=CMDXYZ})
			'SubCommand: XFBR({TGT_String_Helper}{TargetLockCheck}{argsPath=subCMDXYZ, subCommandEntity=|!prompt_cbx_TGTDST_TGTADM_0CaAa_D_FundCenter__ManageAccessSubCMD!|})	
'brapi.ErrorLog.LogMessage(si,$"Inside TargetLock")				
			'Dim argsPath As String = args.NameValuePairs.XFGetValue("argsPath")
			Dim wfCube As String = args.SubstVarSourceInfo.WFCube
			Dim wfScenario As String = args.SubstVarSourceInfo.WFScenario.Name
			Dim wfTime As String = args.SubstVarSourceInfo.WFTime.Name
			Dim sWFProfileName As String = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey).Name
			Dim wfCMDLevel As String = String.Empty
			If sWFProfileName.XFContainsIgnoreCase("CMD")
				wfCMDLevel = "CMD"
			Else
				wfCMDLevel = "SubCMD"
			End If
			Dim isSelf As Boolean = args.NameValuePairs.XFGetValue("Self",False)
			Dim objDimPk As DimPk = BRApi.Finance.Dim.GetDimPk(si, "E_" & wfCube)
			Dim commandEntity As String = BRApi.Finance.Members.GetMembersUsingFilter(si, objDimPk , $"E#{wfCube}.Descendants.Where(HasChildren = True).Where(Text3 Contains EntityLevel=L2)", True,,)(0).Member.Name
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity")
			Dim commandBalanceScript As String = "E#" & commandEntity & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim commandBalanceStatus As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, commandBalanceScript).DataCellEx.DataCellAnnotation
			Dim subCommandBalanceScript As String = "E#" & sEntity & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
			Dim subCommandBalanceStatus As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, subCommandBalanceScript).DataCellEx.DataCellAnnotation

			
'brapi.ErrorLog.LogMessage(si,$"commandEntity {commandEntity}")		

			Select Case wfCMDLevel	
			Case "CMD"
			If isSelf 
				If commandBalanceStatus = "Y" Then					
					Return "E#" & commandEntity & "_General:Name( )"
				Else					
					Return "E#" & commandEntity & "_General:U8#ReadOnlyAnnotation:Name( )"
				End If
				
			Else
				Dim returnEntityList As String = "E#" & wfCube & ".Descendants.Where(HasChildren = True).Where(Text3 Contains EntityLevel=L3)"
				Dim entityList As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si, "E_" & wfCube, returnEntityList, True)
				Dim returnScript As String = ""
				For Each entityMember In entityList
'					Dim balanceScript As String = "E#" & entityMember.Member.Name & ":C#Local:S#" & wfScenario &":T#" & wfTime & "M12:V#YTD:A#Ctrl_Target_Transfer_Variance:F#Baseline:O#BeforeAdj:I#None:U1#Top:U2#Top:U3#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#None"
'					Dim balanceAmt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si,wfCube,balanceScript).DataCellEx.DataCell.CellAmount
					Dim balanceStatusScript As String = "E#" & entityMember.Member.Name & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim balanceStatus As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, balanceStatusScript).DataCellEx.DataCellAnnotation
					Dim annotationScript As String = "E#" & entityMember.Member.name & "_General:C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim annotation As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, "ARMY", annotationScript).DataCellEx.DataCellAnnotation
					
					If Not String.IsNullOrWhiteSpace(returnScript) Then returnScript &= ","
					
					If balanceStatus = "Y" Or annotation = "Yes" Then
						returnScript &= "E#" & entityMember.Member.Name & "_General"
					Else
						returnScript &= "E#" & entityMember.Member.Name & "_General" & ":U8#ReadOnlyAnnotation"
					End If
'BRApi.ErrorLog.LogMessage(si,$"entity = {entityMember.Member.Name} || balanceStatus = {balanceStatus} || returnScript = {returnScript}")					
				Next
				'Return nothing
				If returnScript = "" Then returnScript = "E#" & wfCube & ".Descendants.Where(Name Contains _General).Where(Text3 Contains EntityLevel=L10)"
				Return returnScript				
			End If
				
			Case "SubCMD"			
				If isSelf			
					If String.IsNullOrWhiteSpace(sEntity) Then Return "E#None"
					Dim lockScript As String = "E#" & sEntity & "_General:C#USD:S#" & wfScenario & ":T#" & wfTime & "M12:V#YTD:A#TGT_Target_Distribution_Complete_Ind:F#None:O#Forms:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
					Dim lockAmt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si,wfCube,lockScript).DataCellEx.DataCell.CellAmount
'BRApi.ErrorLog.LogMessage(si,$"sEntity = {sEntity} || subCommandBalanceStatus = {subCommandBalanceStatus}")				
					If subCommandBalanceStatus = "Y" And lockAmt <> 1 Then
						Return "E#" & sEntity & ":Name( )"
					Else
						Return "E#" & sEntity & ":U8#ReadOnlyAnnotation:Name( )"
					End If
					
				Else 					
					If String.IsNullOrWhiteSpace(sEntity) Then Return "E#None"
					Dim returnEntityList As String = "E#" & sEntity & ".Descendants.Where(HasChildren = True).Where(Text3 Contains EntityLevel=L4)"
					Dim entityList As List(Of MemberInfo) = BRApi.Finance.Metadata.GetMembersUsingFilter(si, "E_" & wfCube, returnEntityList, True)
					Dim returnScript As String = ""
					For Each entityMember In entityList
	'					Dim balanceScript As String = "E#" & entityMember.Member.Name & ":C#Local:S#" & wfScenario &":T#" & wfTime & "M12:V#YTD:A#Ctrl_Target_Transfer_Variance:F#Baseline:O#BeforeAdj:I#None:U1#Top:U2#Top:U3#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#None"
	'					Dim balanceAmt As Decimal = BRApi.Finance.Data.GetDataCellUsingMemberScript(si,wfCube,balanceScript).DataCellEx.DataCell.CellAmount
						Dim balanceStatusScript As String = "E#" & entityMember.Member.Name & ":C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Balanced_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
						Dim balanceStatus As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, wfCube, balanceStatusScript).DataCellEx.DataCellAnnotation
						
						Dim annotationScript As String = "E#" & entityMember.Member.name & ":C#Local:S#" & wfScenario & ":T#" & wfTime & "M12:V#Annotation:A#TGT_Target_Distribution_Complete_Ind:F#None:O#BeforeAdj:I#None:U1#None:U2#None:U3#None:U4#None:U5#None:U6#None:U7#None:U8#None"
						Dim annotation As String = BRApi.Finance.Data.GetDataCellUsingMemberScript(si, "ARMY", annotationScript).DataCellEx.DataCellAnnotation
						
						If returnScript <> "" Then returnScript &= ","
						If balanceStatus = "Y" Or annotation = "Yes" Then
							returnScript &= "E#" & entityMember.Member.Name
						Else
							returnScript &= "E#" & entityMember.Member.Name & ":U8#ReadOnlyAnnotation"
						End If
					Next
					'Return nothing
					If returnScript = "" Then returnScript = "E#" & sEntity & ".Descendants.Where(Name Contains _General).Where(Text3 Contains EntityLevel=L10)"
					Return returnScript
				End If
				
			End Select
			Return Nothing
		End Function
#End Region

#Region "DisplayWFComponentsCMDDST: Display Complete or Revert WF Steps Components"
	Public Function DisplayWFComponentsCMDDST(ByVal si As SessionInfo, ByVal globals As BRGlobals, ByVal api As Object, ByVal args As DashboardStringFunctionArgs) As String
		Dim curProfile As WorkflowProfileInfo = BRApi.Workflow.Metadata.GetProfile(si, si.WorkflowClusterPk.ProfileKey)
		Dim sWFProfile As String = curProfile.Name
		If  sWFProfile.Contains("CMD") Then		
			Return "True"
'brapi.ErrorLog.LogMessage(si, "True")
		Else
			Return "False"
		End If
	End Function
#End Region

		Public Function GetTGTReviewDist() As String
			
		End Function
		
		Public Function ReturnEntityList() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function
		
		
		Public Function ReturnModifyFlow() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function
		
		Public Function ReturnModifyOrigin() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function
		
		Public Function ReturnModifyRows() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function
		
		Public Function ReturnEntCtrlAcct() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function
		
		Public Function ReturnEntDistAcct() As String
			Dim sEntity As String = args.NameValuePairs.XFGetValue("Entity","")
			Dim sType As String = args.NameValuePairs.XFGetValue("Type","")
			Dim sReturnValue As String = String.Empty
				
			'Return nothing if no enity is selected from the Funds Center cbx
			If String.IsNullOrEmpty(sEntity)
				sReturnValue = $"E#None"
				Return sReturnValue
			Else	
				Dim mbr As Member = BRApi.Finance.Members.GetMember(si, dimType.Entity.Id, sEntity)
				Dim MbrName = BRApi.Finance.Entity.Text(si, Mbr.MemberId, 1, SharedConstants.Unknown, SharedConstants.Unknown)

				If sType.XFEqualsIgnoreCase("CMD_Member") Then
					Return $"E#{MbrName}:O#AdjInput"
				Else If sType.XFEqualsIgnoreCase("CMD_Member_Children") Then
					Return $"E#{MbrName}.Children:O#AdjInput"
				End If
					
					
'			End Select						
			
			Return sReturnValue				
			End If
			
		End Function

#Region "Constants"
	Public BRName = "TGT_String_Helper" 
#End Region
	End Class
End Namespace
]]></sourceCode>
                                        </file>
                                    </folder>
                                </files>
                            </workspaceAssembly>
                        </workspaceAssemblies>
                        <cubeViewGroups>
                            <cubeViewGroup name="CMD TGT FDX CVs" description="" accessGroup="Everyone" maintenanceGroup="Everyone">
                                <cubeViewItems>
                                    <cubeViewItem name="CMD_TGT_FDX_ModifyDist_CV" description="" isVisibleInProfiles="true" isShortcut="false" shortcutCubeViewName="" isDynamic="false">
                                        <cubeView>
                                            <pageCaption />
                                            <canModifyData>false</canModifyData>
                                            <canCalculate>false</canCalculate>
                                            <canTranslate>false</canTranslate>
                                            <canConsolidate>false</canConsolidate>
                                            <canModifySuppression>false</canModifySuppression>
                                            <includeCellAttachmentStatus>false</includeCellAttachmentStatus>
                                            <useDetailedLogging>false</useDetailedLogging>
                                            <headerFormat />
                                            <cellFormat />
                                            <allowSparseRowSuppression>false</allowSparseRowSuppression>
                                            <maxNumUnsuppressedRowsPerCubeViewPage>-1</maxNumUnsuppressedRowsPerCubeViewPage>
                                            <maxNumSecondsToProcessCubeView>-1</maxNumSecondsToProcessCubeView>
                                            <formula><![CDATA[]]></formula>
                                            <reportTaskType>NoTask</reportTaskType>
                                            <reportBRName />
                                            <reportPaperKind>Unknown</reportPaperKind>
                                            <reportIsLandscape>false</reportIsLandscape>
                                            <reportMarginLeft>-1</reportMarginLeft>
                                            <reportMarginTop>-1</reportMarginTop>
                                            <reportMarginRight>-1</reportMarginRight>
                                            <reportMarginBottom>-1</reportMarginBottom>
                                            <reportAutoFitNumPagesWide>0</reportAutoFitNumPagesWide>
                                            <reportScaleFactor>1</reportScaleFactor>
                                            <reportAutoFitToPageWidth>true</reportAutoFitToPageWidth>
                                            <excelExportDisplayGridlines>true</excelExportDisplayGridlines>
                                            <reportTitle />
                                            <reportHeaderLeftLabel1 />
                                            <reportHeaderLeftLabel2 />
                                            <reportHeaderLeftLabel3 />
                                            <reportHeaderLeftLabel4 />
                                            <reportHeaderCenterLabel1 />
                                            <reportHeaderCenterLabel2 />
                                            <reportHeaderCenterLabel3 />
                                            <reportHeaderCenterLabel4 />
                                            <reportHeaderRightLabel1 />
                                            <reportHeaderRightLabel2 />
                                            <reportHeaderRightLabel3 />
                                            <reportHeaderRightLabel4 />
                                            <reportFooter />
                                            <reportFooterLeftLabel1 />
                                            <reportFooterLeftLabel2 />
                                            <reportFooterLeftLabel3 />
                                            <reportFooterLeftLabel4 />
                                            <reportFooterCenterLabel1 />
                                            <reportFooterCenterLabel2 />
                                            <reportFooterCenterLabel3 />
                                            <reportFooterCenterLabel4 />
                                            <reportFooterRightLabel1 />
                                            <reportFooterRightLabel2 />
                                            <reportFooterRightLabel3 />
                                            <reportFooterRightLabel4 />
                                            <rowSharingType>NotUsed</rowSharingType>
                                            <cubeViewNameForSharingAllRows />
                                            <cubeViewNameForSharingAllRows2 />
                                            <colSharingType>NotUsed</colSharingType>
                                            <cubeViewNameForSharingAllCols />
                                            <cubeViewNameForSharingAllCols2 />
                                            <cube>
                                                <name>|WFCube|</name>
                                            </cube>
                                            <povMembers>
                                                <entity>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </entity>
                                                <parent>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </parent>
                                                <consolidation>
                                                    <name>Local</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </consolidation>
                                                <scenario>
                                                    <name>|!FDXScenario!|</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </scenario>
                                                <time>
                                                    <name>WF</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </time>
                                                <view>
                                                    <name>Periodic</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </view>
                                                <account>
                                                    <name>TGT_Dist</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </account>
                                                <flow>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </flow>
                                                <origin>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </origin>
                                                <ic>
                                                    <name>None</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ic>
                                                <ud1>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud1>
                                                <ud2>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud2>
                                                <ud3>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud3>
                                                <ud4>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud4>
                                                <ud5>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud5>
                                                <ud6>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud6>
                                                <ud7>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud7>
                                                <ud8>
                                                    <name>None</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud8>
                                            </povMembers>
                                            <useDefaultColumnHeaders>true</useDefaultColumnHeaders>
                                            <columnHeaders />
                                            <useDefaultRowHeaders>false</useDefaultRowHeaders>
                                            <rowHeaders>
                                                <rowHeader>
                                                    <dimType>UD1</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD3</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD2</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD4</dimType>
                                                </rowHeader>
                                            </rowHeaders>
                                            <reportColumnIndexForRowHeaders>-1</reportColumnIndexForRowHeaders>
                                            <reportColumnHeader1Height>-1</reportColumnHeader1Height>
                                            <reportColumnHeader2Height>-1</reportColumnHeader2Height>
                                            <reportColumnHeader3Height>-1</reportColumnHeader3Height>
                                            <reportColumnHeader4Height>-1</reportColumnHeader4Height>
                                            <reportColumnHeader5Height>-1</reportColumnHeader5Height>
                                            <reportColumnHeader6Height>-1</reportColumnHeader6Height>
                                            <rowHeader1Width>-1</rowHeader1Width>
                                            <excelRowHeader1Width>-1</excelRowHeader1Width>
                                            <reportRowHeader1Width>-1</reportRowHeader1Width>
                                            <rowHeader2Width>-1</rowHeader2Width>
                                            <excelRowHeader2Width>-1</excelRowHeader2Width>
                                            <reportRowHeader2Width>-1</reportRowHeader2Width>
                                            <rowHeader3Width>-1</rowHeader3Width>
                                            <excelRowHeader3Width>-1</excelRowHeader3Width>
                                            <reportRowHeader3Width>-1</reportRowHeader3Width>
                                            <rowHeader4Width>-1</rowHeader4Width>
                                            <excelRowHeader4Width>-1</excelRowHeader4Width>
                                            <reportRowHeader4Width>-1</reportRowHeader4Width>
                                            <rowHeader5Width>-1</rowHeader5Width>
                                            <excelRowHeader5Width>-1</excelRowHeader5Width>
                                            <reportRowHeader5Width>-1</reportRowHeader5Width>
                                            <rowHeader6Width>-1</rowHeader6Width>
                                            <excelRowHeader6Width>-1</excelRowHeader6Width>
                                            <reportRowHeader6Width>-1</reportRowHeader6Width>
                                            <culture />
                                            <headerTextTypes entity="2000" parent="2000" consolidation="2000" scenario="2000" time="2000" view="2000" account="2000" flow="2000" origin="2000" ic="2000" ud1="2000" ud2="2000" ud3="2000" ud4="2000" ud5="2000" ud6="2000" ud7="2000" ud8="2000" />
                                            <linkedCubeViewNames />
                                            <linkedDashboardNames />
                                            <includeDefaultNavLinkBoundParameterNames>false</includeDefaultNavLinkBoundParameterNames>
                                            <boundParameterNames cube="" entity="" parent="" consolidation="" scenario="" time="" view="" account="" flow="" origin="" ic="" ud1="" ud2="" ud3="" ud4="" ud5="" ud6="" ud7="" ud8="" />
                                            <columns>
                                                <column name="Col_Time" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Time</primaryDimType>
                                                            <memberFilter>T#|CVTime|</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                            </columns>
                                            <rows>
                                                <row name="D_Key5" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>UD3</primaryDimType>
                                                            <memberFilter>XFBR(Workspace.Current.CMD_TGT_Assembly.CMD_TGT_DataBuffers,GetFDXModify_DistWH, Entity=[|!FDXEntity!|],
RowType=TGT_Dist,
scenario= [|CVScenario|],
time = [|CVTime|])</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>true</suppressZeroRows>
                                                    <suppressNoDataRows>true</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides />
                                                </row>
                                            </rows>
                                        </cubeView>
                                    </cubeViewItem>
                                    <cubeViewItem name="CMD_TGT_FDX_ModifyWH_CV" description="" isVisibleInProfiles="true" isShortcut="false" shortcutCubeViewName="" isDynamic="false">
                                        <cubeView>
                                            <pageCaption />
                                            <canModifyData>false</canModifyData>
                                            <canCalculate>false</canCalculate>
                                            <canTranslate>false</canTranslate>
                                            <canConsolidate>false</canConsolidate>
                                            <canModifySuppression>false</canModifySuppression>
                                            <includeCellAttachmentStatus>false</includeCellAttachmentStatus>
                                            <useDetailedLogging>false</useDetailedLogging>
                                            <headerFormat />
                                            <cellFormat />
                                            <allowSparseRowSuppression>false</allowSparseRowSuppression>
                                            <maxNumUnsuppressedRowsPerCubeViewPage>-1</maxNumUnsuppressedRowsPerCubeViewPage>
                                            <maxNumSecondsToProcessCubeView>-1</maxNumSecondsToProcessCubeView>
                                            <formula><![CDATA[]]></formula>
                                            <reportTaskType>NoTask</reportTaskType>
                                            <reportBRName />
                                            <reportPaperKind>Unknown</reportPaperKind>
                                            <reportIsLandscape>false</reportIsLandscape>
                                            <reportMarginLeft>-1</reportMarginLeft>
                                            <reportMarginTop>-1</reportMarginTop>
                                            <reportMarginRight>-1</reportMarginRight>
                                            <reportMarginBottom>-1</reportMarginBottom>
                                            <reportAutoFitNumPagesWide>0</reportAutoFitNumPagesWide>
                                            <reportScaleFactor>1</reportScaleFactor>
                                            <reportAutoFitToPageWidth>true</reportAutoFitToPageWidth>
                                            <excelExportDisplayGridlines>true</excelExportDisplayGridlines>
                                            <reportTitle />
                                            <reportHeaderLeftLabel1 />
                                            <reportHeaderLeftLabel2 />
                                            <reportHeaderLeftLabel3 />
                                            <reportHeaderLeftLabel4 />
                                            <reportHeaderCenterLabel1 />
                                            <reportHeaderCenterLabel2 />
                                            <reportHeaderCenterLabel3 />
                                            <reportHeaderCenterLabel4 />
                                            <reportHeaderRightLabel1 />
                                            <reportHeaderRightLabel2 />
                                            <reportHeaderRightLabel3 />
                                            <reportHeaderRightLabel4 />
                                            <reportFooter />
                                            <reportFooterLeftLabel1 />
                                            <reportFooterLeftLabel2 />
                                            <reportFooterLeftLabel3 />
                                            <reportFooterLeftLabel4 />
                                            <reportFooterCenterLabel1 />
                                            <reportFooterCenterLabel2 />
                                            <reportFooterCenterLabel3 />
                                            <reportFooterCenterLabel4 />
                                            <reportFooterRightLabel1 />
                                            <reportFooterRightLabel2 />
                                            <reportFooterRightLabel3 />
                                            <reportFooterRightLabel4 />
                                            <rowSharingType>NotUsed</rowSharingType>
                                            <cubeViewNameForSharingAllRows />
                                            <cubeViewNameForSharingAllRows2 />
                                            <colSharingType>NotUsed</colSharingType>
                                            <cubeViewNameForSharingAllCols />
                                            <cubeViewNameForSharingAllCols2 />
                                            <cube>
                                                <name>|WFCube|</name>
                                            </cube>
                                            <povMembers>
                                                <entity>
                                                    <name>|!FDXEntity!|</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </entity>
                                                <parent>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </parent>
                                                <consolidation>
                                                    <name>Local</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </consolidation>
                                                <scenario>
                                                    <name>|!FDXScenario!|</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </scenario>
                                                <time>
                                                    <name>WF</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </time>
                                                <view>
                                                    <name>Periodic</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </view>
                                                <account>
                                                    <name>TGT_WH</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </account>
                                                <flow>
                                                    <name>XFBR(Workspace.Current.CMD_TGT_Assembly.CMD_TGT_String_Helper,ReturnModifyFlow,Entity=|CVEntity|)</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </flow>
                                                <origin>
                                                    <name>XFBR(Workspace.Current.CMD_TGT_Assembly.CMD_TGT_String_Helper,ReturnModifyOrigin,Entity=|CVEntity|)</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </origin>
                                                <ic>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ic>
                                                <ud1>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud1>
                                                <ud2>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud2>
                                                <ud3>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud3>
                                                <ud4>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud4>
                                                <ud5>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud5>
                                                <ud6>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud6>
                                                <ud7>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud7>
                                                <ud8>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud8>
                                            </povMembers>
                                            <useDefaultColumnHeaders>true</useDefaultColumnHeaders>
                                            <columnHeaders />
                                            <useDefaultRowHeaders>false</useDefaultRowHeaders>
                                            <rowHeaders>
                                                <rowHeader>
                                                    <dimType>UD1</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD3</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD2</dimType>
                                                </rowHeader>
                                                <rowHeader>
                                                    <dimType>UD4</dimType>
                                                </rowHeader>
                                            </rowHeaders>
                                            <reportColumnIndexForRowHeaders>-1</reportColumnIndexForRowHeaders>
                                            <reportColumnHeader1Height>-1</reportColumnHeader1Height>
                                            <reportColumnHeader2Height>-1</reportColumnHeader2Height>
                                            <reportColumnHeader3Height>-1</reportColumnHeader3Height>
                                            <reportColumnHeader4Height>-1</reportColumnHeader4Height>
                                            <reportColumnHeader5Height>-1</reportColumnHeader5Height>
                                            <reportColumnHeader6Height>-1</reportColumnHeader6Height>
                                            <rowHeader1Width>-1</rowHeader1Width>
                                            <excelRowHeader1Width>-1</excelRowHeader1Width>
                                            <reportRowHeader1Width>-1</reportRowHeader1Width>
                                            <rowHeader2Width>-1</rowHeader2Width>
                                            <excelRowHeader2Width>-1</excelRowHeader2Width>
                                            <reportRowHeader2Width>-1</reportRowHeader2Width>
                                            <rowHeader3Width>-1</rowHeader3Width>
                                            <excelRowHeader3Width>-1</excelRowHeader3Width>
                                            <reportRowHeader3Width>-1</reportRowHeader3Width>
                                            <rowHeader4Width>-1</rowHeader4Width>
                                            <excelRowHeader4Width>-1</excelRowHeader4Width>
                                            <reportRowHeader4Width>-1</reportRowHeader4Width>
                                            <rowHeader5Width>-1</rowHeader5Width>
                                            <excelRowHeader5Width>-1</excelRowHeader5Width>
                                            <reportRowHeader5Width>-1</reportRowHeader5Width>
                                            <rowHeader6Width>-1</rowHeader6Width>
                                            <excelRowHeader6Width>-1</excelRowHeader6Width>
                                            <reportRowHeader6Width>-1</reportRowHeader6Width>
                                            <culture />
                                            <headerTextTypes entity="2000" parent="2000" consolidation="2000" scenario="2000" time="2000" view="2000" account="2000" flow="2000" origin="2000" ic="2000" ud1="2000" ud2="2000" ud3="2000" ud4="2000" ud5="2000" ud6="2000" ud7="2000" ud8="2000" />
                                            <linkedCubeViewNames />
                                            <linkedDashboardNames />
                                            <includeDefaultNavLinkBoundParameterNames>false</includeDefaultNavLinkBoundParameterNames>
                                            <boundParameterNames cube="" entity="" parent="" consolidation="" scenario="" time="" view="" account="" flow="" origin="" ic="" ud1="" ud2="" ud3="" ud4="" ud5="" ud6="" ud7="" ud8="" />
                                            <columns>
                                                <column name="Col_Time" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Time</primaryDimType>
                                                            <memberFilter>T#|CVTime|</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                            </columns>
                                            <rows>
                                                <row name="d_Key5" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>UD3</primaryDimType>
                                                            <memberFilter>XFBR(Workspace.GBL.GBL_Assembly.GBL_String_Helper,GetFDXFilteredRows, cmd=[|CVEntity|],
scen= [|CVScenario|],
time = [|CVTime|],
appn =[|!ML_CMD_PGM_FormulateAPPN!|])</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>true</suppressZeroRows>
                                                    <suppressNoDataRows>true</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides />
                                                </row>
                                            </rows>
                                        </cubeView>
                                    </cubeViewItem>
                                    <cubeViewItem name="CMD_TGT_FDX_ValidateDist_CV" description="" isVisibleInProfiles="true" isShortcut="false" shortcutCubeViewName="" isDynamic="false">
                                        <cubeView>
                                            <pageCaption>|WFYear| Review Control Target In vs Out</pageCaption>
                                            <canModifyData>true</canModifyData>
                                            <canCalculate>false</canCalculate>
                                            <canTranslate>false</canTranslate>
                                            <canConsolidate>false</canConsolidate>
                                            <canModifySuppression>false</canModifySuppression>
                                            <includeCellAttachmentStatus>false</includeCellAttachmentStatus>
                                            <useDetailedLogging>false</useDetailedLogging>
                                            <headerFormat>RowExpansionMode = ExpandAll, ShowDimensionImages = False,
If (RowName StartsWith 'D_') Then
Else If (RowName StartsWith '') Then
Else If (RowName StartsWith '') Then
Else If (RowName StartsWith 'BlankRow_') Then
Else If (RowName = 'Header') Then
</headerFormat>
                                            <cellFormat>NumberFormat = [#,###,0]</cellFormat>
                                            <allowSparseRowSuppression>true</allowSparseRowSuppression>
                                            <maxNumUnsuppressedRowsPerCubeViewPage>-1</maxNumUnsuppressedRowsPerCubeViewPage>
                                            <maxNumSecondsToProcessCubeView>-1</maxNumSecondsToProcessCubeView>
                                            <formula><![CDATA[]]></formula>
                                            <reportTaskType>NoTask</reportTaskType>
                                            <reportBRName />
                                            <reportPaperKind>Unknown</reportPaperKind>
                                            <reportIsLandscape>false</reportIsLandscape>
                                            <reportMarginLeft>-1</reportMarginLeft>
                                            <reportMarginTop>-1</reportMarginTop>
                                            <reportMarginRight>-1</reportMarginRight>
                                            <reportMarginBottom>-1</reportMarginBottom>
                                            <reportAutoFitNumPagesWide>0</reportAutoFitNumPagesWide>
                                            <reportScaleFactor>1</reportScaleFactor>
                                            <reportAutoFitToPageWidth>true</reportAutoFitToPageWidth>
                                            <excelExportDisplayGridlines>true</excelExportDisplayGridlines>
                                            <reportTitle />
                                            <reportHeaderLeftLabel1 />
                                            <reportHeaderLeftLabel2 />
                                            <reportHeaderLeftLabel3 />
                                            <reportHeaderLeftLabel4 />
                                            <reportHeaderCenterLabel1>|!CubeViewCUIHeader!|</reportHeaderCenterLabel1>
                                            <reportHeaderCenterLabel2 />
                                            <reportHeaderCenterLabel3 />
                                            <reportHeaderCenterLabel4 />
                                            <reportHeaderRightLabel1 />
                                            <reportHeaderRightLabel2 />
                                            <reportHeaderRightLabel3 />
                                            <reportHeaderRightLabel4 />
                                            <reportFooter />
                                            <reportFooterLeftLabel1 />
                                            <reportFooterLeftLabel2 />
                                            <reportFooterLeftLabel3 />
                                            <reportFooterLeftLabel4 />
                                            <reportFooterCenterLabel1 />
                                            <reportFooterCenterLabel2 />
                                            <reportFooterCenterLabel3 />
                                            <reportFooterCenterLabel4 />
                                            <reportFooterRightLabel1 />
                                            <reportFooterRightLabel2 />
                                            <reportFooterRightLabel3 />
                                            <reportFooterRightLabel4 />
                                            <rowSharingType>NotUsed</rowSharingType>
                                            <cubeViewNameForSharingAllRows />
                                            <cubeViewNameForSharingAllRows2 />
                                            <colSharingType>NotUsed</colSharingType>
                                            <cubeViewNameForSharingAllCols />
                                            <cubeViewNameForSharingAllCols2 />
                                            <cube>
                                                <name>|WFCube|</name>
                                            </cube>
                                            <povMembers>
                                                <entity>
                                                    <name>|WFCube|</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </entity>
                                                <parent>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </parent>
                                                <consolidation>
                                                    <name>Local</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </consolidation>
                                                <scenario>
                                                    <name>|WFScenario|</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </scenario>
                                                <time>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </time>
                                                <view>
                                                    <name>Periodic</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </view>
                                                <account>
                                                    <name />
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </account>
                                                <flow>
                                                    <name>Baseline</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </flow>
                                                <origin>
                                                    <name>BeforeAdj</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </origin>
                                                <ic>
                                                    <name>None</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ic>
                                                <ud1>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud1>
                                                <ud2>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud2>
                                                <ud3>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud3>
                                                <ud4>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud4>
                                                <ud5>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud5>
                                                <ud6>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud6>
                                                <ud7>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud7>
                                                <ud8>
                                                    <name>Top</name>
                                                    <memberFilter />
                                                    <topLevelFilterForNextLevelExp />
                                                </ud8>
                                            </povMembers>
                                            <useDefaultColumnHeaders>true</useDefaultColumnHeaders>
                                            <columnHeaders />
                                            <useDefaultRowHeaders>false</useDefaultRowHeaders>
                                            <rowHeaders>
                                                <rowHeader>
                                                    <dimType>Entity</dimType>
                                                </rowHeader>
                                            </rowHeaders>
                                            <reportColumnIndexForRowHeaders>-1</reportColumnIndexForRowHeaders>
                                            <reportColumnHeader1Height>-1</reportColumnHeader1Height>
                                            <reportColumnHeader2Height>-1</reportColumnHeader2Height>
                                            <reportColumnHeader3Height>-1</reportColumnHeader3Height>
                                            <reportColumnHeader4Height>-1</reportColumnHeader4Height>
                                            <reportColumnHeader5Height>-1</reportColumnHeader5Height>
                                            <reportColumnHeader6Height>-1</reportColumnHeader6Height>
                                            <rowHeader1Width>-1</rowHeader1Width>
                                            <excelRowHeader1Width>-1</excelRowHeader1Width>
                                            <reportRowHeader1Width>-1</reportRowHeader1Width>
                                            <rowHeader2Width>-1</rowHeader2Width>
                                            <excelRowHeader2Width>-1</excelRowHeader2Width>
                                            <reportRowHeader2Width>-1</reportRowHeader2Width>
                                            <rowHeader3Width>-1</rowHeader3Width>
                                            <excelRowHeader3Width>-1</excelRowHeader3Width>
                                            <reportRowHeader3Width>-1</reportRowHeader3Width>
                                            <rowHeader4Width>-1</rowHeader4Width>
                                            <excelRowHeader4Width>-1</excelRowHeader4Width>
                                            <reportRowHeader4Width>-1</reportRowHeader4Width>
                                            <rowHeader5Width>-1</rowHeader5Width>
                                            <excelRowHeader5Width>-1</excelRowHeader5Width>
                                            <reportRowHeader5Width>-1</reportRowHeader5Width>
                                            <rowHeader6Width>-1</rowHeader6Width>
                                            <excelRowHeader6Width>-1</excelRowHeader6Width>
                                            <reportRowHeader6Width>-1</reportRowHeader6Width>
                                            <culture />
                                            <headerTextTypes entity="1000" parent="1000" consolidation="1000" scenario="2000" time="1000" view="1000" account="2000" flow="1000" origin="1000" ic="1000" ud1="1000" ud2="1000" ud3="1000" ud4="1000" ud5="1000" ud6="1000" ud7="1000" ud8="1000" />
                                            <linkedCubeViewNames />
                                            <linkedDashboardNames />
                                            <includeDefaultNavLinkBoundParameterNames>false</includeDefaultNavLinkBoundParameterNames>
                                            <boundParameterNames cube="" entity="" parent="" consolidation="" scenario="" time="" view="" account="" flow="" origin="" ic="" ud1="" ud2="" ud3="" ud4="" ud5="" ud6="" ud7="" ud8="" />
                                            <columns>
                                                <column name="Variance" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(Ctrl_Target_In) - CVC(Total_Out) ):Name(Ctrl vs Target)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides>
                                                        <rowOverride>
                                                            <rowsOrCols range="Control, EntityGeneral, ProfileEntityChildren" />
                                                            <memberFilter>E#None</memberFilter>
                                                            <cellFormat>    BackgroundColor = XFLightBlue2, TextColor = XFLightBlue2</cellFormat>
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </rowOverride>
                                                    </rowOverrides>
                                                </column>
                                                <column name="Ctrl_Target_In" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(Ctrl_Target_CY) + CVC(Ctrl_Target_NY)):Name(Ctrl_Target_In)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides>
                                                        <rowOverride>
                                                            <rowsOrCols range="Total" />
                                                            <memberFilter>GetDataCell(CVRC(Control, 1, Ctrl_Target_In, 1))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </rowOverride>
                                                    </rowOverrides>
                                                </column>
                                                <column name="Ctrl_Target_CY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat> IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Ctrl_Target_In:T#|WFYear|:Name(ControlCY)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides>
                                                        <rowOverride>
                                                            <rowsOrCols range="Total" />
                                                            <memberFilter>GetDataCell(CVRC(Control, 1, Ctrl_Target_In, 1))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </rowOverride>
                                                    </rowOverrides>
                                                </column>
                                                <column name="Ctrl_Target_NY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat> IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Ctrl_Target_In:T#|WFYearNext|:Name(ControlNY)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides>
                                                        <rowOverride>
                                                            <rowsOrCols range="Total" />
                                                            <memberFilter>GetDataCell(CVRC(Control, 1, Ctrl_Target_In, 1))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </rowOverride>
                                                    </rowOverrides>
                                                </column>
                                                <column name="Ctrl_Target_Out" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = False</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Ctrl_Target_Out:Name(Total Target Acct)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="Total_Out" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(General_Target_Total) + CVC(TargetTotal) + CVC(WithholdTotal)):Name(Total Target + WH)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="General_Target_Total" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(General_TargetCY) + CVC(General_TargetNY)):Name(Undistributed Target)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="General_TargetNY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat> IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Distr_Target_General:T#|WFYearNext|M12</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="General_TargetCY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Distr_Target_General:T#|WFYear|</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="TargetTotal" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(TargetCY) + CVC(TargetNY)):Name(Target)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="TargetNY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Distr_Target:Name(Distributed Target):T#|WFYearNext|M12</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="TargetCY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Distr_Target:Name(Distributed Target):T#|WFYear|</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="WithholdTotal" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat />
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>GetDataCell(CVC(WithholdCY) + CVC(WithholdNY)):Name(Withhold)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="WithholdCY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Phased_Obligation_Withhold:Name(Withhold):T#|WFYear|</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                                <column name="WithholdNY" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewColNameForSharing="">
                                                    <width>-1</width>
                                                    <reportWidth>-1</reportWidth>
                                                    <canModifyData>true</canModifyData>
                                                    <colHeaderFormat>    IsColumnVisible = CVMathOnly</colHeaderFormat>
                                                    <cellFormat />
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Account</primaryDimType>
                                                            <memberFilter>A#Phased_Obligation_Withhold:Name(Withhold):T#|WFYearNext|M12</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroCols>false</suppressZeroCols>
                                                    <suppressNoDataCols>false</suppressNoDataCols>
                                                    <suppressInvalidCols>false</suppressInvalidCols>
                                                    <useSuppressionSettingsOnParentCols>true</useSuppressionSettingsOnParentCols>
                                                    <zeroSuppressionThreshold />
                                                    <useToDetermineRowSuppression>true</useToDetermineRowSuppression>
                                                    <allowSparseRowSuppression>TrueValue</allowSparseRowSuppression>
                                                    <rowOverrides />
                                                </column>
                                            </columns>
                                            <rows>
                                                <row name="Header" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat>    |!CubeViewCellStyleWholeNumber!|, BackgroundColor = XFLightBlue2</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>E#FundCenter:Name(Funds Center):U1#FundCode:U2#MDEP:U3#SAG_APE</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>false</suppressZeroRows>
                                                    <suppressNoDataRows>false</suppressNoDataRows>
                                                    <suppressInvalidRows>false</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides />
                                                </row>
                                                <row name="Control" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat>    BackgroundColor = Honeydew

</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>E#Root.CustomMemberList(
BRName=General_Member_Lists,
MemberListName=GetFilteredDataRows,
CacheName=TGT_Validate_Ctrl_In_vs_Out,
DimDef=E#,
DataBufferPOVScript=[Cb#|WFCube|:S#|WFScenario|:T#|WFTime|:C#Local:V#Periodic:I#None:F#Baseline:O#BeforeAdj:U1#Top:U2#Top:U3#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#Top],
Entity=|!BL_CMD_TGT_FundsCenter!|,
Account=[Ctrl_Target_In,Ctrl_Target_Out]

):Name(Fund Control)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>false</suppressZeroRows>
                                                    <suppressNoDataRows>false</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides>
                                                        <colOverride>
                                                            <rowsOrCols range="Ctrl_Target_Out, Total_Out, TargetTotal, TargetNY, TargetCY, WithholdTotal, WithholdCY, WithholdNY, General_Target_Total, General_TargetNY, General_TargetCY" />
                                                            <memberFilter>E#None</memberFilter>
                                                            <cellFormat>BackgroundColor = XFLightBlue2</cellFormat>
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Variance" />
                                                            <memberFilter>GetDataCell(CVC(TargetTotal) - CVC(TargetTotal))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                    </colOverrides>
                                                </row>
                                                <row name="EntityGeneral" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat>    BackgroundColor = Honeydew  
</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>E#Root.CustomMemberList(
BRName=General_Member_Lists,
MemberListName=GetFilteredDataRows,
CacheName=TGT_Validate_Ctrl_In_vs_Out,
DimDef=E#,
DataBufferPOVScript=[Cb#|WFCube|:S#|WFScenario|:C#Local:V#Periodic:I#None:F#Baseline:O#BeforeAdj:U1#Top:U2#Top:U3#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#None],
Entity=|!BL_CMD_TGT_FundsCenter!|,
Time=[T#|WFYear|,T#|WFYearNext|M12],
Account=[Ctrl_Target_In,Ctrl_Target_Out]
)
</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>false</suppressZeroRows>
                                                    <suppressNoDataRows>false</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides>
                                                        <colOverride>
                                                            <rowsOrCols range="Ctrl_Target_In, Ctrl_Target_CY, Ctrl_Target_NY, General_Target_Total, General_TargetCY, General_TargetNY, TargetTotal, TargetCY, TargetNY" />
                                                            <memberFilter>E#None</memberFilter>
                                                            <cellFormat>BackgroundColor = XFLightBlue2</cellFormat>
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Ctrl_Target_Out" />
                                                            <memberFilter>GetDataCell(CVC(WithholdTotal))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                    </colOverrides>
                                                </row>
                                                <row name="Row1" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat>    BackgroundColor = Gainsboro, Bold = True, FontSize = 1, IsRowVisible = True, TextColor = Gainsboro</rowHeaderFormat>
                                                    <cellFormat>    BackgroundColor = Gainsboro, Bold = True, FontSize = 1, TextColor = Gainsboro</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>E#None</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>false</suppressZeroRows>
                                                    <suppressNoDataRows>false</suppressNoDataRows>
                                                    <suppressInvalidRows>false</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides />
                                                </row>
                                                <row name="ProfileEntityChildren" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat />
                                                    <cellFormat>    BackgroundColor = Honeydew

If (CellAmount=0) Then

	TextColor = Honeydew

End If</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>E#Root.CustomMemberList(
BRName=General_Member_Lists,
MemberListName=GetFilteredDataRows,
CacheName=TGT_Validate_Ctrl_In_vs_Out,
DimDef=E#,
DataBufferPOVScript=[Cb#|WFCube|:S#|WFScenario|:C#Local:V#Periodic:I#None:F#Baseline:O#BeforeAdj:U1#Top:Y2#Top:U3#Top:U4#Top:U5#Top:U6#Top:U7#Top:U8#None],
Entity=[{E#Root.CustomMemberList(BRName=General_Member_Lists, MemberListName=GetProfileEntityInputMbrsUsingParam,
Entity=|!BL_CMD_TGT_FundsCenter!|)}],
Time=[T#|WFYear|,T#|WFYearNext|M12],
Account=[Ctrl_Target_In,Ctrl_Target_Out]

)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>true</suppressZeroRows>
                                                    <suppressNoDataRows>true</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides>
                                                        <colOverride>
                                                            <rowsOrCols range="Ctrl_Target_In, Ctrl_Target_CY, Ctrl_Target_NY, WithholdTotal, WithholdNY, WithholdCY" />
                                                            <memberFilter>E#None</memberFilter>
                                                            <cellFormat>BackgroundColor = XFLightBlue2</cellFormat>
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Ctrl_Target_Out" />
                                                            <memberFilter>GetDataCell(CVC(General_Target_Total) + CVC(TargetTotal))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Variance" />
                                                            <memberFilter />
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                    </colOverrides>
                                                </row>
                                                <row name="TotalProfileEntityChildren" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat>    BackgroundColor = Gainsboro, Bold = True, FontSize = 1, IsRowVisible = True, TextColor = Gainsboro</rowHeaderFormat>
                                                    <cellFormat>    BackgroundColor = Gainsboro, Bold = True, FontSize = 1, TextColor = Gainsboro</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>GetDataCell(BR#[BRName=General_Member_Lists, FunctionName=GetFilteredRowsTotal, CacheName=TGT_Validate_Ctrl_In_vs_Out]):Name(Total ProfileEntityChildren)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>false</suppressZeroRows>
                                                    <suppressNoDataRows>false</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides>
                                                        <colOverride>
                                                            <rowsOrCols range="Variance" />
                                                            <memberFilter>GetDataCell(CVC(Ctrl_Target_In) - CVC(Total_Out))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="WithholdTotal" />
                                                            <memberFilter>GetDataCell(0)</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Total_Out" />
                                                            <memberFilter>GetDataCell(CVRC(Current, 1, General_Target_Total, 1) + CVRC(Current, 1, TargetTotal, 1))
</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                    </colOverrides>
                                                </row>
                                                <row name="Total" shareSettingsFromAnotherCubeView="false" cubeViewNameForSharing="" cubeViewRowNameForSharing="">
                                                    <reportRowHeight>-1</reportRowHeight>
                                                    <canModifyData>true</canModifyData>
                                                    <rowHeaderFormat>|!Var_Total_Row_Format!|</rowHeaderFormat>
                                                    <cellFormat>    BackgroundColor = Honeydew, Bold = True

If (ColName = 'Variance') Then
	If (CellAmount &lt;&gt; 0) Then
	TextColor = Red
	Else
	TextColor = Green
	End If
End If
</cellFormat>
                                                    <cellType>Unknown</cellType>
                                                    <listParameter />
                                                    <enableNavigationLink>false</enableNavigationLink>
                                                    <linkedNavigationItem />
                                                    <linkedCubeViewNames />
                                                    <linkedDashboardNames />
                                                    <memberExpansions>
                                                        <memberExpansion>
                                                            <primaryDimType>Entity</primaryDimType>
                                                            <memberFilter>GetDataCell(CVR(EntityGeneral) + CVR(TotalProfileEntityChildren)):Name(Total)</memberFilter>
                                                            <initialIndentLevel>0</initialIndentLevel>
                                                        </memberExpansion>
                                                    </memberExpansions>
                                                    <suppressZeroRows>true</suppressZeroRows>
                                                    <suppressNoDataRows>true</suppressNoDataRows>
                                                    <suppressInvalidRows>true</suppressInvalidRows>
                                                    <insertSuppressedMemberType>Unknown</insertSuppressedMemberType>
                                                    <useSuppressionSettingsOnParentRows>true</useSuppressionSettingsOnParentRows>
                                                    <zeroSuppressionThreshold />
                                                    <colOverrides>
                                                        <colOverride>
                                                            <rowsOrCols range="Variance" />
                                                            <memberFilter>GetDataCell(CVRC(Control, 1, Ctrl_Target_In, 1) - CVRC(Current, 1, Total_Out, 1))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="TargetTotal" />
                                                            <memberFilter>GetDataCell(CVC(TargetNY)+CVC(TargetCY))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="General_Target_Total" />
                                                            <memberFilter>GetDataCell(CVC(General_TargetNY)+CVC(General_TargetCY))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                        <colOverride>
                                                            <rowsOrCols range="Total_Out" />
                                                            <memberFilter>GetDataCell(CVC(General_Target_Total)+CVC(TargetTotal)+CVC(WithholdTotal))</memberFilter>
                                                            <cellFormat />
                                                            <cellType>Unknown</cellType>
                                                            <listParameter />
                                                        </colOverride>
                                                    </colOverrides>
                                                </row>
                                            </rows>
                                        </cubeView>
                                    </cubeViewItem>
                                </cubeViewItems>
                            </cubeViewGroup>
                        </cubeViewGroups>
                        <dataManagementGroups />
                    </maintenanceUnit>
                </maintenanceUnits>
            </workspace>
        </workspaces>
    </applicationWorkspacesRoot>
</OneStreamXF>